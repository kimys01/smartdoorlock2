<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone Project</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            /* display, justify-content, align-items removed to allow normal flow */
            height: 100vh;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            padding-top: 70px; /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
            /* overflow: hidden; /* ë¡œê·¸ì¸ í›„ ìŠ¤í¬ë¡¤ í•„ìš” */
            transition: background-color 0.3s ease; /* [ì¶”ê°€] ë°°ê²½ìƒ‰ ë³€ê²½ ì‹œ ë¶€ë“œëŸ½ê²Œ */
        }

        .hidden { display: none !important; }

        /* --- í—¤ë” ìŠ¤íƒ€ì¼ --- */
        header {
            position: fixed; /* [ìˆ˜ì •] fixedë¡œ ë³€ê²½í•˜ì—¬ ìƒë‹¨ ê³ ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 70px; /* [ìˆ˜ì •] ë†’ì´ ëª…ì‹œ */
            background: #fff;
            padding: 20px 40px; /* [ìˆ˜ì •] íŒ¨ë”© ì¡°ì • */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            z-index: 1000; /* [ì¶”ê°€] ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— ì˜¤ë„ë¡ */
        }

        header .logo {
            font-size: 1.8em; /* [ìˆ˜ì •] í¬ê¸° ì¡°ì • */
            color: #333;
            font-weight: 600;
            text-decoration: none;
        }

        header nav ul {
            display: flex;
            list-style: none;
        }

        header nav ul li {
            margin-left: 30px; /* [ìˆ˜ì •] ê°„ê²© ì¡°ì • */
        }

        header nav ul li a,
        header nav ul li button { /* [ì¶”ê°€] ë²„íŠ¼ì—ë„ ìŠ¤íƒ€ì¼ ì ìš© */
            text-decoration: none;
            color: #555;
            font-size: 1.1em; /* [ìˆ˜ì •] í¬ê¸° ì¡°ì • */
            font-weight: 500;
            padding: 8px 15px; /* [ìˆ˜ì •] íŒ¨ë”© ì¡°ì • */
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
            border: none; /* [ì¶”ê°€] ë²„íŠ¼ ê¸°ë³¸ í…Œë‘ë¦¬ ì œê±° */
            background: none; /* [ì¶”ê°€] ë²„íŠ¼ ê¸°ë³¸ ë°°ê²½ ì œê±° */
            cursor: pointer; /* [ì¶”ê°€] ë²„íŠ¼ ì»¤ì„œ ë³€ê²½ */
        }

        header nav ul li a:hover,
        header nav ul li button:hover,
        header nav ul li a.active { /* [ì¶”ê°€] active ìŠ¤íƒ€ì¼ */
            background-color: #8e44ad;
            color: #fff;
        }

        /* --- ì»¨í…Œì´ë„ˆ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) --- */
        .container {
            max-width: 700px;
            width: 100%;
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 5px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.15);
            /* margin-top: 100px; [ì‚­ì œ] body padding-topìœ¼ë¡œ ëŒ€ì²´ */
            margin: 20px auto 0; /* [ì¶”ê°€] ìë™ ì¤‘ì•™ ì •ë ¬ ë° ìƒë‹¨ ì—¬ë°± */
            transition: all 0.3s ease; /* [ì¶”ê°€] ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
        }

        /* --- í˜ì´ì§€ ì „í™˜ íš¨ê³¼ --- */
        .page {
            /* display: none; */ /* JSë¡œ ì œì–´ (hidden í´ë˜ìŠ¤) */
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }
        
        /* body.page-transition .page {
             opacity: 0;
        } */

        .container.fade-out {
            opacity: 0;
            transform: translateY(-20px);
        }
        
        .container.fade-in {
            opacity: 1;
            transform: translateY(0);
        }


        .container .title {
            font-size: 25px;
            font-weight: 500;
            position: relative;
            margin-bottom: 20px; /* [ì¶”ê°€] í•˜ë‹¨ ì—¬ë°± */
        }

        .container .title::before {
            content: "";
            position: absolute;
            left: 0;
            bottom: -5px; /* [ìˆ˜ì •] ìœ„ì¹˜ ì¡°ì • */
            height: 3px;
            width: 30px;
            border-radius: 5px;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
        }

        /* --- ê³µí†µ í¼ ìŠ¤íƒ€ì¼ --- */
        .form-content .input-box {
            margin-bottom: 15px;
            width: 100%; /* [ìˆ˜ì •] ë„ˆë¹„ 100% */
        }

        .form-content .input-box span.details {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-content .input-box input {
            height: 45px;
            width: 100%;
            outline: none;
            font-size: 16px;
            border-radius: 5px;
            padding-left: 15px;
            border: 1px solid #ccc;
            border-bottom-width: 2px;
            transition: all 0.3s ease;
        }

        .form-content .input-box input:focus,
        .form-content .input-box input:valid {
            border-color: #9b59b6;
        }

        /* --- ì„±ë³„ ì…ë ¥ (íšŒì›ê°€ì…) --- */
        .form-content .gender-details {
            margin-bottom: 15px;
        }
        .form-content .gender-details .gender-title {
            font-size: 18px; /* [ìˆ˜ì •] í¬ê¸° ì¡°ì • */
            font-weight: 500;
             margin-bottom: 8px; /* [ì¶”ê°€] */
        }
        .form-content .gender-details .category {
            display: flex;
            width: 100%;
            justify-content: space-between;
        }
        .gender-details .category label {
            display: flex;
            align-items: center;
            cursor: pointer;
            width: calc(100% / 3 - 10px); /* [ìˆ˜ì •] 3ê°œ í•­ëª© */
            padding: 10px; /* [ì¶”ê°€] í´ë¦­ ì˜ì—­ í™•ë³´ */
            border: 1px solid #ccc; /* [ì¶”ê°€] */
            border-radius: 5px; /* [ì¶”ê°€] */
            transition: all 0.2s ease; /* [ì¶”ê°€] */
        }

        .gender-details .category label:hover {
             background: #f0f0f0; /* [ì¶”ê°€] */
        }

        .gender-details .category label .dot {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            margin-right: 10px;
            background: #d9d9d9;
            border: 5px solid transparent;
            transition: all 0.3s ease;
        }
        input[type="radio"] {
            display: none;
        }
        #dot-1:checked ~ .category label.male .dot,
        #dot-2:checked ~ .category label.female .dot,
        #dot-3:checked ~ .category label.other .dot {
            background: #9b59b6;
            border-color: #d9d9d9;
        }

        /* [ì¶”ê°€] ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬ ì‹œ ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        #dot-1:checked ~ .category label.male,
        #dot-2:checked ~ .category label.female,
        #dot-3:checked ~ .category label.other {
            border-color: #9b59b6;
            background: #f3e5f7;
        }


        /* --- ë²„íŠ¼ --- */
        .button {
            height: 45px;
            margin: 20px 0; /* [ìˆ˜ì •] ìƒí•˜ ì—¬ë°± */
        }

        .button input, .button button { /* [ì¶”ê°€] button ì—ë„ ìŠ¤íƒ€ì¼ ì ìš© */
            height: 100%;
            width: 100%;
            border-radius: 5px;
            border: none;
            color: #fff;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
        }

        .button input:hover, .button button:hover {
            background: linear-gradient(-135deg, #71b7e6, #9b59b6);
        }

        /* --- í•˜ë‹¨ ë§í¬ (ë¡œê·¸ì¸/íšŒì›ê°€ì…) --- */
        .bottom-text {
            text-align: center;
            margin-top: 15px; /* [ì¶”ê°€] */
        }

        .bottom-text a {
            color: #9b59b6;
            text-decoration: none;
            font-weight: 500;
        }

        .bottom-text a:hover {
            text-decoration: underline;
        }

        /* --- ë©”ì‹œì§€ ë°•ìŠ¤ (ì•Œë¦¼ì°½) --- */
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            text-align: center;
            border-top: 5px solid #9b59b6;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .message-box.show {
            opacity: 1;
            visibility: visible;
        }

        .message-box p {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
        }

        .message-box button {
            padding: 10px 20px;
            background: #9b59b6;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        .message-box button:hover {
            background: #71b7e6;
        }
        
        /* [ì¶”ê°€] ë©”ì‹œì§€ ì˜¤ë²„ë ˆì´ */
        .message-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 1999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .message-overlay.show {
            opacity: 1;
            visibility: visible;
        }


        /* --- í™˜ì˜ í˜ì´ì§€ --- */
        #welcomePage {
            /* [ìˆ˜ì •] ìŠ¤íƒ€ì¼ì„ containerì™€ ìœ ì‚¬í•˜ê²Œ ë§ì¶¤ */
            max-width: 900px; /* [ìˆ˜ì •] ì¢€ ë” ë„“ê²Œ */
            width: 100%;
            background-color: #fff;
            padding: 30px 40px; /* [ìˆ˜ì •] íŒ¨ë”© ì¦ê°€ */
            border-radius: 8px; /* [ìˆ˜ì •] */
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            margin: 20px auto 0;
            text-align: center;
            opacity: 0; /* [ì¶”ê°€] í˜ì´ë“œì¸ íš¨ê³¼ */
            transform: translateY(20px); /* [ì¶”ê°€] í˜ì´ë“œì¸ íš¨ê³¼ */
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #welcomePage.show {
            opacity: 1;
            transform: translateY(0);
        }

        #welcomePage h2 {
            font-size: 2.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        #welcomePage #welcomeMessage {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 30px;
        }
        
        /* --- [ì¶”ê°€] ê¸°ëŠ¥ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ --- */
        .features-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* ë°˜ì‘í˜• ê·¸ë¦¬ë“œ */
            gap: 20px;
            margin-top: 20px;
        }

        /* --- [ì¶”ê°€] ê¸°ëŠ¥ ë²„íŠ¼ ìŠ¤íƒ€ì¼ --- */
        .feature-button {
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            border: none;
            border-radius: 10px;
            padding: 25px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ë°°ì¹˜ */
            min-height: 150px; /* ìµœì†Œ ë†’ì´ */
        }

        .feature-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
            background: linear-gradient(135deg, #e0e0e0, #d0d0d0);
        }
        
        .feature-button .icon {
             font-size: 2.5em; /* ì•„ì´ì½˜ í¬ê¸° */
             margin-bottom: 15px;
             color: #9b59b6; /* ì•„ì´ì½˜ ìƒ‰ìƒ */
        }

        .feature-button h3 {
            font-size: 1.4em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .feature-button p {
            font-size: 0.95em;
            color: #666;
            line-height: 1.4;
        }


        /* --- ì§€ë„ í˜ì´ì§€ --- */
        #mapPage {
            max-width: 1200px; /* [ìˆ˜ì •] ë” ë„“ê²Œ */
            width: 100%;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            margin: 20px auto 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #mapPage.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- [ì¶”ê°€] ì§€ë„ ì»¨íŠ¸ë¡¤ ë°” --- */
        .map-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: #f9f9f9;
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #eee;
        }
        
        .map-controls h2 {
            font-size: 1.5em;
            color: #333;
        }
        
        .map-controls .control-buttons button {
             padding: 8px 15px;
             font-size: 0.9em;
             font-weight: 500;
             border: none;
             border-radius: 5px;
             cursor: pointer;
             transition: background-color 0.3s ease;
             margin-left: 10px;
             background-color: #eee;
             color: #555;
        }
        
        .map-controls .control-buttons button:hover {
            background-color: #ddd;
        }
        
        .map-controls .control-buttons button.primary {
             background-color: #9b59b6;
             color: #fff;
        }
        
        .map-controls .control-buttons button.primary:hover {
            background-color: #8e44ad;
        }


        /* --- [ìˆ˜ì •] ì§€ë„ ì»¨í…Œì´ë„ˆ --- */
        #mapContainer {
            width: 100%;
            height: 60vh; /* [ìˆ˜ì •] ë†’ì´ ì¡°ì • (ë·°í¬íŠ¸ ê¸°ì¤€) */
            min-height: 400px; /* [ì¶”ê°€] ìµœì†Œ ë†’ì´ */
            background-color: #eee;
            border-radius: 0 0 8px 8px; /* [ìˆ˜ì •] ì»¨íŠ¸ë¡¤ ë°”ì™€ ì—°ê²° */
            overflow: hidden; /* [ì¶”ê°€] */
            position: relative; /* [ì¶”ê°€] ë¡œë”© ì˜¤ë²„ë ˆì´ìš© */
        }
        
        /* [ì¶”ê°€] ì§€ë„ ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #mapLoadingOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: #555;
            z-index: 10;
        }

        /* [ì¶”ê°€] ì¹´ì¹´ì˜¤ë§µ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ (ì •ë³´ì°½) */
        .info-window {
            padding: 10px 15px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9em;
            position: relative;
            bottom: 35px; /* ë§ˆì»¤ ìœ„ì— ìœ„ì¹˜í•˜ë„ë¡ */
            left: -50%; /* ê°€ìš´ë° ì •ë ¬ */
            transform: translateX(10%); /* [ìˆ˜ì •] ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ */
        }
        
        .info-window .title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .info-window .address {
            color: #666;
            margin-bottom: 8px;
        }
        
        .info-window .close-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
            font-size: 1.2em;
            color: #888;
            font-weight: bold;
        }
        .info-window .close-btn:hover {
            color: #333;
        }


        /* --- ë¡œê·¸ í˜ì´ì§€ --- */
        #logPage {
            max-width: 900px;
            width: 100%;
            background-color: #fff;
            padding: 30px 40px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            margin: 20px auto 0;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        #logPage.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- [ì¶”ê°€] ë¡œê·¸ ì»¨íŠ¸ë¡¤ ë°” --- */
        .log-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .log-controls h2 {
            font-size: 1.8em;
            color: #333;
        }
        
        .log-controls button {
            padding: 10px 18px;
            font-size: 0.95em;
            font-weight: 500;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            background-color: #eee;
            color: #555;
        }

        .log-controls button:hover {
            background-color: #ddd;
        }

        /* --- [ì¶”ê°€] ë¡œê·¸ ì»¨í…Œì´ë„ˆ --- */
        #logContainer {
            width: 100%;
            height: 60vh; /* [ìˆ˜ì •] ë†’ì´ ì¡°ì • */
            min-height: 400px; /* [ì¶”ê°€] ìµœì†Œ ë†’ì´ */
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
            padding: 20px;
            overflow-y: auto; /* [ì¶”ê°€] ìŠ¤í¬ë¡¤ */
            font-family: 'Courier New', Courier, monospace; /* [ì¶”ê°€] ë¡œê·¸ ê°€ë…ì„± */
            color: #333;
        }

        /* [ì¶”ê°€] ê°œë³„ ë¡œê·¸ í•­ëª© */
        .log-entry {
            padding: 8px 10px;
            border-bottom: 1px dashed #eee;
            font-size: 0.95em;
            line-height: 1.5;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry strong {
            color: #8e44ad; /* ì‹œê°„ ê°•ì¡° */
            margin-right: 10px;
        }
        
        /* [ì¶”ê°€] ë¡œê·¸ ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ */
        #logMessage {
            color: #888;
            font-style: italic;
            text-align: center;
            padding-top: 50px;
        }


        /* --- ë°˜ì‘í˜• ë””ìì¸ --- */
        @media(max-width: 700px) {
            body {
                 padding-top: 60px; /* í—¤ë” ë†’ì´ ê°ì†Œ */
            }
             header {
                height: 60px;
                padding: 15px 20px;
            }
             header .logo {
                font-size: 1.5em;
            }
            header nav {
                 /* [ì¶”ê°€] ëª¨ë°”ì¼ ë©”ë‰´ (ë‚˜ì¤‘ì„ ìœ„í•´) - ì§€ê¸ˆì€ ê°„ë‹¨íˆ */
                 position: absolute;
                 top: 60px;
                 left: 0;
                 width: 100%;
                 background: #fff;
                 /* display: none; */ /* JSë¡œ ì œì–´ í•„ìš” */
                 box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            }
             header nav ul {
                 flex-direction: column;
                 width: 100%;
            }
             header nav ul li {
                 margin: 0;
                 width: 100%;
            }
             header nav ul li a,
             header nav ul li button {
                 display: block; /* [ì¶”ê°€] */
                 width: 100%;
                 text-align: left;
                 padding: 15px 20px; /* [ìˆ˜ì •] */
                 border-radius: 0;
                 border-bottom: 1px solid #f0f0f0;
            }

            .container {
                max-width: 100%;
                padding: 20px;
                 margin: 10px; /* [ìˆ˜ì •] */
                 width: auto; /* [ì¶”ê°€] */
            }
            
            #welcomePage, #mapPage, #logPage {
                padding: 20px;
                margin: 10px;
                width: auto;
            }

            .form-content .gender-details .category {
                flex-direction: column;
            }
            .gender-details .category label {
                 width: 100%;
                 margin-bottom: 10px; /* [ì¶”ê°€] */
            }
            
            .features-container {
                grid-template-columns: 1fr; /* ëª¨ë°”ì¼ì—ì„œ 1ì—´ë¡œ */
            }
            
            .map-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .map-controls .control-buttons {
                width: 100%;
                display: flex;
                gap: 10px;
            }
            .map-controls .control-buttons button {
                flex-grow: 1; /* ë²„íŠ¼ ê½‰ ì°¨ê²Œ */
                margin-left: 0;
            }
            
            .log-controls {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 10px;
            }
            .log-controls button {
                width: 100%;
            }
        }

    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">SafeHome</a>
        <nav>
            <ul id="navList">
                </ul>
        </nav>
    </header>

    <div class="container page" id="loginPage">
        <div class="title">Login</div>
        <div class="form-content">
            <form id="loginForm">
                <div class="input-box">
                    <span class="details">Email</span>
                    <input type="email" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="input-box">
                    <span class="details">Password</span>
                    <input type="password" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <div class="button">
                    <input type="submit" value="Login">
                </div>
                <div class="bottom-text">
                    Don't have an account? <a href="#" id="showRegister">Register</a>
                </div>
            </form>
        </div>
    </div>

    <div class="container page hidden" id="registerPage">
        <div class="title">Registration</div>
        <div class="form-content">
            <form id="registerForm">
                <div class="input-box">
                        <span class="details">Full Name</span>
                        <input type="text" id="registerName" placeholder="Enter your name" required>
                    </div>
                    <div class="input-box">
                        <span class="details">Username</span>
                        <input type="text" id="registerUsername" placeholder="Enter your username" required>
                    </div>
                    <div class="input-box">
                        <span class="details">Email</span>
                        <input type="email" id="registerEmail" placeholder="Enter your email" required>
                    </div>
                    <div class="input-box">
                        <span class="details">Phone Number</span>
                        <input type="text" id="registerPhone" placeholder="Enter your number" required>
                    </div>
                    <div class="input-box">
                        <span class="details">Password</span>
                        <input type="password" id="registerPassword" placeholder="Enter your password" required>
                    </div>
                    <div class="input-box">
                        <span class="details">Confirm Password</span>
                        <input type="password" id="registerConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                <div class="gender-details">
                    <input type="radio" name="gender" id="dot-1" value="male">
                    <input type="radio" name="gender" id="dot-2" value="female">
                    <input type="radio" name="gender" id="dot-3" value="other">
                    <span class="gender-title">Gender</span>
                    <div class="category">
                        <label for="dot-1" class="male">
                            <span class="dot one"></span>
                            <span class="gender">Male</span>
                        </label>
                        <label for="dot-2" class="female">
                            <span class="dot two"></span>
                            <span class="gender">Female</span>
                        </label>
                        <label for="dot-3" class="other">
                            <span class="dot three"></span>
                            <span class="gender">Prefer not to say</span>
                        </label>
                    </div>
                </div>
                <div class="button">
                    <input type="submit" value="Register">
                </div>
                <div class="bottom-text">
                    Already have an account? <a href="#" id="showLogin">Login</a>
                </div>
            </form>
        </div>
    </div>

    <div class="page hidden" id="welcomePage"> <h2>Welcome!</h2>
        <p id="welcomeMessage">What would you like to do today?</p>
        
        <div class="features-container">
            <button class="feature-button" id="goToMapBtn">
                <div class="icon">ğŸ—ºï¸</div> <div>
                    <h3>View Map</h3>
                    <p>Check the location of your devices.</p>
                </div>
            </button>
            <button class="feature-button" id="viewLogsBtn">
                <div class="icon">ğŸ›¡ï¸</div>
                <div>
                    <h3>Security Logs</h3>
                    <p>Review door lock and access history.</p>
                </div>
            </button>
             <button class="feature-button" id="manageDevicesBtn">
                <div class="icon">ğŸ“±</div>
                <div>
                    <h3>Manage Devices</h3>
                    <p>Add, remove, or configure your devices.</p>
                </div>
            </button>
            </div>
    </div>

    <div class="page hidden" id="mapPage"> <div class="map-controls">
             <h2>Device Location Map</h2>
             <div class="control-buttons">
                 <button id="backToWelcomeBtn">Back to Welcome</button>
                 <button id="refreshMapBtn" class="primary">Refresh Location</button>
             </div>
        </div>
        <div id="mapContainer">
            <div id="mapLoadingOverlay">Loading Map...</div>
        </div>
    </div>

    <div class="page hidden" id="logPage"> <div class="log-controls">
             <h2>Security Logs</h2>
             <button id="backToWelcomeBtnLog">Back to Welcome</button>
         </div>
         <div id="logContainer">
             <div id="logMessage">Loading logs...</div>
             </div>
    </div>


    <div class="message-overlay" id="messageOverlay"></div>
    <div class="message-box" id="messageBox">
        <p id="messageText"></p>
        <button id="messageCloseBtn">Close</button>
    </div>


    <script type="module">
        // Firebase SDK v11.6.1
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged, 
            signOut,
            signInAnonymously,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc,
            collection,
            onSnapshot, // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ
            query,
            getDocs, // [ì¶”ê°€] 1íšŒì„± ë¡œê·¸ ë¡œë“œìš©
            orderBy, // [ì¶”ê°€] ë¡œê·¸ ì •ë ¬ìš©
            limit // [ì¶”ê°€] ë¡œê·¸ ê°œìˆ˜ ì œí•œìš©
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";


        // --- [í•„ìˆ˜] Firebase ì„¤ì • ---
        // ì´ ë³€ìˆ˜ë“¤ì€ ì™¸ë¶€(Canvas) í™˜ê²½ì—ì„œ ì œê³µë©ë‹ˆë‹¤.
        // const firebaseConfig = JSON.parse(__firebase_config);
        // const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- [í…ŒìŠ¤íŠ¸ìš©] ì„ì‹œ ì„¤ì • (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ìœ„ ì½”ë“œë¥¼ ì‚¬ìš©) ---
         const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY", // í…ŒìŠ¤íŠ¸ ì‹œ ì—¬ê¸°ì— í‚¤ ì…ë ¥
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // --- [í…ŒìŠ¤íŠ¸ìš©] ì„ì‹œ ì„¤ì • ë ---


        // --- Firebase ì„œë¹„ìŠ¤ ì´ˆê¸°í™” ---
        let app, auth, db;
        let currentUserId = null;
        let currentUserData = null; // ì‚¬ìš©ì ë°ì´í„° ì €ì¥
        
        // ì§€ë„ ê´€ë ¨ ë³€ìˆ˜
        let kakaoMap = null;
        let mapMarker = null;
        let infoWindow = null;
        
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ìœ„ì¹˜)
        let locationUnsubscribe = null;
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ë¡œê·¸)
        let logsUnsubscribe = null;


        // --- DOM ìš”ì†Œ ---
        // í˜ì´ì§€
        const loginPage = document.getElementById('loginPage');
        const registerPage = document.getElementById('registerPage');
        const welcomePage = document.getElementById('welcomePage');
        const mapPage = document.getElementById('mapPage');
        const logPage = document.getElementById('logPage');
        const pages = document.querySelectorAll('.page');

        // ë„¤ë¹„ê²Œì´ì…˜
        const navList = document.getElementById('navList');

        // í¼
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        // í¼ ì…ë ¥ (íšŒì›ê°€ì…)
        const registerName = document.getElementById('registerName');
        const registerUsername = document.getElementById('registerUsername');
        const registerEmail = document.getElementById('registerEmail');
        const registerPhone = document.getElementById('registerPhone');
        const registerPassword = document.getElementById('registerPassword');
        const registerConfirmPassword = document.getElementById('registerConfirmPassword');
        
        // í¼ ì…ë ¥ (ë¡œê·¸ì¸)
        const loginEmail = document.getElementById('loginEmail');
        const loginPassword = document.getElementById('loginPassword');

        // í˜ì´ì§€ ë§í¬
        const showRegister = document.getElementById('showRegister');
        const showLogin = document.getElementById('showLogin');

        // í™˜ì˜ í˜ì´ì§€
        const welcomeMessage = document.getElementById('welcomeMessage');
        const goToMapBtn = document.getElementById('goToMapBtn');
        const viewLogsBtn = document.getElementById('viewLogsBtn');

        // ì§€ë„ í˜ì´ì§€
        const mapContainer = document.getElementById('mapContainer');
        const mapLoadingOverlay = document.getElementById('mapLoadingOverlay');
        const backToWelcomeBtn = document.getElementById('backToWelcomeBtn');
        const refreshMapBtn = document.getElementById('refreshMapBtn');

        // ë¡œê·¸ í˜ì´ì§€
        const logContainer = document.getElementById('logContainer');
        const logMessage = document.getElementById('logMessage');
        const backToWelcomeBtnLog = document.getElementById('backToWelcomeBtnLog');

        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€
        const messageOverlay = document.getElementById('messageOverlay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const messageCloseBtn = document.getElementById('messageCloseBtn');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        /**
         * ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½ í‘œì‹œ
         * @param {string} message - í‘œì‹œí•  ë©”ì‹œì§€
         */
        function showMessage(message) {
            messageText.textContent = message;
            messageOverlay.classList.add('show');
            messageBox.classList.add('show');
        }

        /**
         * ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½ ë‹«ê¸°
         */
        function closeMessage() {
            messageOverlay.classList.remove('show');
            messageBox.classList.remove('show');
        }

        /**
         * íŠ¹ì • í˜ì´ì§€ë§Œ í‘œì‹œí•˜ê³  ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹€
         * @param {string} pageId - í‘œì‹œí•  í˜ì´ì§€ì˜ ID
         */
        function showPage(pageId) {
            console.log(`Showing page: ${pageId}`);
            pages.forEach(page => {
                if (page.id === pageId) {
                    page.classList.remove('hidden');
                    // í˜ì´ë“œì¸ íš¨ê³¼ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ 'show' í´ë˜ìŠ¤ ì¶”ê°€
                    setTimeout(() => page.classList.add('show'), 10);
                } else {
                    page.classList.add('hidden');
                    page.classList.remove('show');
                }
            });
            
             // í˜ì´ì§€ ì „í™˜ ì‹œ body ë°°ê²½ìƒ‰ ë³€ê²½ (ë¡œê·¸ì¸/íšŒì›ê°€ì… í˜ì´ì§€ë§Œ ê·¸ë¼ë°ì´ì…˜)
            if (pageId === 'loginPage' || pageId === 'registerPage') {
                document.body.style.background = 'linear-gradient(135deg, #71b7e6, #9b59b6)';
            } else {
                document.body.style.background = '#f0f2f5'; // ë¡œê·¸ì¸ í›„ ë°°ê²½ìƒ‰
            }
        }
        
        /**
         * ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ ì—…ë°ì´íŠ¸
         * @param {boolean} isLoggedIn - ë¡œê·¸ì¸ ìƒíƒœ
         * @param {object|null} userData - ì‚¬ìš©ì ë°ì´í„° (ì´ë¦„ ë“±)
         */
         function updateNavigation(isLoggedIn, userData = null) {
            navList.innerHTML = ''; // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            
            if (isLoggedIn && userData) {
                // ë¡œê·¸ì¸ ìƒíƒœ
                const usernameLi = document.createElement('li');
                usernameLi.innerHTML = `<span style="padding: 8px 15px; color: #333; font-weight: 500;">Welcome, ${userData.name}!</span>`;
                
                const logoutLi = document.createElement('li');
                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'navLogout';
                logoutBtn.textContent = 'Logout';
                logoutBtn.addEventListener('click', handleLogout);
                logoutLi.appendChild(logoutBtn);

                navList.appendChild(usernameLi);
                navList.appendChild(logoutLi);
                
            } else {
                // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
                const loginLi = document.createElement('li');
                const loginLink = document.createElement('a');
                loginLink.href = '#';
                loginLink.id = 'navLogin';
                loginLink.textContent = 'Login';
                loginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('loginPage');
                    // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° (ë‚˜ì¤‘ì— êµ¬í˜„)
                });
                loginLi.appendChild(loginLink);

                const registerLi = document.createElement('li');
                const registerLink = document.createElement('a');
                registerLink.href = '#';
                registerLink.id = 'navRegister';
                registerLink.textContent = 'Register';
                registerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showPage('registerPage');
                    // ëª¨ë°”ì¼ì—ì„œ ë©”ë‰´ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° (ë‚˜ì¤‘ì— êµ¬í˜„)
                });
                registerLi.appendChild(registerLink);

                navList.appendChild(loginLi);
                navList.appendChild(registerLi);
            }
        }

        // --- Firebase í•¸ë“¤ëŸ¬ ---

        /**
         * íšŒì›ê°€ì… ì²˜ë¦¬
         */
        async function handleRegister(e) {
            e.preventDefault();
            
            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            if (registerPassword.value !== registerConfirmPassword.value) {
                showMessage("Passwords do not match.");
                return;
            }
            
            // ì„±ë³„ ê°’ ê°€ì ¸ì˜¤ê¸°
            const genderInput = document.querySelector('input[name="gender"]:checked');
            if (!genderInput) {
                showMessage("Please select a gender.");
                return;
            }
            const gender = genderInput.value;

            try {
                // 1. Firebase Authì— ì‚¬ìš©ì ìƒì„±
                const userCredential = await createUserWithEmailAndPassword(auth, registerEmail.value, registerPassword.value);
                const user = userCredential.user;
                console.log("User created in Auth:", user.uid);

                // 2. Firestoreì— ì‚¬ìš©ì ì¶”ê°€ ì •ë³´ ì €ì¥
                const userData = {
                    name: registerName.value,
                    username: registerUsername.value,
                    email: registerEmail.value,
                    phone: registerPhone.value,
                    gender: gender
                };
                
                // ì‚¬ìš©ì ê°œì¸ ì»¬ë ‰ì…˜ ê²½ë¡œ
                const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/profile`, "info");
                
                await setDoc(userDocRef, userData);
                console.log("User data saved to Firestore");

                // [FIX 3]
                showMessage("Registration successful! Logging you in..."); // [ìˆ˜ì •] ë©”ì‹œì§€ ë³€ê²½
                // showPage('loginPage'); // [ìˆ˜ì •] ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™ ì œê±° (onAuthStateChangedê°€ ì²˜ë¦¬)
                registerForm.reset(); // í¼ ì´ˆê¸°í™”

            } catch (error) {
                console.error("Registration error:", error);
                showMessage(`Registration failed: ${error.message}`);
            }
        }

        /**
         * ë¡œê·¸ì¸ ì²˜ë¦¬
         */
        async function handleLogin(e) {
            e.preventDefault();
            try {
                const userCredential = await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
                const user = userCredential.user;
                console.log("User logged in:", user.uid);
                
                // ë¡œê·¸ì¸ì´ ì„±ê³µí•˜ë©´ onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë˜ì–´
                // loadUserDataAndShowWelcome()ì´ í˜¸ì¶œë¨
                // showPage('welcomePage'); // ì—¬ê¸°ì„œ ì§ì ‘ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
                loginForm.reset();

            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Login failed: ${error.message}`);
            }
        }

        /**
         * ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
         */
        async function handleLogout() {
            try {
                await signOut(auth);
                console.log("User logged out");
                
                // ë¦¬ìŠ¤ë„ˆ í•´ì œ
                if (locationUnsubscribe) {
                    locationUnsubscribe();
                    locationUnsubscribe = null;
                    console.log("Location listener detached");
                }
                if (logsUnsubscribe) {
                    logsUnsubscribe();
                    logsUnsubscribe = null;
                    console.log("Logs listener detached");
                }
                
                // ì§€ë„ ì •ë¦¬
                if (kakaoMap) {
                    // ì§€ë„ ê°ì²´ ì œê±° (í•„ìš”ì‹œ)
                    kakaoMap = null;
                    mapContainer.innerHTML = '<div id="mapLoadingOverlay">Loading Map...</div>'; // ì§€ë„ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
                }
                
                currentUserId = null;
                currentUserData = null;
                
                // onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë˜ì–´
                // updateNavigation(false) ë° showPage('loginPage')ê°€ í˜¸ì¶œë¨
                
            } catch (error) {
                console.error("Logout error:", error);
                showMessage(`Logout failed: ${error.message}`);
            }
        }
        
        /**
         * [í•µì‹¬] ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ë° í™˜ì˜ í˜ì´ì§€ í‘œì‹œ
         * (onAuthStateChangedì—ì„œ í˜¸ì¶œë¨)
         * @param {string} uid - ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ UID
         */
        async function loadUserDataAndShowWelcome(uid) {
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/profile`, "info");
                
                // [FIX 3]
                let docSnap = await getDoc(userDocRef); // [ìˆ˜ì •] const -> let

                // [FIX 3] íšŒì›ê°€ì… ì‹œ ë°œìƒí•˜ëŠ” ê²½ìŸ ìƒíƒœ(race condition) í•´ê²°ì„ ìœ„í•œ ì¬ì‹œë„ ë¡œì§
                let retries = 5; // 5ì´ˆê°„ ì¬ì‹œë„
                while (!docSnap.exists() && retries > 0) {
                    console.warn(`User data not found for ${uid}, retrying in 1s... (${retries})`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1ì´ˆ ëŒ€ê¸°
                    docSnap = await getDoc(userDocRef); // ë°ì´í„° ë‹¤ì‹œ ì‹œë„
                    retries--;
                }
                // [FIX 3] ë

                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    currentUserId = uid; // [ì¤‘ìš”] currentUserId ì„¤ì •
                    
                    console.log("User data loaded:", currentUserData);
                    
                    // í™˜ì˜ ë©”ì‹œì§€ ì„¤ì •
                    welcomeMessage.textContent = `Welcome, ${currentUserData.name}! What would you like to do today?`;
                    
                    // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
                    updateNavigation(true, currentUserData);
                    
                    // í™˜ì˜ í˜ì´ì§€ í‘œì‹œ
                    showPage('welcomePage');
                    
                    // [ì¤‘ìš”] ë¡œê·¸ì¸ ì„±ê³µ í›„ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
                    attachRealtimeListeners(uid);

                } else {
                    console.error("No user data found in Firestore!");
                    // ì‚¬ìš©ì ë°ì´í„°ê°€ ì—†ì–´ë„ ë¡œê·¸ì¸ì€ ëœ ìƒíƒœì¼ ìˆ˜ ìˆìŒ
                    showMessage("Could not load user profile. Logging out.");
                    await handleLogout();
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                showMessage(`Error loading profile: ${error.message}`);
                await handleLogout();
            }
        }
        
        /**
         * ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (ìœ„ì¹˜, ë¡œê·¸) ì—°ê²°
         * @param {string} userId - ë¡œê·¸ì¸í•œ ì‚¬ìš©ì UID
         */
         function attachRealtimeListeners(userId) {
            // 0. ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ í•´ì œ (ì¤‘ë³µ ë°©ì§€)
            if (locationUnsubscribe) locationUnsubscribe();
            if (logsUnsubscribe) logsUnsubscribe();
            
            // 1. ìœ„ì¹˜ ì •ë³´ ë¦¬ìŠ¤ë„ˆ (Public)
            // [ìˆ˜ì •] public ê²½ë¡œëŠ” /artifacts/{appId}/public/data/...
            // ì—¬ê¸°ì„œëŠ” 'device_location' ì»¬ë ‰ì…˜ì˜ 'device_01' ë¬¸ì„œë¥¼ êµ¬ë…
            const locationDocRef = doc(db, `artifacts/${appId}/public/data/device_location`, "device_01");
            
            locationUnsubscribe = onSnapshot(locationDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const locationData = docSnap.data();
                    console.log("Realtime location update:", locationData);
                    
                    // ì§€ë„ê°€ í‘œì‹œëœ ìƒíƒœë¼ë©´ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                    if (kakaoMap && locationData.latitude && locationData.longitude) {
                        updateMapMarker(locationData.latitude, locationData.longitude);
                    }
                } else {
                    console.warn("Device location document does not exist.");
                }
            }, (error) => {
                console.error("Error in location snapshot listener:", error);
                // ì´ ì—ëŸ¬ëŠ” ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  í•„ìš”ëŠ” ì—†ì„ ìˆ˜ ìˆìŒ (ì§€ë„ ë¡œë”© ì‹¤íŒ¨ë¡œ ì²˜ë¦¬)
            });
            
            console.log("Attached location listener.");
            
            // 2. ë„ì–´ë½ ë¡œê·¸ ë¦¬ìŠ¤ë„ˆ (Private)
            // [ìˆ˜ì •] private ê²½ë¡œëŠ” /artifacts/{appId}/users/{userId}/...
            // ì—¬ê¸°ì„œëŠ” 'door_lock_logs' ì»¬ë ‰ì…˜ì„ êµ¬ë…
            const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}`, "door_lock_logs");
            
            // [ìˆ˜ì •] Firestore ì¿¼ë¦¬ - timestamp ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ(ìµœì‹ ìˆœ) ì •ë ¬, 50ê°œ ì œí•œ
            // [ì£¼ì˜] ì´ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Firestoreì—ì„œ 'door_lock_logs' ì»¬ë ‰ì…˜ì˜
            // 'timestamp' í•„ë“œì— ëŒ€í•œ 'ë‚´ë¦¼ì°¨ìˆœ' ë‹¨ì¼ í•„ë“œ ì¸ë±ìŠ¤ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            const logsQuery = query(logsCollectionRef, orderBy("timestamp", "desc"), limit(50));

            logsUnsubscribe = onSnapshot(logsQuery, (querySnapshot) => {
                const logsData = [];
                querySnapshot.forEach((doc) => {
                    logsData.push({ id: doc.id, ...doc.data() });
                });
                
                // [ìˆ˜ì •] ì¿¼ë¦¬ì—ì„œ ì´ë¯¸ ì •ë ¬í–ˆìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ í•„ìš” ì—†ìŒ
                // logsData.sort((a, b) => b.timestamp - a.timestamp);
                
                console.log("Realtime logs update:", logsData);
                
                // ë¡œê·¸ í˜ì´ì§€ê°€ í™œì„±í™”ëœ ìƒíƒœë¼ë©´ ë¡œê·¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (logPage.classList.contains('show')) {
                    displayLogs(logsData);
                }

            }, (error) => {
                console.error("Error in logs snapshot listener:", error);
                if (logPage.classList.contains('show')) {
                     logMessage.textContent = "Error loading logs. Check Firestore indexes."; // [ìˆ˜ì •] ì¸ë±ìŠ¤ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ
                     logContainer.innerHTML = ''; // ê¸°ì¡´ ë¡œê·¸ ì§€ìš°ê¸°
                }
            });
            
            console.log("Attached logs listener.");
         }


        // --- í˜ì´ì§€ ì „í™˜ í•¸ë“¤ëŸ¬ ---
        
        // (ë¡œê·¸ì¸/íšŒì›ê°€ì…)
        showRegister.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('registerPage');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            showPage('loginPage');
        });
        
        // (í™˜ì˜ -> ì§€ë„/ë¡œê·¸)
        goToMapBtn.addEventListener('click', () => {
            showPage('mapPage');
            // ì§€ë„ í˜ì´ì§€ í‘œì‹œ ì‹œ ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ
            loadKakaoMap();
        });
        
        viewLogsBtn.addEventListener('click', () => {
            showPage('logPage');
            // ë¡œê·¸ í˜ì´ì§€ í‘œì‹œ ì‹œ ë¡œê·¸ ë¡œë“œ (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆìŒ)
            // í˜ì´ì§€ ì§„ì… ì‹œ 1íšŒì„± ë¡œë“œë¥¼ ì¶”ê°€ë¡œ í˜¸ì¶œí•˜ì—¬ ì¦‰ê°ì ì¸ ë°˜ì‘ ë³´ì¥
            loadAllLogs(currentUserId); // [ìˆ˜ì •] ìˆ˜ë™ ë¡œë“œ í•¨ìˆ˜ í˜¸ì¶œ
        });
        
        // (ì§€ë„/ë¡œê·¸ -> í™˜ì˜)
        backToWelcomeBtn.addEventListener('click', () => {
            showPage('welcomePage');
        });
        
        backToWelcomeBtnLog.addEventListener('click', () => {
             showPage('welcomePage');
        });
        
        // (ì§€ë„ ìƒˆë¡œê³ ì¹¨)
        refreshMapBtn.addEventListener('click', () => {
            // ìˆ˜ë™ìœ¼ë¡œ ìœ„ì¹˜ ì •ë³´ 1íšŒ ê°€ì ¸ì˜¤ê¸° (ë¦¬ìŠ¤ë„ˆê°€ ìˆì–´ë„ ì¦‰ê° ë°˜ì˜)
            loadDeviceLocation(true); // true: ì§€ë„ íŒ¨ë‹
        });


        // --- ì§€ë„ (Kakao Map) ê´€ë ¨ ---
        
        /**
         * ì¹´ì¹´ì˜¤ë§µ API ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ
         */
        function loadKakaoMap() {
            if (document.getElementById('kakaoMapScript')) {
                // ì´ë¯¸ ìŠ¤í¬ë¦½íŠ¸ê°€ ë¡œë“œë˜ì—ˆë‹¤ë©´ ì§€ë„ ì´ˆê¸°í™”ë§Œ ì§„í–‰
                if (!kakaoMap) { // ì§€ë„ê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì•˜ë‹¤ë©´
                     initializeMap();
                } else { // ì§€ë„ê°€ ìˆë‹¤ë©´ ìœ„ì¹˜ë§Œ ë¡œë“œ
                    loadDeviceLocation(true); // true: ì§€ë„ íŒ¨ë‹
                }
                return;
            }

            const script = document.createElement('script');
            script.id = 'kakaoMapScript';
            // [ì£¼ì˜] ì¹´ì¹´ì˜¤ë§µ API í‚¤ëŠ” ë…¸ì¶œì— ë¯¼ê°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì„œë²„ë¥¼ í†µí•´ í‚¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” í…ŒìŠ¤íŠ¸ í¸ì˜ë¥¼ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ì— í¬í•¨í•©ë‹ˆë‹¤.
            // [ìˆ˜ì •] 'YOUR_KAKAO_MAP_API_KEY'ë¥¼ ì‹¤ì œ í‚¤ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.
            const KAKAO_API_KEY = "YOUR_KAKAO_MAP_API_KEY"; //
            script.src = `//dapi.kakao.com/v2/maps/sdk.js?appkey=${KAKAO_API_KEY}&autoload=false`;
            document.head.appendChild(script);
            
            script.onload = () => {
                kakao.maps.load(() => {
                    console.log("Kakao Map SDK loaded.");
                    initializeMap();
                });
            };
            
            script.onerror = () => {
                console.error("Failed to load Kakao Map SDK.");
                mapLoadingOverlay.textContent = "Failed to load map.";
            }
        }
        
        /**
         * ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
         */
        function initializeMap() {
            try {
                const options = {
                    center: new kakao.maps.LatLng(37.566826, 126.9786567), // ê¸°ë³¸ê°’ (ì„œìš¸ì‹œì²­)
                    level: 3 // í™•ëŒ€ ë ˆë²¨
                };
                kakaoMap = new kakao.maps.Map(mapContainer, options);
                console.log("Kakao Map initialized.");
                
                // ë¡œë”© ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                mapLoadingOverlay.style.display = 'none';
                
                // ì§€ë„ ì´ˆê¸°í™” í›„ ì¥ì¹˜ ìœ„ì¹˜ ë¡œë“œ
                loadDeviceLocation(true); // true: ì²« ë¡œë“œ ì‹œ ì§€ë„ë¥¼ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì´ë™

            } catch(error) {
                 console.error("Kakao Map initialization error:", error);
                 mapLoadingOverlay.textContent = "Error initializing map.";
            }
        }
        
        /**
         * ì¥ì¹˜ ìœ„ì¹˜ ì •ë³´ ë¡œë“œ (1íšŒì„±) ë° ì§€ë„ ì—…ë°ì´íŠ¸
         * @param {boolean} [panTo=false] - trueì´ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ ì´ë™ì‹œí‚´
         */
        async function loadDeviceLocation(panTo = false) {
             if (!kakaoMap) {
                 console.warn("loadDeviceLocation called but map is not ready.");
                 return;
             }
             
             try {
                // [ìˆ˜ì •] onSnapshot ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ìˆìœ¼ë¯€ë¡œ, 1íšŒì„± getDocì€
                // ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ í´ë¦­ ì‹œì—ë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ.
                // ì—¬ê¸°ì„œëŠ” ë¦¬ìŠ¤ë„ˆê°€ ê°€ì ¸ì˜¨ ìœ„ì¹˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìœ ë„.
                // (ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ attachRealtimeListenersì—ì„œ ì—°ê²°ë¨)
                
                // ë§Œì•½ 'ìƒˆë¡œê³ ì¹¨' (panTo=true)ì´ê±°ë‚˜ ë§ˆì»¤ê°€ ì—†ë‹¤ë©´ 1íšŒì„± ë¡œë“œ
                if (panTo || !mapMarker) {
                    console.log("Forcing device location refresh (getDoc)...");
                    const locationDocRef = doc(db, `artifacts/${appId}/public/data/device_location`, "device_01");
                    const docSnap = await getDoc(locationDocRef);
                    
                    if (docSnap.exists()) {
                         const locationData = docSnap.data();
                         if (locationData.latitude && locationData.longitude) {
                             updateMapMarker(locationData.latitude, locationData.longitude, panTo);
                         } else {
                             showMessage("Device location data is incomplete.");
                         }
                    } else {
                         showMessage("Could not find device location data.");
                    }
                }

             } catch(error) {
                console.error("Error fetching device location:", error);
                showMessage("Failed to fetch device location.");
             }
        }
        
        
        /**
         * ì§€ë„ ë§ˆì»¤ ë° ì •ë³´ì°½ ì—…ë°ì´íŠ¸
         * @param {number} lat - ìœ„ë„
         * @param {number} lng - ê²½ë„
         * @param {boolean} [panTo=false] - trueì´ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ì§€ë„ë¥¼ ì´ë™
         */
        function updateMapMarker(lat, lng, panTo = false) {
            if (!kakaoMap) return;
            
            const position = new kakao.maps.LatLng(lat, lng);
            
            // ë§ˆì»¤ ìƒì„± (ì—†ìœ¼ë©´)
            if (!mapMarker) {
                mapMarker = new kakao.maps.Marker({
                    position: position
                });
                mapMarker.setMap(kakaoMap);
                console.log("Map marker created.");
            } else {
                // ë§ˆì»¤ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                mapMarker.setPosition(position);
            }
            
            // ì •ë³´ì°½ ë‚´ìš© (ê°„ë‹¨í•˜ê²Œ)
            // [ìˆ˜ì •] ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì‚¬ìš© (ì¹´ì¹´ì˜¤ ê¸°ë³¸ infoWindow ëŒ€ì‹ )
            const infoContent = `
                <div class="info-window">
                    <div class="title">My Device</div>
                    <div class="address">Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}</div>
                    <div class="close-btn" onclick="this.parentElement.parentElement.style.display='none';">X</div>
                </div>`;

            // ì •ë³´ì°½ ìƒì„± (ì—†ìœ¼ë©´)
            if (!infoWindow) {
                infoWindow = new kakao.maps.CustomOverlay({
                    content: infoContent,
                    position: position,
                    yAnchor: 1.4 // ë§ˆì»¤ ìœ„ì— í‘œì‹œ
                });
                 // infoWindow.setMap(kakaoMap); // [ìˆ˜ì •] ì²˜ìŒì—ëŠ” ìˆ¨ê¹€
            } else {
                // ì •ë³´ì°½ ë‚´ìš© ë° ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                infoWindow.setContent(infoContent);
                infoWindow.setPosition(position);
            }
            
            // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ
            kakao.maps.event.addListener(mapMarker, 'click', function() {
                infoWindow.setMap(kakaoMap);
            });

            // ì§€ë„ ì´ë™ (panToê°€ trueì¸ ê²½ìš°)
            if (panTo) {
                kakaoMap.panTo(position);
            }
        }
        

        // --- ë¡œê·¸ ê´€ë ¨ ---
        
        /**
         * Firestoreì—ì„œ ëª¨ë“  ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° (1íšŒì„±)
         * [ìˆ˜ì •] onSnapshot ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë¯€ë¡œ, ì´ í•¨ìˆ˜ëŠ” 
         * í˜ì´ì§€ì— ì²˜ìŒ ì§„ì…í•  ë•Œë‚˜ ìƒˆë¡œê³ ì¹¨ ì‹œ í˜¸ì¶œ
         * @param {string} userId - ì‚¬ìš©ì UID
         */
        async function loadAllLogs(userId) {
             if (!userId) {
                 console.error("loadAllLogs: userId is missing");
                 logMessage.textContent = "User not identified.";
                 return;
             }
             
             console.log("Loading all logs (one-time)...");
             logMessage.textContent = "Loading logs...";
             
             try {
                // [ì°¸ê³ ] onSnapshot ë¦¬ìŠ¤ë„ˆê°€ ì´ë¯¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆì§€ë§Œ,
                // í˜ì´ì§€ ì§„ì… ì‹œì ì— ìµœì‹  ë°ì´í„°ë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ 1íšŒì„± getDocs í˜¸ì¶œ
                const logsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}`, "door_lock_logs");
                
                // [ìˆ˜ì •] ì¸ë±ì‹± ë¬¸ì œ í”¼í•˜ê¸° ìœ„í•´ ì¿¼ë¦¬ ë‹¨ìˆœí™” (limitë§Œ ì‚¬ìš©)
                // [ìˆ˜ì •] ì¸ë±ì‹±ì´ ì„¤ì •ë˜ì—ˆë‹¤ê³  ê°€ì •í•˜ê³  orderBy ì¶”ê°€
                const logsQuery = query(logsCollectionRef, orderBy("timestamp", "desc"), limit(50));
                
                const querySnapshot = await getDocs(logsQuery);
                
                const logsData = [];
                querySnapshot.forEach((doc) => {
                    logsData.push({ id: doc.id, ...doc.data() });
                });
                
                // ì¿¼ë¦¬ì—ì„œ ì •ë ¬í–ˆìœ¼ë¯€ë¡œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬ í•„ìš” ì—†ìŒ
                // logsData.sort((a, b) => b.timestamp - a.timestamp);
                
                displayLogs(logsData);

             } catch (error) {
                 console.error("Error fetching logs (getDocs):", error);
                 logMessage.textContent = "Failed to load logs. Check Firestore indexes.";
                 logContainer.innerHTML = ''; // ê¸°ì¡´ ë¡œê·¸ ì§€ìš°ê¸°
             }
        }
        
        /**
         * ë¡œê·¸ ë°ì´í„°ë¥¼ í™”ë©´ì— í‘œì‹œ
         * @param {Array} logsData - í‘œì‹œí•  ë¡œê·¸ ë°ì´í„° ë°°ì—´ (ìµœì‹ ìˆœ ì •ë ¬)
         */
        function displayLogs(logsData) {
            logContainer.innerHTML = ''; // ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸°
            
            if (logsData.length === 0) {
                logMessage.textContent = "No door lock logs found.";
                logContainer.appendChild(logMessage);
                return;
            }
            
            logMessage.textContent = ""; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¸°ê¸° (ë˜ëŠ” ì‚­ì œ)
            if (logMessage.parentNode === logContainer) {
                 logContainer.removeChild(logMessage);
            }

            logsData.forEach(log => {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                
                // íƒ€ì„ìŠ¤íƒ¬í”„ ë³€í™˜ (ìˆ«ìì¸ì§€ í™•ì¸)
                const timestamp = (log.timestamp && typeof log.timestamp.toDate === 'function') 
                    ? log.timestamp.toDate().getTime() // Firestore Timestamp ê°ì²´
                    : (typeof log.timestamp === 'number' ? log.timestamp : Date.now()); // ìˆ«ìí˜•
                
                const formattedTime = new Date(timestamp).toLocaleString();
                
                // [FIX 1] ì—¬ê¸°ë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
                // 'log.who'ì™€ 'log.event'ë¥¼ ëª¨ë‘ í‘œì‹œí•˜ë„ë¡ ë³€ê²½
                entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.who || 'N/A'} - ${log.event || 'N/A'}`;
                
                // [ì´ì „ ì½”ë“œ]
                // entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.event || 'N/A'}`;
                
                logContainer.appendChild(entry);
            });
        }


        // --- ì´ˆê¸°í™” ---
        
        // [FIX 2]
        document.addEventListener('DOMContentLoaded', async () => { // [ìˆ˜ì •] async ì¶”ê°€
            try {
                // Firebase ì´ˆê¸°í™”
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Firebase ë¡œê¹… ë ˆë²¨ ì„¤ì • (ë””ë²„ê¹…ìš©)
                // setLogLevel('debug');

                console.log("Firebase Initialized");

                // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
                
                // (í¼)
                loginForm.addEventListener('submit', handleLogin);
                registerForm.addEventListener('submit', handleRegister);
                
                // (ë©”ì‹œì§€)
                messageCloseBtn.addEventListener('click', closeMessage);
                messageOverlay.addEventListener('click', closeMessage);


                // --- [í•µì‹¬] ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ---
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•¨
                        console.log("Auth state changed: User is logged IN", user.uid);
                        // [ìˆ˜ì •] ìµëª… ë¡œê·¸ì¸ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
                        if (!user.isAnonymous) {
                            await loadUserDataAndShowWelcome(user.uid);
                        } else {
                             console.log("User is anonymous. Waiting for real login.");
                             // (ìµëª… ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ì— ë¨¸ë¬´ë¦„)
                             updateNavigation(false);
                             showPage('loginPage');
                        }

                    } else {
                        // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•¨
                        console.log("Auth state changed: User is logged OUT");
                        
                        // [ìˆ˜ì •] ìµëª… ë¡œê·¸ì¸ì„ ì‹œë„í•˜ì—¬ Firestore ë³´ì•ˆ ê·œì¹™ í†µê³¼ (R/W)
                        // (ë‹¨, ì´ í”„ë¡œì íŠ¸ì˜ ë³´ì•ˆ ê·œì¹™ì´ ìµëª… ë¡œê·¸ì¸ì„ í—ˆìš©í•´ì•¼ í•¨)
                        // (ë§Œì•½ ë³´ì•ˆ ê·œì¹™ì´ 'auth != null' ì´ë¼ë©´ ìµëª… ë¡œê·¸ì¸ í•„ìš”)
                        
                        /*
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously");
                        } catch (error) {
                            console.error("Anonymous sign-in failed:", error);
                        }
                        */
                        
                        // [ìˆ˜ì •] ë¡œê·¸ì•„ì›ƒ ì‹œì—ëŠ” ê·¸ëƒ¥ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ.
                        updateNavigation(false);
                        showPage('loginPage');
                    }
                });
                
                // --- Canvas í™˜ê²½ìš© ì»¤ìŠ¤í…€ í† í° ë¡œê·¸ì¸ (í•„ìˆ˜) ---
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    console.log("Attempting sign in with custom token...");
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                        console.log("Custom token sign-in successful.");
                        // onAuthStateChangedê°€ íŠ¸ë¦¬ê±°ë˜ì–´ í›„ì† ì²˜ë¦¬ ì§„í–‰
                    } catch (error) {
                        console.error("Custom token sign-in failed:", error);
                        // ì‹¤íŒ¨ ì‹œ ìµëª… ë¡œê·¸ì¸ (fallback)
                        try {
                            await signInAnonymously(auth);
                            console.log("Fell back to anonymous sign-in.");
                        } catch (anonError) {
                            console.error("Anonymous sign-in fallback failed:", anonError);
                        }
                    }
                } else {
                    // (í† í°ì´ ì—†ëŠ” ë¡œì»¬ í™˜ê²½ ë“±)
                    // onAuthStateChangedê°€ (ë¡œê·¸ì•„ì›ƒ ìƒíƒœë¡œ) ì¦‰ì‹œ ì‹¤í–‰ë˜ê±°ë‚˜,
                    // ë§Œì•½ ë¡œì»¬ì— ì„¸ì…˜ì´ ë‚¨ì•„ìˆë‹¤ë©´ ë¡œê·¸ì¸ ìƒíƒœë¡œ ì‹¤í–‰ë¨.
                    // [ìˆ˜ì •] í† í°ì´ ì—†ìœ¼ë©´ 'ë¡œê·¸ì•„ì›ƒ' ìƒíƒœë¡œ ì‹œì‘ (ìœ„ onAuthStateChangedê°€ ì²˜ë¦¬)
                     console.log("No custom token found. Waiting for onAuthStateChanged.");
                }


            } catch (error) {
                console.error("Failed to initialize Firebase app:", error);
                showMessage("Critical Error: Could not initialize services. Please refresh.");
            }
        }); // DOMContentLoaded ë
    </script>
</body>
</html>
```eof
