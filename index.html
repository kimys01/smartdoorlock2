<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="color-scheme" content="light only">
    <meta name="supported-color-schemes" content="light">

    <title>Smart Doorlock Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="indexstyle.css?v=3.0">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container" class="hidden">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">아이디</label>
                <input type="text" id="username" placeholder="아이디를 입력하세요" required>
            </div>
            <div class="input-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
            </div>
            <button type="submit">로그인</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" title="초기 화면으로 이동">Smart Doorlock</h1> 
        <div class="button-group">
            <button id="mapBtn" disabled>지도</button>
            <button id="logBtn" disabled>로그 보기</button>
            <button id="newBtn">DB 조회</button>
            <button id="logoutBtn">로그아웃</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" title="닫기">✕</button>
                </div>
                <div id="infoArea">사용자를 선택해주세요.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div> 
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <h2 id="logUserTitle">전체 로그</h2>
        </div>
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">도어락 로그</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">앱 로그</button>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section active-tab-content">
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <h2>DataBase</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="검색할 사용자 ID 입력">
                <button class="btn-search" onclick="searchUser()">검색</button>
                <button class="btn-reset" onclick="loadAllDBData()">전체 목록</button>
            </div>
            <h3 id="result-title">User List:</h3>
            <div id="result-area">
                <div style="padding:20px; text-align:center; color:#666;">데이터를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">확인</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>로그아웃 하시겠습니까?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">확인</button>
                <button id="cancelLogoutBtn" style="flex: 1; background-color: #aaa;">취소</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    console.log("App initialized.");

    // --- Global Variables ---
    let DOORLOCK_LAT = 37.566826;   
    let DOORLOCK_LNG = 126.9786567;
    let MAX_DISTANCE_KM = 3.0;
    let database, map, doorlockMarker, currentPolyline, selectedLogMarker, selectedUserId;
    let markers = [], zoneCircles = [], currentUserLocationLogs = [];

    const firebaseConfig = {
        apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
        authDomain: "smartdoorlock-b4636.web.app", 
        databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
        projectId: "smartdoorlock-b4636",
        storageBucket: "smartdoorlock-b4636.firebasestorage.app",
        messagingSenderId: "104489505270",
        appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
        measurementId: "G-4TH9MB9WPM"
    };

    try {
        if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase Load Fail");
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
    } catch (e) {
        alert("Firebase 초기화 실패. 새로고침 하세요.");
        return;
    }

    // --- Helper Functions (formatTimestamp, getDistanceFromLatLonInKm, customAlert 등)
    // >>> 이 부분은 네 코드랑 동일하니 그대로 두면 됨 (생략하지 말고 유지)

    function formatTimestamp(ts) { /* ... 네 코드 그대로 ... */ }
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) { /* ... */ }
    function customAlert(msg) { /* ... */ }

    // --- Core Logic (loadUserDoorlockAndInit, loadAllLogs 등) ---
    // >>> 이 부분도 네 코드 그대로 사용 (내용 변경 필요 없음)

    function loadUserDoorlockAndInit(userId, callback) { /* ... */ }
    function loadAllLogs(userId) { /* ... */ }

    // --- UI Logic ---
    window.switchLogTab = function(tabName) { /* ... */ };

    // --- Map Logic (initMap, drawDoorlockZones, selectUser, renderLocationLogs 등) ---
    function initMap() { /* ... */ }
    function drawDoorlockZones() { /* ... */ }
    function selectUser(userId) { /* ... */ }
    function renderLocationLogs(filter) { /* ... */ }
    function clearMapAndInfo() { /* ... */ }

    // --- Admin & Navigation (loadUserList, searchUser, loadAllDBData, renderGrid, toggleAccordion 등) ---
    function loadUserList() { /* ... */ }
    window.searchUser = function () { /* ... */ }
    window.loadAllDBData = function () { /* ... */ }
    function renderGrid(data) { /* ... */ }
    window.toggleAccordion = function(header) { /* ... */ }
    function createTreeView(data, depth) { /* ... */ }

    // --- 로그인 처리 ---
    document.getElementById('login-form').onsubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('username').value;
        const pw = document.getElementById('password').value;
        
        database.ref('admin_pass').once('value').then(snap => {
            let isAdmin = false;
            snap.forEach(c => { 
                if (c.val().adminId === id && c.val().password === pw) isAdmin = true; 
            });

            if (isAdmin) {
                // 관리자 로그인
                sessionStorage.setItem('isAdmin', 'true');
                sessionStorage.removeItem('userId');
                showMain(true, id);
                return;
            }

            // 일반 사용자 로그인
            database.ref('users/' + id).once('value').then(usnap => {
                if (usnap.exists() && usnap.val().password === pw) {
                    sessionStorage.setItem('isAdmin', 'false');
                    sessionStorage.setItem('userId', id);
                    showMain(false, id);
                } else {
                    customAlert("로그인 실패");
                }
            });
        });
    };

    // === 여기부터가 가장 중요한 showMain ===
    function showMain(isAdmin, uid) {
        const body   = document.body;
        const login  = document.getElementById('login-container');
        const header = document.getElementById('header');
        const main   = document.getElementById('main-content');
        const userInfo = document.getElementById('userInfo');
        const userList = document.getElementById('userList');
        const closeBtn = document.getElementById('closeUserInfoBtn');
        const dbBtn    = document.getElementById('newBtn');

        // 공통: 로그인 숨기고 메인 보이기
        login.classList.add('hidden');
        header.classList.remove('hidden');
        main.classList.remove('hidden');

        if (isAdmin) {
            // ===== 관리자 모드 =====
            body.classList.remove('user-mode');   // 관리자에서는 user-mode 사용 안 함

            userList.classList.remove('hidden');
            userInfo.classList.add('hidden');

            if (closeBtn) closeBtn.style.display = 'block';
            if (dbBtn)    dbBtn.style.display    = 'inline-block';

            if (window.kakao) kakao.maps.load(initMap);

        } else {
            // ===== 일반 사용자 모드 =====
            body.classList.add('user-mode');      // 사용자 모드 전용 CSS 활성화

            userList.classList.add('hidden');
            userInfo.classList.remove('hidden');

            if (closeBtn) closeBtn.style.display = 'none';
            if (dbBtn)    dbBtn.style.display    = 'none';

            if (window.kakao) kakao.maps.load(() => {
                initMap();
                loadUserDoorlockAndInit(uid, () => selectUser(uid));
            });
        }

        setupNav();
    }

    // 네비게이션 버튼 세팅
    function setupNav() {
        document.getElementById('logoutBtn').onclick = () => 
            document.getElementById('logout-confirm-modal').classList.remove('hidden');

        document.getElementById('confirmLogoutBtn').onclick = () => {
            sessionStorage.clear();
            location.reload();
        };

        document.getElementById('cancelLogoutBtn').onclick = () => 
            document.getElementById('logout-confirm-modal').classList.add('hidden');
        
        const headerTitle = document.getElementById('header-title');
        if (headerTitle) {
            headerTitle.style.cursor = 'pointer';
            headerTitle.onclick = () => window.location.reload();
        }

        document.getElementById('logBtn').onclick = () => {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('db-content').classList.add('hidden');
            document.getElementById('log-content').classList.remove('hidden');
            document.getElementById('mapBtn').disabled = false;
            document.getElementById('logBtn').disabled = true;
            document.getElementById('newBtn').disabled = false;
            if (selectedUserId) loadAllLogs(selectedUserId);
        };
        
        document.getElementById('mapBtn').onclick = () => {
            document.getElementById('log-content').classList.add('hidden');
            document.getElementById('db-content').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('mapBtn').disabled = true;
            document.getElementById('logBtn').disabled = false;
            document.getElementById('newBtn').disabled = false;
            if (map) map.relayout();
        };

        document.getElementById('newBtn').onclick = () => {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('log-content').classList.add('hidden');
            document.getElementById('db-content').classList.remove('hidden');
            document.getElementById('mapBtn').disabled = false;
            document.getElementById('logBtn').disabled = false;
            document.getElementById('newBtn').disabled = true;
            loadAllDBData();
        };
        
        document.getElementById('closeUserInfoBtn').onclick = () => {
            document.getElementById('userInfo').classList.add('hidden');
            clearMapAndInfo();
        };
    }

    // === Auto Login Check ===
    if (sessionStorage.getItem('isAdmin')) {
        const flag = sessionStorage.getItem('isAdmin') === 'true';
        const uid  = sessionStorage.getItem('userId');
        showMain(flag, uid);
    } else {
        document.getElementById('login-container').classList.remove('hidden');
    }
});
</script>
</body>
</html>




