<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone Project</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- ▼▼▼ [수정] 외부 CSS 파일 연결 ▼▼▼ -->
    <link rel="stylesheet" href="indexstyle.css">
    <!-- ▲▲▲ [수정 완료] ▲▲▲ -->

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <!-- ▼▼▼ [수정] Firebase Auth SDK 삭제 (기능 제거됨) ▼▼▼ -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> -->
    <!-- ▲▲▲ [수정 완료] ▲▲▲ -->

</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2> <!-- [수정] 텍스트 변경 -->
        <form id="login-form">
            <div class="input-group">
                <label for="username">아이디</label>
                <input type="text" id="username" placeholder="아이디를 입력하세요" required>
            </div>
            <div class="input-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
            </div>
            <button type="submit">로그인</button>
        </form>
        <!-- 비밀번호 찾기 링크 삭제됨 -->
    </div>

    <div id="header" class="hidden">
        <!-- ▼▼▼ [수정] ID 추가 (클릭 이벤트를 위해) ▼▼▼ -->
        <h1 id="header-title">Smart Doorlock</h1> 
        <!-- ▲▲▲ [수정 완료] ▲▲▲ -->
        <div class="button-group">
            <button id="logBtn" disabled>로그 보기</button>
            <button id="newBtn">DB 편집</button>
            <button id="logoutBtn">로그아웃</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Information</h2> <!-- [수정] 텍스트 변경 -->
                    <button id="closeUserInfoBtn">X</button>
                </div>
                <div id="infoArea">사용자를 선택해주세요.</div>
            </div>
            <div id="userList">
                <h2>User List</h2> <!-- [수정] 텍스트 변경 -->
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2> <!-- [수정] 텍스트 변경 -->
            <p id="mapUser">사용자를 선택하면 이동 경로가 표시됩니다.</p>
            <div id="map"></div> 
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <button id="backToMapBtn">&larr; 지도로 돌아가기</button>
            <h2 id="logUserTitle">전체 로그</h2>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section">
                <h3>DoorLock Logs</h3> <!-- [수정] 텍스트 변경 -->
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <h3>App Logs</h3> <!-- [수정] 텍스트 변경 -->
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">확인</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");

            // --- DOM 요소 ---
            const loginContainer = document.getElementById('login-container');
            const mainContent = document.getElementById('main-content');
            const header = document.getElementById('header');
            const logContent = document.getElementById('log-content');
            const loginForm = document.getElementById('login-form');
            const body = document.querySelector('body');
            const closeUserInfoButton = document.getElementById('closeUserInfoBtn');
            
            // ▼▼▼ [설정] 도어락 고정 위치 (실제 위치로 변경 필요) ▼▼▼
            const DOORLOCK_LAT = 37.566826; 
            const DOORLOCK_LNG = 126.9786567;
            // ▲▲▲ [설정 끝] ▲▲▲

            // Firebase 설정
            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };
            
            let database;
            let map;
            let markers = [];
            let zoneCircles = [];
            let currentPolyline;
            let selectedLogMarker;
            let selectedUserId = null;

            // Firebase 초기화
            try {
                if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                     throw new Error("Firebase SDK not loaded correctly.");
                }
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase 초기화 오류:", e);
                customAlert("Firebase 초기화에 실패했습니다. 콘솔을 확인하세요.");
                return;
            }

            // --- 거리 계산 함수 ---
            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                function deg2rad(deg) { return deg * (Math.PI/180); }
                var R = 6371; 
                var dLat = deg2rad(lat2-lat1);  
                var dLon = deg2rad(lon2-lon1); 
                var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                var d = R * c; 
                return d;
            }

            // 커스텀 alert
            function customAlert(message) {
                const modal = document.getElementById('custom-modal');
                const messageElem = document.getElementById('modal-message');
                if (modal && messageElem) {
                    messageElem.textContent = message;
                    modal.style.display = 'flex';
                } else {
                    alert(message);
                }
            }
            
            // UI 표시 함수
            function showMainContent(isAdmin, loggedInUserId) {
                if (loginContainer) loginContainer.classList.add('hidden');
                if (mainContent) mainContent.classList.remove('hidden');
                if (header) header.classList.remove('hidden');
                if (body) body.style.overflow = 'auto';

                const userListDiv = document.getElementById('userList');
                const newBtn = document.getElementById('newBtn'); 
                const userInfoDiv = document.getElementById('userInfo');

                if (isAdmin) {
                    // 관리자
                    if (userListDiv) userListDiv.classList.remove('hidden');
                    if (newBtn) newBtn.classList.remove('hidden');
                    if (userInfoDiv) userInfoDiv.classList.add('hidden');
                    
                    if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                         kakao.maps.load(initMap); 
                    }
                } else {
                    // 일반 사용자
                    if (userListDiv) userListDiv.classList.add('hidden');
                    if (newBtn) newBtn.classList.add('hidden');
                    if (userInfoDiv) userInfoDiv.classList.remove('hidden');

                    selectedUserId = loggedInUserId;
                    
                    if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                         kakao.maps.load(() => {
                            initMap(); 
                            selectUser(loggedInUserId);
                         });
                    }
                }
                setupMainUIEventListeners();
            }

            // 지도 초기화 및 도어락 반경 그리기
            function initMap() {
                if (typeof kakao === 'undefined' || !kakao.maps || !kakao.maps.Map) {
                    customAlert("지도 SDK 로딩 오류.");
                    return;
                }
                const container = document.getElementById('map');
                map = new kakao.maps.Map(container, {
                    center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG),
                    level: 7
                });
                map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                
                drawDoorlockZones();

                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                if (isAdmin) loadUserList();
            }

            // 도어락 위치 및 반경 표시
            function drawDoorlockZones() {
                const doorlockPosition = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
                
                // 도어락 마커
                const markerImage = new kakao.maps.MarkerImage(
                    'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                    new kakao.maps.Size(35, 35)
                );
                const doorlockMarker = new kakao.maps.Marker({
                    position: doorlockPosition,
                    image: markerImage,
                    map: map,
                    title: "우리집 도어락"
                });

                // 반경 원
                const radii = [
                    { r: 1000, color: '#FF0000' }, 
                    { r: 2000, color: '#FFA500' }, 
                    { r: 3000, color: '#008000' }  
                ];

                radii.forEach(zone => {
                    const circle = new kakao.maps.Circle({
                        center : doorlockPosition,
                        radius: zone.r,
                        strokeWeight: 1, 
                        strokeColor: zone.color,
                        strokeOpacity: 0.8, 
                        strokeStyle: 'dashed', 
                        fillColor: zone.color,
                        fillOpacity: 0.1 
                    });
                    circle.setMap(map);
                    zoneCircles.push(circle);
                });
            }

            // 사용자 목록 로드
            function loadUserList() {
                if (!database) return;
                const userListDiv = document.getElementById('userList');
                const h2 = userListDiv?.querySelector('h2');
                const usersRef = database.ref('users');

                usersRef.once('value').then((snapshot) => {
                    const existingUsers = userListDiv.querySelectorAll('.user');
                    existingUsers.forEach(el => el.remove());

                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        const userElement = document.createElement('div');
                        userElement.className = 'user';
                        userElement.textContent = userId;
                        userElement.addEventListener('click', () => selectUser(userId));
                        h2.insertAdjacentElement('afterend', userElement);
                    });
                });
            }

            // 지도 초기화 (사용자 경로 지우기)
            function clearMapAndInfo() {
                markers.forEach(marker => {
                    if (marker.customOverlay) marker.customOverlay.setMap(null);
                    marker.setMap(null);
                });
                markers = [];
                if (currentPolyline) {
                    currentPolyline.setMap(null);
                    currentPolyline = null;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    if (selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null);
                    selectedLogMarker = null;
                }
                // *주의* zoneCircles와 doorlockMarker는 지우지 않음 (고정)

                const infoArea = document.getElementById('infoArea');
                if (infoArea) infoArea.innerHTML = '';
                
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                const logBtnElem = document.getElementById('logBtn');
                if (logBtnElem) logBtnElem.disabled = true;
                if (isAdmin) selectedUserId = null;
            }

            // [추가] 사용자 정보 닫기 함수
            function closeUserInfo() {
                console.log("closeUserInfo called.");
                clearMapAndInfo();
            }

            // 위치 마커 표시
            function showLocationOnMap(lat, lng) {
                if (!map) return;
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    if (selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null);
                }
                const position = new kakao.maps.LatLng(lat, lng);
                
                const dist = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                let distStr = `${dist.toFixed(2)}km`;
                
                const overlayContent = `<div class="custom-overlay-info">
                                            <strong>선택된 위치</strong><br>
                                            도어락과의 거리: <span style="color:blue; font-weight:bold;">${distStr}</span><br>
                                            위도: ${lat.toFixed(6)}<br>경도: ${lng.toFixed(6)}
                                           </div>`;
                const infoOverlay = new kakao.maps.CustomOverlay({
                    content: overlayContent,
                    position: position,
                    xAnchor: 0.5, yAnchor: 2.5, zIndex: 3
                });

                const markerImg = document.createElement('img');
                markerImg.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
                markerImg.className = 'custom-marker-pin';
                markerImg.style.cursor = 'pointer';
                markerImg.addEventListener('mouseover', () => { infoOverlay.setMap(map); });
                markerImg.addEventListener('mouseout', () => { infoOverlay.setMap(null); });
                
                selectedLogMarker = new kakao.maps.CustomOverlay({
                    position: position,
                    content: markerImg,
                    yAnchor: 1
                });
                selectedLogMarker.infoBox = infoOverlay; 
                selectedLogMarker.setMap(map);
                map.panTo(position);
            }

            // 사용자 선택 및 경로 표시 (거리 계산 포함)
            function selectUser(userId) {
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                if (isAdmin) clearMapAndInfo();

                selectedUserId = userId;
                const logBtnElem = document.getElementById('logBtn');
                if (logBtnElem) logBtnElem.disabled = false;

                const infoArea = document.getElementById('infoArea');
                const userInfoDiv = document.getElementById('userInfo');

                if (infoArea && userInfoDiv) {
                    infoArea.innerHTML = `<p><strong>User ID:</strong> ${userId}</p><h3>위치 기록</h3><div class="log-list"></div>`;
                    userInfoDiv.classList.remove('hidden');
                }

                const locationsRef = database.ref('users/' + userId + '/location_logs');

                locationsRef.once('value').then((snapshot) => {
                    const logListDiv = infoArea.querySelector('.log-list');
                    if (!logListDiv) return;
                    logListDiv.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        logListDiv.innerHTML = '표시할 위치 기록이 없습니다.';
                    } else {
                        const logs = [];
                        snapshot.forEach(childSnapshot => logs.push(childSnapshot.val()));
                        
                        logs.reverse().forEach((pos) => { // 최신순
                            if (!pos || !pos.latitude || !pos.longitude) return;
                            const lat = parseFloat(pos.latitude);
                            const lng = parseFloat(pos.longitude);
                            if (isNaN(lat) || isNaN(lng)) return;

                            // 거리 계산 및 구역 판별
                            const distKm = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                            let zoneBadge = '';
                            let rowStyle = '';

                            if (distKm <= 1.0) {
                                zoneBadge = '<span style="color:red; font-weight:bold;">[1km 내 진입]</span>';
                                rowStyle = 'background-color: #ffeaea;'; 
                            } else if (distKm <= 2.0) {
                                zoneBadge = '<span style="color:orange; font-weight:bold;">[2km 내 진입]</span>';
                                rowStyle = 'background-color: #fff8e1;'; 
                            } else if (distKm <= 3.0) {
                                zoneBadge = '<span style="color:green; font-weight:bold;">[3km 내 진입]</span>';
                            }

                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';
                            if (rowStyle) logEntry.style = rowStyle; 

                            const timeStr = pos.timestamp ? new Date(pos.timestamp).toLocaleString('ko-KR') : '시간 없음';
                            
                            logEntry.innerHTML = `${zoneBadge}<br>
                                                  <small>${timeStr}</small><br>
                                                  거리: <strong>${distKm.toFixed(2)}km</strong>`;
                            
                            logEntry.addEventListener('click', () => showLocationOnMap(lat, lng));
                            logListDiv.appendChild(logEntry);
                        });
                    }
                });

                // 지도 경로 그리기
                const recentQuery = database.ref('users/' + userId + '/location_logs').limitToLast(20); 
                recentQuery.once('value').then((snapshot) => {
                    if (!snapshot.exists()) return;
                    let path = [];
                    const bounds = new kakao.maps.LatLngBounds();
                    // 도어락 위치도 범위에 포함
                    bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));

                    snapshot.forEach((snap) => {
                        const pos = snap.val();
                        const lat = parseFloat(pos.latitude);
                        const lng = parseFloat(pos.longitude);
                        if (isNaN(lat) || isNaN(lng)) return;
                        
                        const latlng = new kakao.maps.LatLng(lat, lng);
                        path.push(latlng);
                        bounds.extend(latlng);

                        // 경로 점 찍기
                        const dist = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                        const dotContent = `<div class="custom-overlay-info">
                                                ${dist.toFixed(2)}km 지점
                                            </div>`;
                        const infoOverlay = new kakao.maps.CustomOverlay({
                            content: dotContent, position: latlng, yAnchor: 2.5, zIndex: 3
                        });
                        const dotImg = document.createElement('img');
                        dotImg.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                        dotImg.className = 'custom-marker-dot';
                        dotImg.style.cursor = 'pointer';
                        dotImg.addEventListener('mouseover', () => infoOverlay.setMap(map));
                        dotImg.addEventListener('mouseout', () => infoOverlay.setMap(null));

                        const overlay = new kakao.maps.CustomOverlay({
                            position: latlng, content: dotImg, xAnchor: 0.5, yAnchor: 0.5
                        });
                        overlay.setMap(map);
                        markers.push(overlay); 
                        overlay.customOverlay = infoOverlay;
                    });

                    if (path.length > 0) {
                        currentPolyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: 4, strokeColor: '#CC00CC', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                        });
                        map.setBounds(bounds);
                    }
                });
            }

            // 전체 로그 로드 (모달창)
            function loadAllLogs(userId) {
                const doorLockLogContainer = document.querySelector('#doorLockLogs .log-entries');
                const appLogContainer = document.querySelector('#appLogs .log-entries');
                const logUserTitle = document.getElementById('logUserTitle');

                logUserTitle.textContent = `${userId} 전체 로그`;
                doorLockLogContainer.innerHTML = '<em>로딩 중...</em>';
                appLogContainer.innerHTML = '<em>로딩 중...</em>';

                // 1. 도어락 로그
                const doorLockRef = database.ref('doorlock_logs/' + userId).orderByKey().startAt(userId).endAt(userId + "\uf8ff");
                doorLockRef.once('value').then((snapshot) => {
                    doorLockLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        doorLockLogContainer.innerHTML = '표시할 도어락 로그가 없습니다.';
                    } else {
                        const logs = [];
                        snapshot.forEach(child => logs.push(child.val()));
                        logs.reverse().forEach(log => {
                            const entry = document.createElement('div');
                            entry.className = 'full-log-entry';
                            
                            let formattedTime = '시간 없음';
                            if (typeof log.timestamp === 'number') formattedTime = new Date(log.timestamp).toLocaleString('ko-KR');
                            else if (typeof log.timestamp === 'string') formattedTime = new Date(log.timestamp.replace(" ", "T")).toLocaleString('ko-KR');
                            
                            const methodStr = log.method || '방식 모름';
                            const statusStr = log.status || '상태 모름';

                            entry.innerHTML = `<strong>[${formattedTime}]</strong><br>
                                               <span style="margin-left: 10px;">방식: ${methodStr}</span><br>
                                               <span style="margin-left: 10px;">상태: ${statusStr}</span>`; 
                            doorLockLogContainer.appendChild(entry);
                        });
                    }
                });

                // 2. 앱 로그 (하위 폴더 전체)
                const appLogRef = database.ref('users/' + userId + '/app_logs');
                appLogRef.once('value').then((snapshot) => {
                    appLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        appLogContainer.innerHTML = '표시할 앱 로그가 없습니다.';
                    } else {
                        const logs = [];
                        snapshot.forEach(categorySnapshot => {
                            const categoryName = categorySnapshot.key; 
                            const settingsObject = categorySnapshot.val(); 
                            
                            if (typeof settingsObject === 'object' && settingsObject !== null) {
                                Object.keys(settingsObject).forEach(settingKey => { 
                                    const log = settingsObject[settingKey];
                                    if (typeof log === 'object' && log !== null && (log.timestamp || log.event || log.new_auth || log.new_name || log.new_pw)) {
                                        log.logType = categoryName;
                                        log.settingType = settingKey;
                                        logs.push(log);
                                    }
                                });
                            }
                        });

                        logs.sort((a, b) => {
                            let timeA = 0, timeB = 0;
                            if (typeof a.timestamp === 'string') timeA = new Date(a.timestamp.replace(" ", "T")).getTime();
                            else if (typeof a.timestamp === 'number') timeA = a.timestamp;
                            if (typeof b.timestamp === 'string') timeB = new Date(b.timestamp.replace(" ", "T")).getTime();
                            else if (typeof b.timestamp === 'number') timeB = b.timestamp;
                            return timeB - timeA; 
                        }); 

                        logs.forEach(log => {
                            const entry = document.createElement('div');
                            entry.className = 'full-log-entry';
                            
                            let formattedTime = "시간 정보 없음";
                            if (typeof log.timestamp === 'number' && log.timestamp !== 0) formattedTime = new Date(log.timestamp).toLocaleString('ko-KR');
                            else if (typeof log.timestamp === 'string') formattedTime = new Date(log.timestamp.replace(" ", "T")).toLocaleString('ko-KR');

                            if (log.event) {
                                 entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.event}`;
                            } else if (log.logType === 'change') {
                                 let details = "";
                                 if (log.settingType === 'auth' && log.new_auth) details = `<strong>[인증방식 변경]</strong><br><span style="margin-left: 10px;">${log.new_auth}</span>`;
                                 else if (log.settingType === 'name' && log.new_name) details = `<strong>[이름 변경]</strong><br><span style="margin-left: 10px;">${log.new_name}</span>`;
                                 else if (log.settingType === 'password' && log.new_pw) details = `<strong>[비밀번호 변경]</strong><br><span style="margin-left: 10px;">***</span>`;
                                 else details = `<strong>[${log.settingType} 변경]</strong><br><span style="margin-left: 10px;">${JSON.stringify(log)}</span>`;
                                 
                                 entry.innerHTML = `<strong>[${formattedTime}]</strong><br>${details}`;
                            } else {
                                 entry.innerHTML = `<strong>[${formattedTime}]</strong>: (알 수 없는 로그 데이터)`;
                            }
                            appLogContainer.appendChild(entry);
                        });
                    }
                });
            }

            // 로그인 처리
            function handleLoginSubmit(e) {
                e.preventDefault();
                const usernameInput = document.getElementById('username')?.value.trim();
                const passwordInput = document.getElementById('password')?.value.trim();
                if (!database) return;

                const adminRef = database.ref('admin_pass');
                adminRef.once('value').then((adminSnapshot) => {
                    let loginSuccess = false;
                    let isAdmin = false;
                    let loggedInUserId = null;

                    if (adminSnapshot.exists()) {
                        adminSnapshot.forEach((child) => {
                            const data = child.val();
                            if (data && data.adminId === usernameInput && data.password === passwordInput) {
                                loginSuccess = true; isAdmin = true; loggedInUserId = data.adminId;
                                return true;
                            }
                        });
                    }

                    if (loginSuccess) {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.setItem('userId', loggedInUserId);
                        showMainContent(true, loggedInUserId);
                        return;
                    }

                    const usersRef = database.ref('users');
                    return usersRef.once('value');
                }).then((userSnapshot) => {
                    if (!userSnapshot) return; 
                    let loginSuccess = false;
                    let loggedInUserId = null;

                    if (userSnapshot.exists()) {
                        userSnapshot.forEach((child) => {
                            const data = child.val();
                            if (data && data.username === usernameInput && data.password === passwordInput) {
                                loginSuccess = true; loggedInUserId = child.key;
                                return true;
                            }
                        });
                    }

                    if (loginSuccess) {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('isAdmin', 'false');
                        sessionStorage.setItem('userId', loggedInUserId);
                        showMainContent(false, loggedInUserId);
                    } else {
                        customAlert('아이디 또는 비밀번호가 일치하지 않습니다.');
                    }
                });
            }

            function handleLogout() {
                sessionStorage.removeItem('isLoggedIn');
                sessionStorage.removeItem('isAdmin');
                sessionStorage.removeItem('userId');
                window.location.reload();
            }

            function handleLogView() {
                const currentMainContent = document.getElementById('main-content');
                const currentLogContent = document.getElementById('log-content');
                const userIdToLoad = selectedUserId || sessionStorage.getItem('userId');

                if (userIdToLoad) {
                    if (currentMainContent) currentMainContent.classList.add('hidden');
                    if (currentLogContent) currentLogContent.classList.remove('hidden');
                    
                    const backBtn = document.getElementById('backToMapBtn');
                    backBtn.onclick = () => {
                        currentLogContent.classList.add('hidden');
                        currentMainContent.classList.remove('hidden');
                    };
                    loadAllLogs(userIdToLoad);
                } else {
                    customAlert("사용자를 선택해주세요.");
                }
            }

            function handleNewButtonClick() { window.location.href = 'loge.html'; }

            // 초기화
            function setupInitialEventListeners(addLoginFormListener = true) {
                if (addLoginFormListener && loginForm) {
                    loginForm.addEventListener('submit', handleLoginSubmit);
                }
                const modalClose = document.querySelector('#custom-modal button');
                if (modalClose) modalClose.onclick = () => document.getElementById('custom-modal').style.display = 'none';
                
                // [수정] closeUserInfoButton 이벤트 리스너 연결
                if (closeUserInfoButton) closeUserInfoButton.onclick = closeUserInfo;
            }

            function setupMainUIEventListeners() {
                const logoutBtn = document.getElementById('logoutBtn');
                const logBtn = document.getElementById('logBtn');
                const newBtn = document.getElementById('newBtn');
                
                // ▼▼▼ [추가] 헤더 제목 클릭 리스너 연결 ▼▼▼
                const headerTitle = document.getElementById('header-title');
                if (headerTitle) {
                    headerTitle.onclick = () => window.location.reload();
                }
                // ▲▲▲ [추가 완료] ▲▲▲

                if (logoutBtn) logoutBtn.onclick = handleLogout;
                if (logBtn) logBtn.onclick = handleLogView;
                if (newBtn) newBtn.onclick = handleNewButtonClick;
            }

            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                const userId = sessionStorage.getItem('userId');
                showMainContent(isAdmin, userId);
                setupInitialEventListeners(false);
            } else {
                if (loginContainer) loginContainer.classList.remove('hidden');
                if (mainContent) mainContent.classList.add('hidden');
                if (header) header.classList.add('hidden');
                if (body) body.style.overflow = 'hidden';
                setupInitialEventListeners(true);
            }
        });
    </script>
</body>
</html>
