<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doorlock Admin</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”’</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="indexstyle.css">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2>
        <form id="login-form" onsubmit="handleLoginSubmit(event)">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" style="cursor: pointer;" onclick="showDashboard()">Smart Doorlock</h1>
        <div class="button-group">
            <button id="mapBtn" onclick="hideLogView()" disabled>ì§€ë„</button>
            <button id="logBtn" onclick="showLogView()" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="dbEditBtn" onclick="showDbViewer()">DB ì¡°íšŒ</button>
            <button id="logoutBtn" onclick="confirmLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" onclick="clearMapAndInfo()">X</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="log-modal-content" class="hidden">
        <div class="log-header-bar">
            <button onclick="hideLogView()">â† ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>
            <h2 id="logUserTitle" style="margin:0;">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-layout">
            <div id="doorLockLogs" class="log-box">
                <h3>DoorLock Logs</h3>
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-box">
                <h3>App Logs</h3>
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-viewer-content" class="hidden">
        <div class="db-container">
            <h2>ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ (Interactive Tree)</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 123456)" onkeypress="if(event.key==='Enter') searchUser()">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDbData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <h3 id="result-title">ì‚¬ìš©ì ëª©ë¡:</h3>
            <div id="result-area">
                <div class="message-box">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none'">í™•ì¸</button>
        </div>
    </div>
    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="executeLogout()" style="flex: 1;">í™•ì¸</button>
                <button onclick="document.getElementById('logout-confirm-modal').classList.add('hidden')" style="flex: 1; background-color: #aaa;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================
        // [1] ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
        // ====================================================
        const DOORLOCK_LAT = 37.566826; 
        const DOORLOCK_LNG = 126.9786567;
        const MAX_DISTANCE_KM = 3.0;

        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.firebaseapp.com",
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        let database;
        let map;
        let markers = [];
        let currentPolyline;
        let selectedLogMarker;
        let selectedUserId = null;
        let currentUserLocationLogs = [];

        try {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase SDK missing.");
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized.");
        } catch (e) {
            alert("Firebase Init Error: " + e);
        }


        // ====================================================
        // [2] í•¨ìˆ˜ ì •ì˜ (í˜¸ì´ìŠ¤íŒ…ìœ¼ë¡œ ì–´ë””ì„œë“  í˜¸ì¶œ ê°€ëŠ¥)
        // ====================================================

        function customAlert(msg) {
            const el = document.getElementById('modal-message');
            if(el) {
                el.textContent = msg;
                document.getElementById('custom-modal').style.display = 'flex';
            } else alert(msg);
        }

        // --- í™”ë©´ ì „í™˜ ---
        function showDashboard(isAdmin, loggedInUserId) {
            if (isAdmin === undefined) isAdmin = sessionStorage.getItem('isAdmin') === 'true';
            if (loggedInUserId === undefined) loggedInUserId = sessionStorage.getItem('userId');

            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('log-modal-content').classList.add('hidden');
            document.getElementById('db-viewer-content').classList.add('hidden');
            document.body.style.overflow = 'auto';
            document.body.style.background = 'linear-gradient(135deg, #71b7e6, #9b59b6)';

            document.getElementById('mapBtn').disabled = true;
            document.getElementById('dbEditBtn').disabled = false;
            
            const userListDiv = document.getElementById('userList');
            const userInfoDiv = document.getElementById('userInfo');

            if (isAdmin) {
                userListDiv.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                if (!map && typeof kakao !== 'undefined') {
                    kakao.maps.load(initMap);
                } else if (map) {
                    setTimeout(() => { 
                        map.relayout(); 
                        map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG)); 
                    }, 100);
                }
            } else {
                userListDiv.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                selectedUserId = loggedInUserId;
                if (!map && typeof kakao !== 'undefined') {
                    kakao.maps.load(() => { initMap(); selectUser(loggedInUserId); });
                }
            }
        }

        function showDbViewer() {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('log-modal-content').classList.add('hidden');
            document.getElementById('db-viewer-content').classList.remove('hidden');
            document.body.style.background = '#f9f9f9'; 
            document.getElementById('mapBtn').disabled = false; 
            document.getElementById('dbEditBtn').disabled = true;
            loadAllDbData();
        }

        function showLogView() {
            const userId = selectedUserId || sessionStorage.getItem('userId');
            if (!userId) return customAlert("ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('log-modal-content').classList.remove('hidden');
            document.getElementById('db-viewer-content').classList.add('hidden');
            document.getElementById('mapBtn').disabled = false; 
            document.getElementById('logBtn').disabled = true;
            loadAllLogs(userId);
        }

        function hideLogView() { showDashboard(); }

        function confirmLogout() {
            document.getElementById('logout-confirm-modal').classList.remove('hidden');
        }

        function executeLogout() {
            sessionStorage.clear(); 
            window.location.reload();
        }

        // --- ë¡œê·¸ì¸ ---
        function handleLoginSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('username').value.trim();
            const pw = document.getElementById('password').value.trim();

            database.ref('admin_pass').once('value').then(snap => {
                let isAdmin = false;
                if (snap.exists()) { 
                    snap.forEach(c => { 
                        if (c.val().adminId === id && c.val().password === pw) isAdmin = true; 
                    }); 
                }
                if (isAdmin) {
                    setSession(true, true, id); 
                    showDashboard(true, id);
                } else {
                    database.ref('users').once('value').then(userSnap => {
                        let isUser = false;
                        if (userSnap.exists()) { 
                            userSnap.forEach(c => { if(c.key === id) isUser = true; }); 
                        }
                        if (isUser) { 
                            setSession(true, false, id); 
                            showDashboard(false, id); 
                        } else {
                            customAlert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                        }
                    });
                }
            });
        }

        function setSession(loggedIn, admin, uid) {
            sessionStorage.setItem('isLoggedIn', loggedIn);
            sessionStorage.setItem('isAdmin', admin);
            sessionStorage.setItem('userId', uid);
        }

        // --- ì§€ë„ ë° ë¡œì§ ---
        function initMap() {
            const container = document.getElementById('map');
            if(!container) return;
            map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
            map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
            map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
            drawDoorlockZones();
            if (sessionStorage.getItem('isAdmin') === 'true') loadUserList();
        }

        function drawDoorlockZones() {
            const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
            new kakao.maps.Marker({ position: pos, map: map, title: "Home" });
            [1000, 2000, 3000].forEach((r, i) => {
                const color = ['#FF0000', '#FFA500', '#008000'][i];
                new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeOpacity: 0.8, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1, map: map });
            });
        }

        function clearMapAndInfo() {
            markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
            markers = [];
            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
            if (selectedLogMarker) { selectedLogMarker.setMap(null); if(selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null); }
            document.getElementById('infoArea').innerHTML = '';
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('logBtn').disabled = true;
            if (sessionStorage.getItem('isAdmin') === 'true') selectedUserId = null;
        }

        function loadUserList() {
            database.ref('users').once('value').then(snap => {
                const list = document.getElementById('userList');
                while (list.childNodes.length > 2) { list.removeChild(list.lastChild); }
                snap.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'user';
                    div.textContent = c.key;
                    div.onclick = () => selectUser(c.key);
                    list.appendChild(div);
                });
            });
        }

        function selectUser(userId) {
            clearMapAndInfo();
            selectedUserId = userId;
            document.getElementById('logBtn').disabled = false;
            const infoArea = document.getElementById('infoArea');
            document.getElementById('userInfo').classList.remove('hidden');
            infoArea.innerHTML = `
                <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
                <div class="filter-group">
                    <button onclick="renderLocationLogs(false, this)" class="filter-btn active">ì „ì²´ ê²½ë¡œ</button>
                    <button onclick="renderLocationLogs(true, this)" class="filter-btn">3km ì´ë‚´</button>
                </div>
                <div class="log-list">Loading...</div>
            `;
            database.ref('users/' + userId + '/location_logs').once('value').then(snap => {
                currentUserLocationLogs = [];
                if (snap.exists()) {
                    snap.forEach(c => currentUserLocationLogs.push(c.val()));
                    currentUserLocationLogs.sort((a, b) => {
                        const ta = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                        const tb = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                        return tb - ta;
                    });
                }
                renderLocationLogs(false);
            });
        }

        window.renderLocationLogs = function(filterRange, btn) {
            if(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            const listDiv = document.querySelector('.log-list');
            if (!listDiv) return;
            listDiv.innerHTML = '';
            
            markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
            markers = [];
            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }

            if (currentUserLocationLogs.length === 0) { listDiv.innerHTML = 'ê¸°ë¡ ì—†ìŒ'; return; }

            let path = [];
            const bounds = new kakao.maps.LatLngBounds();
            bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
            let count = 0;

            currentUserLocationLogs.forEach(pos => {
                if (!pos.latitude || !pos.longitude) return;
                const lat = parseFloat(pos.latitude);
                const lng = parseFloat(pos.longitude);
                const dist = getDist(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                if (filterRange && dist > MAX_DISTANCE_KM) return;

                const item = document.createElement('div');
                item.className = 'log-entry';
                const time = pos.timestamp ? new Date(String(pos.timestamp).replace(" ", "T")).toLocaleString() : '-';
                item.innerHTML = `<small>${time}</small><br>ê±°ë¦¬: <b>${dist.toFixed(2)}km</b>`;
                item.onclick = () => { 
                    if(map) map.panTo(new kakao.maps.LatLng(lat, lng)); 
                    showSingleLogMarker(lat, lng, time, dist);
                };
                listDiv.appendChild(item);

                if (count < 50) {
                    const p = new kakao.maps.LatLng(lat, lng);
                    path.push(p);
                    bounds.extend(p);
                    const img = document.createElement('img');
                    img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                    img.className = 'custom-marker-dot';
                    const marker = new kakao.maps.CustomOverlay({ position: p, content: img, yAnchor: 0.5 });
                    marker.setMap(map);
                    markers.push(marker);
                    count++;
                }
            });

            if (path.length > 0) {
                currentPolyline = new kakao.maps.Polyline({
                    path: path, strokeWeight: 4, strokeColor: '#FF00FF', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                });
                map.setBounds(bounds);
            }
        }

        function showSingleLogMarker(lat, lng, time, dist) {
            if (selectedLogMarker) {
                selectedLogMarker.setMap(null);
                if(selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null);
            }
            const pos = new kakao.maps.LatLng(lat, lng);
            const content = `<div class="custom-overlay-info"><strong>${time}</strong><br>ê±°ë¦¬: ${dist.toFixed(2)}km</div>`;
            const infoBox = new kakao.maps.CustomOverlay({ content: content, position: pos, yAnchor: 2.5, zIndex: 5 });
            infoBox.setMap(map);
            const img = document.createElement('img');
            img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
            img.className = 'custom-marker-pin';
            const marker = new kakao.maps.CustomOverlay({ position: pos, content: img, yAnchor: 1 });
            marker.setMap(map);
            selectedLogMarker = marker;
            selectedLogMarker.infoBox = infoBox;
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function loadAllLogs(userId) {
            const doorDiv = document.querySelector('#doorLockLogs .log-entries');
            const appDiv = document.querySelector('#appLogs .log-entries');
            document.getElementById('logUserTitle').textContent = `${userId} ì „ì²´ ë¡œê·¸`;
            doorDiv.innerHTML = 'Loading...'; appDiv.innerHTML = 'Loading...';

            // 1. ë„ì–´ë½ ë¡œê·¸
            database.ref('doorlock_logs/' + userId).once('value').then(snap => {
                doorDiv.innerHTML = '';
                if (!snap.exists()) { doorDiv.innerHTML = 'ì—†ìŒ'; return; }
                const logs = [];
                snap.forEach(c => logs.push(c.val()));
                logs.sort((a, b) => {
                    const timeA = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                    const timeB = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                    return timeB - timeA;
                });
                logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'full-log-entry';
                    let t = log.timestamp ? String(log.timestamp).replace("T", " ") : 'ì‹œê°„ ì—†ìŒ';
                    div.innerHTML = `<strong>${t}</strong><br>ë°©ì‹: ${log.method || '-'}<br>ìƒíƒœ: ${log.status || '-'}`;
                    doorDiv.appendChild(div);
                });
            });

            // 2. ì•± ë¡œê·¸ (ë²”ìš© êµ¬ì¡°)
            database.ref('users/' + userId + '/app_logs').once('value').then(snap => {
                appDiv.innerHTML = '';
                if (!snap.exists()) { appDiv.innerHTML = 'ì—†ìŒ'; return; }
                const logs = [];
                snap.forEach(categorySnap => {
                    const catData = categorySnap.val();
                    if (typeof catData === 'object' && catData !== null) {
                        Object.keys(catData).forEach(key => {
                            const detail = catData[key];
                            if(typeof detail === 'object' && detail !== null) {
                                const logItem = { ...detail, _cat: categorySnap.key, _type: key };
                                logs.push(logItem);
                            }
                        });
                    }
                });
                logs.sort((a, b) => {
                    const timeA = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                    const timeB = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                    return timeB - timeA;
                });
                if(logs.length === 0) appDiv.innerHTML = 'í‘œì‹œí•  í˜•ì‹ì˜ ë¡œê·¸ ì—†ìŒ';
                logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'full-log-entry';
                    let t = log.timestamp ? String(log.timestamp).replace("T", " ") : 'ì‹œê°„ ì—†ìŒ';
                    let msg = "";
                    if(log.new_auth) msg = `ì¸ì¦ ë³€ê²½: ${log.new_auth}`;
                    else if(log.new_name) msg = `ì´ë¦„ ë³€ê²½: ${log.new_name}`;
                    else if(log.new_pw) msg = `ë¹„ë²ˆ ë³€ê²½`;
                    else if(log.event) msg = `ì´ë²¤íŠ¸: ${log.event}`;
                    else msg = JSON.stringify(log);
                    div.innerHTML = `<div style="color:#28a745; font-size:12px;">[${t}] (${log._cat}/${log._type})</div><div>${msg}</div>`;
                    appDiv.appendChild(div);
                });
            });
        }

        // --- DB ì¡°íšŒ ---
        window.loadAllDbData = function() {
            const resultArea = document.getElementById('result-area');
            document.getElementById('result-title').textContent = "ì „ì²´ ì‚¬ìš©ì ëª©ë¡ (users):";
            resultArea.innerHTML = '<div class="message-box">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            document.getElementById('search-input').value = '';
            database.ref('users').once('value').then(snap => {
                if(snap.exists()) renderGrid(snap.val());
                else resultArea.innerHTML = '<div class="message-box">ë°ì´í„° ì—†ìŒ</div>';
            });
        };

        window.searchUser = function() {
            const userId = document.getElementById('search-input').value.trim();
            if(!userId) return alert("ID ì…ë ¥");
            const resultArea = document.getElementById('result-area');
            document.getElementById('result-title').textContent = `'${userId}' ê²€ìƒ‰ ê²°ê³¼:`;
            resultArea.innerHTML = '<div class="message-box">ê²€ìƒ‰ ì¤‘...</div>';
            database.ref('users/' + userId).once('value').then(snap => {
                if(snap.exists()) { const wrap = {}; wrap[userId] = snap.val(); renderGrid(wrap); }
                else resultArea.innerHTML = '<div class="message-box">ê²°ê³¼ ì—†ìŒ</div>';
            });
        };

        function renderGrid(data) {
            const resultArea = document.getElementById('result-area');
            let html = `<div class="grid-wrapper"><table class="styled-table"><thead><tr><th style="width:150px;">ID</th><th>Data Tree</th></tr></thead><tbody>`;
            for (const [id, val] of Object.entries(data)) {
                const treeHtml = createFirebaseView(val, 0);
                html += `<tr><td style="vertical-align:top; font-weight:bold; color:#007bff;">${id}</td><td><div class="firebase-view">${treeHtml}</div></td></tr>`;
            }
            html += `</tbody></table></div>`;
            resultArea.innerHTML = html;
        }

        function createFirebaseView(data, depth) {
            let html = '';
            const indent = '<span class="fv-indent"></span>'.repeat(depth);
            if (typeof data === 'object' && data !== null) {
                for (const [key, value] of Object.entries(data)) {
                    const isObj = typeof value === 'object' && value !== null;
                    if (isObj) {
                        const isExpanded = depth < 2; 
                        const arrow = isExpanded ? 'â–¼' : 'â–¶';
                        const rotate = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
                        const cls = isExpanded ? '' : 'fv-hidden';
                        html += `<div class="fv-item">${indent}<div class="fv-key-box" onclick="toggleNode(this)"><span class="fv-arrow" style="transform:${rotate}">${arrow}</span><span class="fv-key">${key}</span></div><div class="fv-children ${cls}">${createFirebaseView(value, depth + 1)}</div></div>`;
                    } else {
                        html += `<div class="fv-item">${indent}<span style="display:inline-block;width:16px;"></span><span class="fv-key">${key}:</span> ${formatValue(value)}</div>`;
                    }
                }
            } else {
                html += `<div class="fv-item">${indent}${formatValue(data)}</div>`;
            }
            return html;
        }

        window.toggleNode = function(el) {
            const child = el.nextElementSibling;
            const arrow = el.querySelector('.fv-arrow');
            if(child) {
                if(child.classList.contains('fv-hidden')) {
                    child.classList.remove('fv-hidden'); arrow.textContent = 'â–¼'; arrow.style.transform = 'rotate(0deg)';
                } else {
                    child.classList.add('fv-hidden'); arrow.textContent = 'â–¶'; arrow.style.transform = 'rotate(-90deg)';
                }
            }
        };

        function formatValue(v) {
            if (typeof v === 'string') return `<span class="fv-string">"${v}"</span>`;
            if (typeof v === 'number') return `<span class="fv-number">${v}</span>`;
            if (v === true || v === false) return `<span class="fv-boolean">${v}</span>`;
            return v;
        }


        // ====================================================
        // [3] ì´ˆê¸° ì‹¤í–‰ (DOMContentLoaded)
        // ====================================================
        document.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                const userId = sessionStorage.getItem('userId');
                showDashboard(isAdmin, userId);
            } else {
                document.getElementById('login-container').classList.remove('hidden');
            }
        });

    </script>
</body>
</html>
