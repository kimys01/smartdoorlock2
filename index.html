<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doorlock Admin</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîí</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="indexstyle.css">
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label>ÏïÑÏù¥Îîî</label>
                <input type="text" id="username" required>
            </div>
            <div class="input-group">
                <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Î°úÍ∑∏Ïù∏</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" style="cursor:pointer;">Smart Doorlock</h1>
        <div class="button-group">
            <button id="mapBtn" disabled>ÏßÄÎèÑ</button>
            <button id="logBtn" disabled>Î°úÍ∑∏ Î≥¥Í∏∞</button>
            <button id="dbEditBtn">DB Ï°∞Ìöå</button>
            <button id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn">X</button>
                </div>
                <div id="infoArea">ÏÇ¨Ïö©ÏûêÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
            </div>
            <div id="userList"><h2>User List</h2></div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="log-modal-content" class="hidden">
        <div class="log-header-bar">
            <button id="backToMapBtn">‚Üê ÏßÄÎèÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
            <h2 id="logUserTitle" style="margin:0;">Ï†ÑÏ≤¥ Î°úÍ∑∏</h2>
        </div>
        <div class="log-layout">
            <div id="doorLockLogs" class="log-box">
                <h3>DoorLock Logs</h3>
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-box">
                <h3>App Logs</h3>
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none'">ÌôïÏù∏</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Ï†ÑÏó≠ Î≥ÄÏàò
            const DOORLOCK_LAT = 37.566826; 
            const DOORLOCK_LNG = 126.9786567;
            const MAX_DISTANCE_KM = 3.0;
            
            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            let database, map;
            let markers = [], currentPolyline, selectedLogMarker;
            let selectedUserId = null, currentUserLocationLogs = [];

            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch(e) { alert("Firebase Error: " + e); }

            // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').onclick = handleLogout;
            document.getElementById('header-title').onclick = () => location.reload();
            
            document.getElementById('dbEditBtn').onclick = () => window.location.href = 'loge.html'; // ÌéòÏù¥ÏßÄ Ïù¥Îèô
            
            document.getElementById('mapBtn').onclick = hideLogView;
            document.getElementById('backToMapBtn').onclick = hideLogView;
            document.getElementById('logBtn').onclick = showLogView;
            document.getElementById('closeUserInfoBtn').onclick = clearMapAndInfo;

            // Ï¥àÍ∏∞ Ïã§Ìñâ
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                showDashboard(isAdmin, sessionStorage.getItem('userId'));
            } else {
                document.getElementById('login-container').classList.remove('hidden');
            }

            // Ìï®Ïàò Ï†ïÏùò
            function customAlert(msg) {
                document.getElementById('modal-message').textContent = msg;
                document.getElementById('custom-modal').style.display = 'flex';
            }

            function showDashboard(isAdmin, uid) {
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.body.style.overflow = 'auto';

                if (isAdmin) {
                    document.getElementById('userList').classList.remove('hidden');
                    document.getElementById('userInfo').classList.add('hidden');
                    kakao.maps.load(initMap);
                } else {
                    document.getElementById('userList').classList.add('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');
                    selectedUserId = uid;
                    kakao.maps.load(() => { initMap(); selectUser(uid); });
                }
            }

            function handleLogin(e) {
                e.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pw = document.getElementById('password').value.trim();

                database.ref('admin_pass').once('value').then(snap => {
                    let isAdmin = false;
                    if (snap.exists()) snap.forEach(c => { if(c.val().adminId===id && c.val().password===pw) isAdmin=true; });
                    
                    if (isAdmin) {
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.setItem('userId', id);
                        showDashboard(true, id);
                    } else {
                        database.ref('users').once('value').then(uSnap => {
                            let isUser = false;
                            if(uSnap.exists()) uSnap.forEach(c => { if(c.key===id) isUser=true; });
                            if(isUser) {
                                sessionStorage.setItem('isLoggedIn', 'true');
                                sessionStorage.setItem('isAdmin', 'false');
                                sessionStorage.setItem('userId', id);
                                showDashboard(false, id);
                            } else {
                                customAlert('Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ Î∂àÏùºÏπò');
                            }
                        });
                    }
                });
            }

            function handleLogout() {
                sessionStorage.clear();
                window.location.reload();
            }

            function initMap() {
                const container = document.getElementById('map');
                map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
                map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                
                // ÎèÑÏñ¥ÎùΩ ÎßàÏª§ & Ïõê
                const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
                new kakao.maps.Marker({ position: pos, map: map });
                [1000, 2000, 3000].forEach((r, i) => {
                    const color = ['#FF0000', '#FFA500', '#008000'][i];
                    new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeOpacity: 0.8, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1, map: map });
                });

                if(sessionStorage.getItem('isAdmin') === 'true') loadUserList();
            }

            function loadUserList() {
                database.ref('users').once('value').then(snap => {
                    const list = document.getElementById('userList');
                    while(list.childNodes.length > 1) list.removeChild(list.lastChild);
                    snap.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'user';
                        div.textContent = c.key;
                        div.onclick = () => selectUser(c.key);
                        list.appendChild(div);
                    });
                });
            }

            function selectUser(uid) {
                clearMapAndInfo();
                selectedUserId = uid;
                document.getElementById('logBtn').disabled = false;
                document.getElementById('userInfo').classList.remove('hidden');
                const infoArea = document.getElementById('infoArea');
                
                infoArea.innerHTML = `
                    <div style="margin-bottom:10px;"><strong>ID:</strong> ${uid}</div>
                    <div class="filter-group">
                        <button onclick="renderLocLogs('${uid}', false)" class="filter-btn active">Ï†ÑÏ≤¥</button>
                        <button onclick="renderLocLogs('${uid}', true)" class="filter-btn">3kmÏù¥ÎÇ¥</button>
                    </div>
                    <div class="log-list">Loading...</div>
                `;
                
                // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎßåÎì§Ïñ¥ Îëî renderLocLogs Ìò∏Ï∂úÏùÑ ÏúÑÌï¥ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                database.ref(`users/${uid}/location_logs`).once('value').then(snap => {
                    currentUserLocationLogs = [];
                    if(snap.exists()) snap.forEach(c => currentUserLocationLogs.push(c.val()));
                    currentUserLocationLogs.sort((a,b) => {
                        const ta = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                        const tb = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                        return tb - ta;
                    });
                    window.renderLocLogs(uid, false); // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
                });
            }

            // ÌïÑÌÑ∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú Ìò∏Ï∂úÎê† Ï†ÑÏó≠ Ìï®Ïàò ÏÑ§Ï†ï
            window.renderLocLogs = function(uid, filter) {
                const list = document.querySelector('.log-list');
                if(!list) return;
                list.innerHTML = '';
                
                // ÎßàÏª§ Ï¥àÍ∏∞Ìôî
                markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
                markers = [];
                if(currentPolyline) { currentPolyline.setMap(null); currentPolyline=null; }
                if(selectedLogMarker) { selectedLogMarker.setMap(null); if(selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null); }

                if(currentUserLocationLogs.length === 0) { list.innerHTML = 'Í∏∞Î°ù ÏóÜÏùå'; return; }

                let path = [];
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                let count = 0;

                currentUserLocationLogs.forEach(pos => {
                    if(!pos.latitude || !pos.longitude) return;
                    const lat = parseFloat(pos.latitude), lng = parseFloat(pos.longitude);
                    const dist = getDist(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                    if(filter && dist > MAX_DISTANCE_KM) return;

                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    const t = pos.timestamp ? String(pos.timestamp).replace("T", " ") : '-';
                    div.innerHTML = `<small>${t}</small><br>Í±∞Î¶¨: <b>${dist.toFixed(2)}km</b>`;
                    div.onclick = () => { 
                        map.panTo(new kakao.maps.LatLng(lat, lng));
                        showMarkerInfo(lat, lng, t, dist);
                    };
                    list.appendChild(div);

                    if(count < 50) {
                        const p = new kakao.maps.LatLng(lat, lng);
                        path.push(p); bounds.extend(p);
                        const img = document.createElement('img');
                        img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                        img.className = 'custom-marker-dot';
                        const m = new kakao.maps.CustomOverlay({ position: p, content: img, yAnchor: 0.5 });
                        m.setMap(map);
                        markers.push(m);
                        count++;
                    }
                });

                if(path.length > 0) {
                    currentPolyline = new kakao.maps.Polyline({ path: path, strokeWeight: 4, strokeColor: '#FF00FF', strokeOpacity: 0.8, strokeStyle: 'solid', map: map });
                    map.setBounds(bounds);
                }
            };

            function showMarkerInfo(lat, lng, time, dist) {
                if(selectedLogMarker) { selectedLogMarker.setMap(null); if(selectedLogMarker.infoBox) selectedLogMarker.infoBox.setMap(null); }
                const pos = new kakao.maps.LatLng(lat, lng);
                const content = `<div style="padding:5px; background:white; border:1px solid #ccc; font-size:12px;">${time}<br>${dist.toFixed(2)}km</div>`;
                const info = new kakao.maps.CustomOverlay({ content: content, position: pos, yAnchor: 2.5, zIndex: 5 });
                info.setMap(map);
                
                const img = document.createElement('img');
                img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
                img.className = 'custom-marker-pin';
                const marker = new kakao.maps.CustomOverlay({ position: pos, content: img, yAnchor: 1 });
                marker.setMap(map);
                
                selectedLogMarker = marker;
                selectedLogMarker.infoBox = info;
            }

            function clearMapAndInfo() {
                markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
                markers = [];
                if(currentPolyline) { currentPolyline.setMap(null); currentPolyline=null; }
                document.getElementById('infoArea').innerHTML = '';
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('logBtn').disabled = true;
                if(sessionStorage.getItem('isAdmin') === 'true') selectedUserId = null;
            }

            function getDist(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2-lat1) * Math.PI/180;
                const dLon = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            // Î°úÍ∑∏ Î≥¥Í∏∞ ÌôîÎ©¥
            function showLogView() {
                if (!selectedUserId) return customAlert("ÏÇ¨Ïö©Ïûê ÏÑ†ÌÉù ÌïÑÏöî");
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('log-modal-content').classList.remove('hidden');
                document.getElementById('mapBtn').disabled = false;
                document.getElementById('logBtn').disabled = true;
                
                loadAllLogs(selectedUserId);
            }

            function hideLogView() {
                document.getElementById('log-modal-content').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('mapBtn').disabled = true;
                document.getElementById('logBtn').disabled = false;
            }

            function loadAllLogs(uid) {
                const doorDiv = document.querySelector('#doorLockLogs .log-entries');
                const appDiv = document.querySelector('#appLogs .log-entries');
                document.getElementById('logUserTitle').textContent = `${uid} Ï†ÑÏ≤¥ Î°úÍ∑∏`;
                doorDiv.innerHTML = 'Loading...'; appDiv.innerHTML = 'Loading...';

                // ÎèÑÏñ¥ÎùΩ
                database.ref('doorlock_logs/' + uid).once('value').then(snap => {
                    doorDiv.innerHTML = '';
                    if(!snap.exists()) { doorDiv.innerHTML = 'Í∏∞Î°ù ÏóÜÏùå'; return; }
                    const arr = [];
                    snap.forEach(c => arr.push(c.val()));
                    arr.sort((a,b) => {
                         const ta = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                         const tb = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                         return tb - ta;
                    });
                    arr.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'full-log-entry';
                        let t = log.timestamp ? String(log.timestamp).replace("T", " ") : '-';
                        div.innerHTML = `<strong>[${t}]</strong><br>Î∞©Ïãù: ${log.method}<br>ÏÉÅÌÉú: ${log.status}`;
                        doorDiv.appendChild(div);
                    });
                });

                // Ïï± Î°úÍ∑∏ (Î≤îÏö©)
                database.ref('users/' + uid + '/app_logs').once('value').then(snap => {
                    appDiv.innerHTML = '';
                    if(!snap.exists()) { appDiv.innerHTML = 'Í∏∞Î°ù ÏóÜÏùå'; return; }
                    const logs = [];
                    snap.forEach(cat => {
                        const val = cat.val();
                        if(typeof val==='object' && val!==null) {
                            Object.keys(val).forEach(k => {
                                const d = val[k];
                                if(typeof d==='object' && d!==null) logs.push({...d, _cat:cat.key, _type:k});
                            });
                        }
                    });
                    logs.sort((a,b) => {
                         const ta = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                         const tb = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                         return tb - ta;
                    });
                    if(logs.length===0) appDiv.innerHTML = 'ÌòïÏãù Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå';
                    logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'full-log-entry';
                        let t = log.timestamp ? String(log.timestamp).replace("T", " ") : '-';
                        let msg = log.new_auth ? `Ïù∏Ï¶ùÎ≥ÄÍ≤Ω: ${log.new_auth}` : (log.event || JSON.stringify(log));
                        div.innerHTML = `<div style="color:#28a745; font-size:12px;">[${t}]</div><div>${msg}</div>`;
                        appDiv.appendChild(div);
                    });
                });
            }

        });
    </script>
</body>
</html>
