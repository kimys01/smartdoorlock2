<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone Project</title>

    <!-- Google Fonts Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- í†µí•© CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            /* display, justify-content, align-items removed to allow normal flow */
            height: 100vh;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            padding-top: 70px; /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
            /* overflow: hidden; /* ë¡œê·¸ì¸ í›„ ìŠ¤í¬ë¡¤ í•„ìš” */
            transition: background-color 0.3s ease; /* [ì¶”ê°€] ë°°ê²½ìƒ‰ ë³€ê²½ ì‹œ ë¶€ë“œëŸ½ê²Œ */
        }

        .hidden { display: none !important; }

        /* ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ */
        #login-container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: absolute; /* í™”ë©´ ì¤‘ì•™ ë°°ì¹˜ */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #login-container h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #71b7e6;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #login-container button:hover {
            opacity: 0.9;
        }

        .extra-links {
            margin-top: 20px;
            font-size: 14px;
        }
        .extra-links a {
            color: #555;
            text-decoration: none;
        }
        .extra-links a:hover {
            text-decoration: underline;
            color: #71b7e6;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        #header {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            padding: 10px 20px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 500;
        }
        #header h1 { margin: 0; font-size: 24px; }

        /* í—¤ë” ë²„íŠ¼ ê·¸ë£¹ */
        #header .button-group {
            display: flex;
            gap: 10px;
        }

        /* í—¤ë” ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ìƒˆ ë²„íŠ¼ í¬í•¨) */
        #logoutBtn, #logBtn, #newBtn {
            padding: 8px 15px;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        /* ê° ë²„íŠ¼ ìƒ‰ìƒ */
        #logoutBtn { background-color: #dc3545; } /* ë¡œê·¸ì•„ì›ƒ: ë¹¨ê°„ìƒ‰ */
        #logBtn { background-color: #007bff; } /* ë¡œê·¸ ë³´ê¸°: íŒŒë€ìƒ‰ */
        #newBtn { background-color: #ffc107; } /* ìƒˆ ë²„íŠ¼: ì£¼í™©ìƒ‰ */


        /* ê° ë²„íŠ¼ hover íš¨ê³¼ */
        #logoutBtn:hover { background-color: #c82333; }
        #logBtn:hover { background-color: #0056b3; }
        #newBtn:hover { background-color: #e0a800; }


        /* ë¡œê·¸ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        #logBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        #main-content {
            display: flex; /* ë¡œê·¸ì¸ ì„±ê³µ í›„ flexë¡œ ë³€ê²½ë¨ */
            padding: 10px;
            gap: 20px;
            width: 100%;
            height: calc(100vh - 70px); /* í—¤ë” ë†’ì´ ì œì™¸ */
            /* background-color: #fff; */ /* [ì‚­ì œ] bodyì˜ ë°°ê²½ìƒ‰ì„ ë”°ë¦„ */
            overflow: hidden; /* ìì‹ ìš”ì†Œë“¤ì´ ë„˜ì¹˜ì§€ ì•Šë„ë¡ */
        }


        #sidebar {
            display: flex;
            flex-direction: column;
            width: 12.5%; /* ê°€ë¡œ í­ ìœ ì§€ */
            gap: 15px;
            height: 100%;
        }

        #userList, #userInfo, #mapArea {
            /* border: 1px solid #ccc; */ /* [ìˆ˜ì •] í…Œë‘ë¦¬ ì œê±° */
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* [ì¶”ê°€] ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
            padding: 15px;
            border-radius: 8px;
            background-color: #fff; /* [ìœ ì§€] í°ìƒ‰ ë°°ê²½ */
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }

        #userList {
            overflow-y: auto;
            flex-grow: 4; /* 6:4 ë¹„ìœ¨ì„ ìœ„í•´ 4ë¡œ ì„¤ì • */
            flex-basis: 0; /* 6:4 ë¹„ìœ¨ì„ ìœ„í•´ ì¶”ê°€ */
            min-height: 0; /* flex ìì‹ ìš”ì†Œì˜ overflow-y ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ */
        }
        
        /* --- [CSS ìˆ˜ì •] --- */
        #userInfo {
            /* overflow-y: auto; */ /* [ìˆ˜ì •] ìŠ¤í¬ë¡¤ ì œê±° */
            overflow: hidden; /* [ìˆ˜ì •] ë‚´ë¶€ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ hidden ì²˜ë¦¬ */
            /* height: 60%; */ /* [ì‚­ì œ] flex-growë¡œ ëŒ€ì²´ */
            flex-grow: 6; /* [ì¶”ê°€] 6:4 ë¹„ìœ¨ì„ ìœ„í•´ 6ìœ¼ë¡œ ì„¤ì • */
            flex-basis: 0; /* [ì¶”ê°€] 6:4 ë¹„ìœ¨ì„ ìœ„í•´ ì¶”ê°€ */
            min-height: 0; /* [ì¶”ê°€] 6:4 ë¹„ìœ¨ì„ ìœ„í•´ ì¶”ê°€ */
            flex-shrink: 0; /* í¬ê¸° ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ */
            
            /* [ìœ ì§€] Flexbox ë ˆì´ì•„ì›ƒ ì ìš© */
            display: flex;
            flex-direction: column;
        }
        /* --- [CSS ìˆ˜ì • ì™„ë£Œ] --- */

        #mapArea { flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */ }

        .user {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .user:hover { background-color: #f0f0f0; }

        /* --- [CSS ì¶”ê°€] ì‚¬ìš©ì ì •ë³´ ì˜ì—­ Flexbox ë ˆì´ì•„ì›ƒ --- */
        #infoArea {
            display: flex;
            flex-direction: column;
            flex-grow: 1; /* userInfoì—ì„œ í—¤ë”ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê³µê°„ ì±„ìš°ê¸° */
            overflow: hidden; /* ì´ ì˜ì—­ ìì²´ëŠ” ìŠ¤í¬ë¡¤ë˜ì§€ ì•ŠìŒ */
            min-height: 0; /* flex ìì‹ì˜ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì¤‘ìš” ì†ì„± */
        }

        /* JSë¡œ ì¶”ê°€ë˜ëŠ” pì™€ h3ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ ì„¤ì • */
        #infoArea p, #infoArea h3 {
            flex-shrink: 0;
        }

        #infoArea h3 {
            margin-top: 10px; /* ì œëª© ìœ„ ì—¬ë°± */
            margin-bottom: 5px; /* ëª©ë¡ ìœ„ ì—¬ë°± */
            font-weight: 600; /* [ì¶”ê°€] */
            color: #555; /* [ì¶”ê°€] */
        }

        /* JSë¡œ ì¶”ê°€ë˜ëŠ” ë¡œê·¸ ëª©ë¡ div */
        .log-list {
            flex-grow: 1; /* infoAreaì—ì„œ p, h3ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ê³µê°„ ì±„ìš°ê¸° */
            overflow-y: auto; /* <-- â˜…â˜…â˜… ìŠ¤í¬ë¡¤ì„ ì´ ìš”ì†Œì—ë§Œ ì ìš© */
            min-height: 0; /* flex ìì‹ì˜ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ì¤‘ìš” ì†ì„± */
        }
        /* --- [CSS ì¶”ê°€ ì™„ë£Œ] --- */

        /* --- [CSS ìˆ˜ì •] ê° ì°½ì˜ ì œëª© ìŠ¤íƒ€ì¼ --- */
        #userList h2, #mapArea h2 {
            font-weight: 600;
            color: #9b59b6; /* Gradient purple */
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px; 
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px; /* í—¤ë” ì•„ë˜ ì—¬ë°± */
            border-bottom: 1px solid #eee; /* [ì¶”ê°€] */
            padding-bottom: 10px; /* [ì¶”ê°€] */
        }

        .info-header h2 {
            font-weight: 600;
            color: #9b59b6; /* Gradient purple */
            margin: 0; /* Reset margin */
        }
        /* --- [CSS ìˆ˜ì • ì™„ë£Œ] --- */


         /* ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
         #closeUserInfoBtn {
             background: none;
             border: none;
             font-size: 1.2rem;
             cursor: pointer;
             color: #6c757d; /* íšŒìƒ‰ */
             padding: 0 5px; /* í´ë¦­ ì˜ì—­ í™•ë³´ */
         }
         #closeUserInfoBtn:hover {
             color: #dc3545; /* ë¹¨ê°„ìƒ‰ */
         }

        #map {
            width: 100%;
            height: calc(100% - 40px); /* ì œëª© ë†’ì´ ë“±ì„ ê³ ë ¤ */
            margin-top: 10px;
        }
        
        /* [ì¶”ê°€] ì§€ë„ ì•„ë˜ ì„¤ëª… í…ìŠ¤íŠ¸ */
        #mapArea p#mapUser {
            font-size: 14px;
            color: #777;
            margin-top: 5px;
        }

        .log-entry {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
            line-height: 1.5;
        }
        .log-entry:hover {
            background-color: #e9ecef;
        }

        /* ë¡œê·¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        #log-content {
            width: 100%;
            height: calc(100vh - 70px);
            padding: 20px;
            display: flex; /* ë¡œë“œ ì‹œ flexë¡œ ë³€ê²½ë¨ */
            flex-direction: column;
            gap: 20px;
            background-color: #fff;
            position: fixed; /* ë©”ì¸ ì»¨í…ì¸  ìœ„ì— ë®ì–´ì”Œìš°ë„ë¡ */
            top: 70px; /* í—¤ë” ì•„ë˜ */
            left: 0;
            z-index: 600; /* ë©”ì¸ ì»¨í…ì¸ ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
            box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        #backToMapBtn {
            padding: 8px 15px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #backToMapBtn:hover {
            background-color: #e0e0e0;
        }

        .log-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden; /* ë‚´ë¶€ ìŠ¤í¬ë¡¤ì€ ê° ì„¹ì…˜ì—ì„œ ì²˜ë¦¬ */
        }

        .log-section {
            width: 50%;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .log-section h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .log-section .log-entries {
            overflow-y: auto;
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€í•˜ë©° ìŠ¤í¬ë¡¤ */
        }

        .full-log-entry {
            padding: 8px 5px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* ì´ˆê¸° ìƒíƒœ ìˆ¨ê¹€ */
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            text-align: center;
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .modal-content button {
            padding: 10px 20px;
            background-color: #71b7e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* --- ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´(ì •ë³´ì°½) ìŠ¤íƒ€ì¼ --- */
        .custom-overlay-info {
            padding: 5px 10px;
            font-size: 12px;
            text-align: left;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid #ccc;
        }

        /* --- [ì¶”ê°€] ì»¤ìŠ¤í…€ ë§ˆì»¤ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ --- */
        .custom-marker-pin {
            width: 32px; /* ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° */
            height: 35px; /* ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° */
            transform: scale(1.5); /* 50% í¬ê²Œ */
            transform-origin: bottom center; /* í•€ì˜ í•˜ë‹¨ì„ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€ */
        }

        .custom-marker-dot {
            width: 12px; /* ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° */
            height: 12px; /* ì›ë³¸ ì´ë¯¸ì§€ í¬ê¸° */
            transform: scale(1.8); /* 80% í¬ê²Œ */
            transform-origin: center center; /* ì ì˜ ì¤‘ì‹¬ì„ ê¸°ì¤€ìœ¼ë¡œ í™•ëŒ€ */
        }
    </style>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ìˆœì„œ ë³€ê²½: SDKë“¤ì„ <head>ë¡œ ì´ë™ -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

</head>
<body>

    <!-- ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="login-container">
        <h2>Admin Login</h2> <!-- ì œëª© ë³€ê²½ -->
        <form id="login-form">
            <div class="input-group">
                <label for="username">ê´€ë¦¬ì ì•„ì´ë””</label> <!-- ë¼ë²¨ ë³€ê²½ -->
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label> <!-- ë¼ë²¨ ë³€ê²½ -->
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
        <div class="extra-links">
            <a href="#">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a>
        </div>
    </div>

    <!-- í—¤ë” (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
    <div id="header" class="hidden">
        <h1>ìº¡ìŠ¤í†¤ í”„ë¡œì íŠ¸</h1>
        <div class="button-group">
            <button id="logBtn" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="newBtn">DB í¸ì§‘</button> <!-- ë²„íŠ¼ ì´ë¦„ ë³€ê²½ -->
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>ì‚¬ìš©ì ì •ë³´</h2>
                    <button id="closeUserInfoBtn">X</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>ì‚¬ìš©ì ëª©ë¡</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>ìœ„ì¹˜ ì¶”ì </h2>
            <p id="mapUser">ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ ì´ë™ ê²½ë¡œê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
            <div id="map" style="height: 80vh;"></div> <!-- ì§€ë„ ë†’ì´ ì¡°ì • -->
        </div>
    </div>

    <!-- ë¡œê·¸ ì½˜í…ì¸  (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
    <div id="log-content" class="hidden">
        <div class="log-header">
            <button id="backToMapBtn">&larr; ì§€ë„ë¡œ ëŒì•„ê°€ê¸°</button>
            <h2 id="logUserTitle">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section">
                <h3>ë„ì–´ë½ ë¡œê·¸</h3>
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <h3>ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸</h3>
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Alert ëŒ€ì²´) -->
    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">í™•ì¸</button> <!-- í´ë¦­ ì‹œ ìˆ¨ê¸°ë„ë¡ ìˆ˜ì • -->
        </div>
    </div>

    <!-- ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸: <body> ë§¨ ëìœ¼ë¡œ ì´ë™ -->
    <script>
        // --- DOMContentLoaded ì‚¬ìš© ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOMContentLoaded event fired."); // ë””ë²„ê·¸ ë¡œê·¸

            // --- í•„ìˆ˜ DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const loginContainer = document.getElementById('login-container');
            const mainContent = document.getElementById('main-content');
            const header = document.getElementById('header');
            const logContent = document.getElementById('log-content');
            const loginForm = document.getElementById('login-form');
            // logoutBtn, logBtn ë“±ì€ ë‚˜ì¤‘ì— í•„ìš”í•  ë•Œ ì°¾ìŒ
            const body = document.querySelector('body');
            const closeUserInfoButton = document.getElementById('closeUserInfoBtn'); // ë‹«ê¸° ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°

            // --- sessionStorage í™•ì¸ ë° ì´ˆê¸° í™”ë©´ ì„¤ì • ---
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';

            if (isLoggedIn) {
                // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœì¼ ê²½ìš°
                console.log("Already logged in (sessionStorage). Showing main content.");
                if (loginContainer) loginContainer.classList.add('hidden'); // ë¡œê·¸ì¸ í™”ë©´ ìˆ¨ê¸°ê¸°
                if (mainContent) mainContent.classList.remove('hidden'); // ë©”ì¸ í™”ë©´ ë³´ì´ê¸°
                if (header) header.classList.remove('hidden'); // í—¤ë” ë³´ì´ê¸°
                if (body) {
                    body.style.background = '#f8f9fa'; // [ìˆ˜ì •] ë°°ê²½ í°ìƒ‰ -> ì—°í•œ íšŒìƒ‰
                    body.style.overflow = 'auto'; // ìŠ¤í¬ë¡¤ í—ˆìš©
                }
                // ë©”ì¸ UI ë¦¬ìŠ¤ë„ˆ ì„¤ì • ë° ì§€ë„ ë¡œë“œ
                setupMainUIEventListeners();
                if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                     kakao.maps.load(initMap);
                } else {
                     console.error("Kakao Maps SDK not ready on initial load (logged in state).");
                     // SDK ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¬ê±°ë‚˜ ì‚¬ìš©ìì—ê²Œ ìƒˆë¡œê³ ì¹¨ ì•ˆë‚´
                     setTimeout(() => { // ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
                         if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                             kakao.maps.load(initMap);
                         } else {
                             customAlert("ì§€ë„ SDK ë¡œë”© ì˜¤ë¥˜. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                         }
                     }, 1000); // 1ì´ˆ í›„ ì‹œë„
                }
                 // ì´ˆê¸° ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ëª¨ë‹¬ ë‹«ê¸° ë“±)ë„ í•„ìš”
                 setupInitialEventListeners(false); // ë¡œê·¸ì¸ í¼ ë¦¬ìŠ¤ë„ˆëŠ” ì¶”ê°€ ì•ˆ í•¨
            } else {
                // ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ ê²½ìš°
                console.log("Not logged in. Showing login screen.");
                if (loginContainer) loginContainer.classList.remove('hidden'); // ë¡œê·¸ì¸ í™”ë©´ ë³´ì´ê¸°
                if (mainContent) mainContent.classList.add('hidden');
                if (header) header.classList.add('hidden');
                if (logContent) logContent.classList.add('hidden');
                 if (body) body.style.overflow = 'hidden'; // ë¡œê·¸ì¸ í™”ë©´ì—ì„œ ìŠ¤í¬ë¡¤ ë°©ì§€

                 // ì´ˆê¸° ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ë¡œê·¸ì¸ í¼ ë¦¬ìŠ¤ë„ˆ í¬í•¨)
                 setupInitialEventListeners(true);
            }


            // --- í•„ìˆ˜ ìš”ì†Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨ (isLoggedIn í™•ì¸ í›„ ì‹¤í–‰ë˜ë¯€ë¡œ loginForm í™•ì¸ì€ ë¶ˆí•„ìš”)---


            // ì»¤ìŠ¤í…€ alert í•¨ìˆ˜
            function customAlert(message) {
                const modal = document.getElementById('custom-modal');
                const messageElem = document.getElementById('modal-message');
                if (modal && messageElem) {
                    messageElem.textContent = message;
                    modal.style.display = 'flex'; // hidden í´ë˜ìŠ¤ ì œê±° ëŒ€ì‹  display ì†ì„± ë³€ê²½
                } else {
                    console.error("Custom modal elements not found, using standard alert.");
                    alert(message);
                }
            }

            // â–¼â–¼â–¼ Firebase ì„¤ì • ì •ë³´ â–¼â–¼â–¼
            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            // ì „ì—­ ë³€ìˆ˜ (Firebase ì´ˆê¸°í™” í›„ í• ë‹¹)
            let database;
            let map;
            let markers = [];
            let currentPolyline;
            let selectedLogMarker;
            let selectedUserId = null;
            /* [ì‚­ì œ] let selectedMarkerImage; */
            /* [ì‚­ì œ] let pathMarkerImage; */

            // --- Firebase ì•± ì´ˆê¸°í™” ---
            try {
                // Firebase SDK ë¡œë“œ í™•ì¸
                if (typeof firebase === 'undefined' || !firebase.initializeApp) {
                     throw new Error("Firebase SDK not loaded correctly.");
                }
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
                customAlert("Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”."); // customAlert ì‚¬ìš©
                return; // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
            }

            // --- ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜ ---
            function initMap() {
                 console.log("initMap called.");
                 // Kakao SDK ë¡œë“œ í™•ì¸
                 if (typeof kakao === 'undefined' || !kakao.maps || !kakao.maps.Map) {
                     console.error("Kakao Maps SDK not loaded correctly.");
                     customAlert("ì§€ë„ SDK ë¡œë”© ì˜¤ë¥˜. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                     return;
                 }
                 try {
                     // â–¼â–¼â–¼ [ìˆ˜ì •ë¨] ë§ˆì»¤ ì´ë¯¸ì§€ ë³€ìˆ˜ ì´ˆê¸°í™” ì œê±° â–¼â–¼â–¼
                     /* selectedMarkerImage = new kakao.maps.MarkerImage( ... );
                     pathMarkerImage = new kakao.maps.MarkerImage( ... );
                     */
                     // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

                     const container = document.getElementById('map');
                     if (!container) {
                         console.error("Map container not found!");
                         customAlert("ì§€ë„ í‘œì‹œ ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                         return;
                     }
                     map = new kakao.maps.Map(container, {
                         center: new kakao.maps.LatLng(37.566826, 126.9786567),
                         level: 4
                     });
                     map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                     map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                     loadUserList();
                 } catch (mapError) {
                     console.error("ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:", mapError);
                     customAlert("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                 }
            }

            // --- ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ í•¨ìˆ˜ ---
            function loadUserList() {
                 console.log("loadUserList called.");
                if (!database) {
                    console.error("Firebase Database not initialized (loadUserList)");
                    return;
                }
                const userListDiv = document.getElementById('userList');
                const h2 = userListDiv?.querySelector('h2');
                if (!h2 || !userListDiv) {
                    console.error("userListDiv or h2 not found.");
                    return;
                }
                const usersRef = database.ref('users');

                usersRef.once('value').then((snapshot) => {
                    // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
                    const existingUsers = userListDiv.querySelectorAll('.user');
                    existingUsers.forEach(el => el.remove());

                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        const userElement = document.createElement('div');
                        userElement.className = 'user';
                        userElement.dataset.name = userId;
                        userElement.textContent = userId;
                        userElement.addEventListener('click', () => selectUser(userId));
                        h2.insertAdjacentElement('afterend', userElement);
                    });
                     console.log("User list loaded.");
                }).catch(error => {
                    console.error("User list load error:", error);
                    customAlert("ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            }

            // --- ì§€ë„ ë° ì •ë³´ ì´ˆê¸°í™” í•¨ìˆ˜ ---
            function clearMapAndInfo() {
                 console.log("clearMapAndInfo called.");
                // ë§ˆì»¤ ë° ì˜¤ë²„ë ˆì´ ì œê±°
                markers.forEach(marker => {
                    if (marker.customOverlay) {
                        marker.customOverlay.setMap(null); // ì—°ê²°ëœ ì •ë³´ì°½ ì œê±°
                    }
                    marker.setMap(null); // ë§ˆì»¤(CustomOverlay) ì œê±°
                });
                markers = []; // ë°°ì—´ ì´ˆê¸°í™”

                // í´ë¦¬ë¼ì¸ ì œê±°
                if (currentPolyline) {
                    currentPolyline.setMap(null);
                    currentPolyline = null;
                }

                // ì„ íƒëœ ë¡œê·¸ ë§ˆì»¤ ì œê±°
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    // â–¼â–¼â–¼ [ì¶”ê°€] infoBoxë„ í•¨ê»˜ ì œê±° â–¼â–¼â–¼
                    if (selectedLogMarker.infoBox) {
                        selectedLogMarker.infoBox.setMap(null);
                    }
                    // â–²â–²â–² [ì¶”ê°€ ì™„ë£Œ] â–²â–²â–²
                    selectedLogMarker = null;
                }

                // ì‚¬ìš©ì ì •ë³´ ì˜ì—­ ì´ˆê¸°í™” ë° ìˆ¨ê¸°ê¸°
                const infoArea = document.getElementById('infoArea');
                const userInfoDiv = document.getElementById('userInfo');
                if (infoArea) infoArea.innerHTML = '';
                if (userInfoDiv) userInfoDiv.classList.add('hidden');

                // ë¡œê·¸ ë²„íŠ¼ ë¹„í™œì„±í™”
                const logBtnElem = document.getElementById('logBtn');
                if (logBtnElem) logBtnElem.disabled = true;

                // ì§€ë„ ì„¤ëª… ì´ˆê¸°í™”
                const mapUserElem = document.getElementById('mapUser');
                if (mapUserElem) mapUserElem.textContent = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ ì´ë™ ê²½ë¡œê°€ í‘œì‹œë©ë‹ˆë‹¤.';

                selectedUserId = null; // ì„ íƒëœ ì‚¬ìš©ì ID ì´ˆê¸°í™”
            }


            // --- ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜ ---
            function showLocationOnMap(lat, lng) {
                 console.log("showLocationOnMap called:", { lat, lng });
                if (!map) {
                    customAlert("ì§€ë„ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    return;
                }
                if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                    console.error("Invalid coordinates:", lat, lng);
                    customAlert("ì˜ëª»ëœ ìœ„ì¹˜ ì •ë³´ì…ë‹ˆë‹¤.");
                    return;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    // â–¼â–¼â–¼ [ì¶”ê°€] ì´ì „ ë§ˆì»¤ì˜ infoBoxë„ ì œê±° â–¼â–¼â–¼
                    if (selectedLogMarker.infoBox) {
                        selectedLogMarker.infoBox.setMap(null);
                    }
                    // â–²â–²â–² [ì¶”ê°€ ì™„ë£Œ] â–²â–²â–²
                }
                const position = new kakao.maps.LatLng(lat, lng);

                // â–¼â–¼â–¼ [ìˆ˜ì •] Marker ëŒ€ì‹  CustomOverlay ì‚¬ìš© (ì •ë³´ì°½ í¬í•¨) â–¼â–¼â–¼

                // 1. ì •ë³´ì°½ ì˜¤ë²„ë ˆì´ ìƒì„± (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
                const overlayContent = `<div class="custom-overlay-info">
                                            <strong>ë¡œê·¸ ìœ„ì¹˜</strong><br>
                                            ìœ„ë„: ${lat.toFixed(6)}<br>
                                            ê²½ë„: ${lng.toFixed(6)}
                                           </div>`;
                
                const infoOverlay = new kakao.maps.CustomOverlay({
                    content: overlayContent,
                    position: position,
                    xAnchor: 0.5, yAnchor: 2.5, // í•€ ì´ë¯¸ì§€ ìœ„ìª½ìœ¼ë¡œ ìœ„ì¹˜ ì¡°ì •
                    zIndex: 3
                });

                // 2. ë§ˆì»¤ë¡œ ì‚¬ìš©í•  DOM ìš”ì†Œ(ì´ë¯¸ì§€) ìƒì„±
                const markerImg = document.createElement('img');
                markerImg.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png';
                markerImg.className = 'custom-marker-pin';
                markerImg.style.cursor = 'pointer'; // ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½

                // 3. ì´ë¯¸ì§€ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                markerImg.addEventListener('mouseover', () => {
                    infoOverlay.setMap(map);
                });
                markerImg.addEventListener('mouseout', () => {
                    infoOverlay.setMap(null);
                });
                
                // 4. ë§ˆì»¤ CustomOverlay ìƒì„± (ì´ë¯¸ì§€ DOM ìš”ì†Œ ì‚¬ìš©)
                selectedLogMarker = new kakao.maps.CustomOverlay({
                    position: position,
                    content: markerImg, // ë¬¸ìì—´ ëŒ€ì‹  HTML ìš”ì†Œë¥¼ ì „ë‹¬
                    yAnchor: 1 // í•€ì˜ í•˜ë‹¨(y)ì„ ì¢Œí‘œì— ë§ì¶¤
                });

                // 5. ì •ë³´ì°½ ì°¸ì¡° ì €ì¥ (clearMapAndInfoì—ì„œ ì‚¬ìš©)
                selectedLogMarker.infoBox = infoOverlay; 
                
                selectedLogMarker.setMap(map);
                // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

                map.panTo(position); // ë¶€ë“œëŸ½ê²Œ ì´ë™
            }

            // --- ì‚¬ìš©ì ì„ íƒ í•¨ìˆ˜ ---
            function selectUser(userId) {
                 console.log("selectUser called with userId:", userId);
                clearMapAndInfo(); // ë¨¼ì € ì´ˆê¸°í™”
                selectedUserId = userId;
                const logBtnElem = document.getElementById('logBtn');
                if (logBtnElem) logBtnElem.disabled = false;

                const infoArea = document.getElementById('infoArea');
                const userInfoDiv = document.getElementById('userInfo');

                if (infoArea && userInfoDiv) {
                     // .log-list divì— ìŠ¤íƒ€ì¼ ì ìš© (ë¶€ëª¨ ìš”ì†Œê°€ ìŠ¤í¬ë¡¤ ì²˜ë¦¬)
                    infoArea.innerHTML = `<p><strong>ì‚¬ìš©ì ID:</strong> ${userId}</p><h3>ì „ì²´ ìœ„ì¹˜ ê¸°ë¡</h3><div class="log-list"></div>`;
                    userInfoDiv.classList.remove('hidden');
                } else {
                    console.error("infoArea or userInfo element not found in selectUser.");
                    return;
                }

                if (!database) {
                    console.error("Firebase Database not initialized (selectUser)");
                    return;
                }

                // ì „ì²´ ìœ„ì¹˜ ê¸°ë¡ ë¡œë“œ (ì‚¬ì´ë“œë°” ëª©ë¡ìš©)
                const locationsRef = database.ref('users/' + userId + '/location_logs');
                locationsRef.once('value').then((snapshot) => {
                    const logListDiv = infoArea.querySelector('.log-list');
                    if (!logListDiv) return;
                    logListDiv.innerHTML = ''; // ëª©ë¡ ì´ˆê¸°í™”
                    console.log(`Snapshot exists for ${userId}:`, snapshot.exists()); // ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
                    if (!snapshot.exists()) {
                        logListDiv.innerHTML = 'í‘œì‹œí•  ìœ„ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                    } else {
                        const logs = [];
                        snapshot.forEach(childSnapshot => {
                             // [ë””ë²„ê¹…] ê°œë³„ ë¡œê·¸ ë°ì´í„° í™•ì¸
                             console.log("Processing log:", childSnapshot.key, childSnapshot.val());
                            logs.push(childSnapshot.val());
                        });
                        console.log(`Total logs fetched for ${userId}:`, logs.length); // ë””ë²„ê·¸ ë¡œê·¸ ì¶”ê°€
                        logs.reverse().forEach((pos, index) => { // ìµœì‹ ìˆœìœ¼ë¡œ í‘œì‹œ
                             console.log(`Rendering log index ${index}:`, pos); // [ë””ë²„ê¹…] ë Œë”ë§ ë¡œê·¸ ì¶”ê°€
                            if (!pos || typeof pos !== 'object' || !pos.latitude || !pos.longitude) {
                                 console.warn("Skipping invalid log entry:", pos); // [ë””ë²„ê¹…] ì˜ëª»ëœ ë°ì´í„° ê²½ê³ 
                                 return; // ì˜ëª»ëœ ë°ì´í„° ê±´ë„ˆë›°ê¸°
                            }
                            const parsedLat = parseFloat(pos.latitude);
                            const parsedLng = parseFloat(pos.longitude);
                            if (isNaN(parsedLat) || isNaN(parsedLng)) {
                                 console.warn("Skipping log with invalid coordinates:", pos); // [ë””ë²„ê¹…] ì˜ëª»ëœ ì¢Œí‘œ ê²½ê³ 
                                 return;
                            }

                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';
                            let displayText = `ìœ„ë„: ${parsedLat.toFixed(6)}<br>ê²½ë„: ${parsedLng.toFixed(6)}`;
                            if (pos.altitude !== undefined && pos.altitude !== null) {
                                const parsedAlt = parseFloat(pos.altitude);
                                if (!isNaN(parsedAlt)) {
                                    displayText += `<br>ê³ ë„: ${parsedAlt.toFixed(2)}m`;
                                }
                            }
                            logEntry.innerHTML = displayText;
                            logEntry.addEventListener('click', () => showLocationOnMap(parsedLat, parsedLng));
                            logListDiv.appendChild(logEntry);
                        });
                         console.log(`Finished rendering ${logListDiv.children.length} logs for ${userId}`); // [ë””ë²„ê¹…] ë Œë”ë§ ì™„ë£Œ ë¡œê·¸
                    }
                }).catch(error => {
                    console.error("Error loading location logs:", error);
                    customAlert("ìœ„ì¹˜ ê¸°ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                 });

                // ìµœê·¼ 10ê°œ ìœ„ì¹˜ ë¡œë“œ (ì§€ë„ í‘œì‹œìš©)
                const recentLocationsQuery = database.ref('users/' + userId + '/location_logs').limitToLast(10);
                recentLocationsQuery.once('value').then((snapshot) => {
                    const mapUserElem = document.getElementById('mapUser');
                    if (!mapUserElem) return;

                    if (!snapshot.exists()) {
                        mapUserElem.textContent = `${userId} ì‚¬ìš©ìì˜ ìµœê·¼ ìœ„ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                        return; // ìµœê·¼ ê¸°ë¡ ì—†ìœ¼ë©´ ì§€ë„ í‘œì‹œëŠ” ì—¬ê¸°ì„œ ì¢…ë£Œ
                    }

                    mapUserElem.textContent = `${userId}ì˜ ìµœê·¼ ì´ë™ ê²½ë¡œ (ìµœëŒ€ 10ê°œ)ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`;
                    let path = [];
                    const bounds = new kakao.maps.LatLngBounds();

                    snapshot.forEach((snap) => {
                        const pos = snap.val();
                         if (!pos || typeof pos !== 'object' || !pos.latitude || !pos.longitude) return; // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€

                        const parsedLat = parseFloat(pos.latitude);
                        const parsedLng = parseFloat(pos.longitude);
                        if (isNaN(parsedLat) || isNaN(parsedLng)) return;

                        const latlng = new kakao.maps.LatLng(parsedLat, parsedLng);
                        path.push(latlng);

                        // â–¼â–¼â–¼ [ìˆ˜ì •] Marker ëŒ€ì‹  CustomOverlay ì‚¬ìš© (íŒŒë€ ì ) + ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • â–¼â–¼â–¼

                        // 1. ì •ë³´ì°½ ì˜¤ë²„ë ˆì´ ìƒì„± (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€)
                        const timestamp = pos.timestamp || Date.now();
                         // timestampê°€ ìˆ«ì í˜•íƒœê°€ ì•„ë‹ ê²½ìš° Date ê°ì²´ ìƒì„± ì‹œë„
                        let dateObj = new Date(timestamp);
                        // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œë©´ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ëŒ€ì²´
                        if (isNaN(dateObj.getTime())) {
                            dateObj = new Date();
                        }
                        const formattedTime = dateObj.toLocaleString('ko-KR', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });

                        const overlayContent = `<div class="custom-overlay-info">
                                                    <strong>${formattedTime}</strong><br>
                                                    ìœ„ë„: ${parsedLat.toFixed(6)}<br>
                                                    ê²½ë„: ${parsedLng.toFixed(6)}
                                                   </div>`;

                        const infoOverlay = new kakao.maps.CustomOverlay({
                            content: overlayContent,
                            position: latlng,
                            xAnchor: 0.5, yAnchor: 2.5, zIndex: 3
                        });
                        
                        // 2. ë§ˆì»¤ë¡œ ì‚¬ìš©í•  DOM ìš”ì†Œ(ì´ë¯¸ì§€) ìƒì„±
                        const dotImg = document.createElement('img');
                        dotImg.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/blue_dot.png';
                        dotImg.className = 'custom-marker-dot';
                        dotImg.style.cursor = 'pointer';

                        // 3. ì´ë¯¸ì§€ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                        dotImg.addEventListener('mouseover', () => {
                            infoOverlay.setMap(map);
                        });
                        dotImg.addEventListener('mouseout', () => {
                            infoOverlay.setMap(null);
                        });

                        // 4. ë§ˆì»¤ CustomOverlay ìƒì„±
                        const pathPointOverlay = new kakao.maps.CustomOverlay({
                            position: latlng,
                            content: dotImg, // HTML ìš”ì†Œë¥¼ contentë¡œ ì „ë‹¬
                            xAnchor: 0.5, // ì ì˜ xì¶• ì¤‘ì•™
                            yAnchor: 0.5  // ì ì˜ yì¶• ì¤‘ì•™
                        });
                        pathPointOverlay.setMap(map);
                        
                        // 5. ì •ë³´ì°½ ì°¸ì¡° ì €ì¥ (clearMapAndInfoì—ì„œ ì‚¬ìš©)
                        pathPointOverlay.customOverlay = infoOverlay; 
                        markers.push(pathPointOverlay); // ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
                        // â–²â–²â–² [ìˆ˜ì • ì™„ë£Œ] â–²â–²â–²

                        bounds.extend(latlng);
                    });

                    // ê²½ë¡œì„  ìƒì„± ë° ì§€ë„ ë²”ìœ„ ì¡°ì •
                    if (path.length > 0 && map) {
                        currentPolyline = new kakao.maps.Polyline({
                            path: path,
                            strokeWeight: 4,
                            strokeColor: '#0000FF', // ì„  ìƒ‰ìƒ íŒŒë€ìƒ‰
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid',
                            map: map
                        });
                        map.setBounds(bounds);
                    }
                }).catch(error => {
                     console.error("Error loading recent locations:", error);
                     customAlert("ìµœê·¼ ìœ„ì¹˜ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                 });
            }

            // --- ì‚¬ìš©ì ì •ë³´ ë‹«ê¸° í•¨ìˆ˜ ---
            function closeUserInfo() {
                 console.log("closeUserInfo called.");
                 // ğŸŒŸ [ìˆ˜ì •] ì§€ë„ ë° ê´€ë ¨ ì •ë³´ ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ ì¶”ê°€
                 clearMapAndInfo();
                 // userInfo ìš”ì†Œ ìì²´ëŠ” ìˆ¨ê¸¸ í•„ìš” ì—†ìŒ (clearMapAndInfoì—ì„œ ì²˜ë¦¬ë¨)
            }

            // --- [ìˆ˜ì •ë¨] ëª¨ë“  ë¡œê·¸ ë¡œë“œ í•¨ìˆ˜ (ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€) ---
            function loadAllLogs(userId) {
                // â–¼â–¼â–¼ [ì¶”ì  1] í•¨ìˆ˜ê°€ ì˜¬ë°”ë¥¸ IDë¡œ ì‹¤í–‰ë˜ì—ˆëŠ”ì§€ í™•ì¸
                console.log("loadAllLogs í•¨ìˆ˜ ì‹¤í–‰ë¨. UserID:", userId);

                if (!database) {
                    console.error("Firebase Database not initialized (loadAllLogs)");
                    return;
                }
                const doorLockLogContainer = document.querySelector('#doorLockLogs .log-entries');
                const appLogContainer = document.querySelector('#appLogs .log-entries');
                const logUserTitle = document.getElementById('logUserTitle');

                if (!doorLockLogContainer || !appLogContainer || !logUserTitle) {
                    // â–¼â–¼â–¼ [ì¶”ì  2] HTML ìš”ì†Œë¥¼ ì˜ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
                    console.error("í•„ìˆ˜ HTML ìš”ì†Œ(ë¡œê·¸ ì»¨í…Œì´ë„ˆ ë“±)ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                logUserTitle.textContent = `${userId} ì‚¬ìš©ìì˜ ì „ì²´ ë¡œê·¸`;
                doorLockLogContainer.innerHTML = '<em>ë¡œë”© ì¤‘...</em>';
                appLogContainer.innerHTML = '<em>ë¡œë”© ì¤‘...</em>';

                // ë„ì–´ë½ ë¡œê·¸ ë¡œë“œ
                const doorLockRef = database.ref('users/' + userId + '/door_lock_logs');
                
                // â–¼â–¼â–¼ [ì¶”ì  3] Firebaseì— ìš”ì²­í•˜ëŠ” ì •í™•í•œ ê²½ë¡œ í™•ì¸
                console.log("ìš”ì²­í•˜ëŠ” DB ê²½ë¡œ (ë„ì–´ë½):", doorLockRef.toString());

                doorLockRef.once('value').then((snapshot) => {
                    // â–¼â–¼â–¼ [ì¶”ì  4] Firebaseê°€ ì‘ë‹µí•œ ì‹¤ì œ ë°ì´í„°(ê°’) í™•ì¸
                    console.log("Firebaseë¡œë¶€í„° ë°›ì€ ë„ì–´ë½ ì‘ë‹µ (snapshot.val()):", snapshot.val());
                    // â–¼â–¼â–¼ [ì¶”ì  5] ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì—¬ë¶€ í™•ì¸
                    console.log("ë„ì–´ë½ Snapshot ì¡´ì¬ ì—¬ë¶€ (snapshot.exists()):", snapshot.exists());

                    doorLockLogContainer.innerHTML = ''; // ì´ˆê¸°í™”
                    if (!snapshot.exists()) {
                        doorLockLogContainer.innerHTML = 'í‘œì‹œí•  ë„ì–´ë½ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    } else {
                        const logs = [];
                        snapshot.forEach(child => {
                            // â–¼â–¼â–¼ [ì¶”ì  6] ë°˜ë³µë¬¸ì´ ê° ë°ì´í„°ë¥¼ ì˜ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸
                            console.log("ì²˜ë¦¬ ì¤‘ì¸ ê°œë³„ ë¡œê·¸ í•­ëª© (ë„ì–´ë½):", child.val());
                            logs.push(child.val());
                        });
                        logs.reverse().forEach(log => { // ìµœì‹ ìˆœ
                            const entry = document.createElement('div');
                            entry.className = 'full-log-entry';
                            // timestampê°€ ìˆ«ì í˜•íƒœê°€ ì•„ë‹ ê²½ìš° Date ê°ì²´ ìƒì„± ì‹œë„
                            let dateObj = new Date(log.timestamp || Date.now());
                            if (isNaN(dateObj.getTime())) { dateObj = new Date(); }
                            const formattedTime = dateObj.toLocaleString('ko-KR');
                            entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.action || 'N/A'}`;
                            doorLockLogContainer.appendChild(entry);
                        });
                    }
                }).catch(error => {
                    // â–¼â–¼â–¼ [ì¶”ì  7] ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë‹¤ ì‹¤íŒ¨í–ˆëŠ”ì§€ í™•ì¸
                    console.error("ë„ì–´ë½ ë¡œê·¸ ë¡œë“œ ì¤‘ Firebase ì˜¤ë¥˜:", error);
                    doorLockLogContainer.innerHTML = '<span style="color: red;">ë„ì–´ë½ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</span>';
                });

                // ì•± ë¡œê·¸ ë¡œë“œ
                const appLogRef = database.ref('users/' + userId + '/app_logs');

                // â–¼â–¼â–¼ [ì¶”ì  3] Firebaseì— ìš”ì²­í•˜ëŠ” ì •í™•í•œ ê²½ë¡œ í™•ì¸ (ì•±)
                console.log("ìš”ì²­í•˜ëŠ” DB ê²½ë¡œ (ì•±):", appLogRef.toString());

                appLogRef.once('value').then((snapshot) => {
                    // â–¼â–¼â–¼ [ì¶”ì  4] Firebaseê°€ ì‘ë‹µí•œ ì‹¤ì œ ë°ì´í„°(ê°’) í™•ì¸ (ì•±)
                    console.log("Firebaseë¡œë¶€í„° ë°›ì€ ì•± ì‘ë‹µ (snapshot.val()):", snapshot.val());
                    // â–¼â–¼â–¼ [ì¶”ì  5] ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ ì—¬ë¶€ í™•ì¸ (ì•±)
                    console.log("ì•± Snapshot ì¡´ì¬ ì—¬ë¶€ (snapshot.exists()):", snapshot.exists());

                    appLogContainer.innerHTML = ''; // ì´ˆê¸°í™”
                    if (!snapshot.exists()) {
                        appLogContainer.innerHTML = 'í‘œì‹œí•  ì•± ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    } else {
                        const logs = [];
                        snapshot.forEach(child => {
                            // â–¼â–¼â–¼ [ì¶”ì  6] ë°˜ë³µë¬¸ì´ ê° ë°ì´í„°ë¥¼ ì˜ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸ (ì•±)
                            console.log("ì²˜ë¦¬ ì¤‘ì¸ ê°œë³„ ë¡œê·¸ í•­ëª© (ì•±):", child.val());
                            logs.push(child.val());
                        });
                        logs.reverse().forEach(log => { // ìµœì‹ ìˆœ
                            const entry = document.createElement('div');
                            entry.className = 'full-log-entry';
                            // timestampê°€ ìˆ«ì í˜•íƒœê°€ ì•„ë‹ ê²½ìš° Date ê°ì²´ ìƒì„± ì‹œë„
                            let dateObj = new Date(log.timestamp || Date.now());
                            if (isNaN(dateObj.getTime())) { dateObj = new Date(); }
                            const formattedTime = dateObj.toLocaleString('ko-KR');
                            entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.event || 'N/A'}`;
                            appLogContainer.appendChild(entry);
                        });
                    }
                }).catch(error => {
                    // â–¼â–¼â–¼ [ì¶”ì  7] ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ë‹¤ ì‹¤íŒ¨í–ˆëŠ”ì§€ í™•ì¸ (ì•±)
                    console.error("ì•± ë¡œê·¸ ë¡œë“œ ì¤‘ Firebase ì˜¤ë¥˜:", error);
                    appLogContainer.innerHTML = '<span style="color: red;">ì•± ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨</span>';
                });
            }


            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜ ---
            function handleLoginSubmit(e) {
                e.preventDefault();
                console.log("Login submitted.");
                const usernameInput = document.getElementById('username')?.value.trim();
                const passwordInput = document.getElementById('password')?.value.trim();

                if (!usernameInput || !passwordInput) {
                    customAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!database) {
                    console.error("Firebase Database not initialized (Login Submit)");
                    customAlert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜");
                    return;
                }
                const adminRef = database.ref('admin_pass');

                adminRef.once('value').then((snapshot) => {
                    let loginSuccess = false;
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const adminData = childSnapshot.val();
                            // Null check for adminData added
                            if (adminData && adminData.adminId === usernameInput && adminData.password === passwordInput) {
                                loginSuccess = true;
                                return true; // Exit forEach early
                            }
                        });
                    }

                    if (loginSuccess) {
                        console.log("Login successful.");
                        // [ìˆ˜ì •] ë¡œê·¸ì¸ ì„±ê³µ ì‹œ sessionStorageì— ìƒíƒœ ì €ì¥
                        sessionStorage.setItem('isLoggedIn', 'true');

                        if (loginContainer) loginContainer.classList.add('hidden');
                        if (mainContent) mainContent.classList.remove('hidden');
                        if (header) header.classList.remove('hidden');
                        if (body) {
                            body.style.background = '#f8f9fa'; // [ìˆ˜ì •] ë°°ê²½ í°ìƒ‰ -> ì—°í•œ íšŒìƒ‰
                            body.style.overflow = 'auto'; // Allow scrolling
                        }

                        // Load Kakao Maps SDK only after login
                        if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                            console.log("Loading Kakao Maps...");
                            kakao.maps.load(initMap);
                        } else {
                             console.error("Kakao Maps SDK not loaded or load function unavailable.");
                             customAlert("ì§€ë„ SDK ë¡œë”© ì˜¤ë¥˜. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
                        }
                         // ë¡œê·¸ì¸ ì„±ê³µ í›„ ë©”ì¸ UI ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                         setupMainUIEventListeners();
                    } else {
                        console.log("Login failed.");
                        customAlert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                }).catch(error => {
                     console.error("Login processing error:", error);
                     customAlert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                 });
            }

            function handleLogout() {
                console.log("Logout clicked.");
                // [ìˆ˜ì •] ë¡œê·¸ì•„ì›ƒ ì‹œ sessionStorage í´ë¦¬ì–´
                sessionStorage.removeItem('isLoggedIn');
                window.location.reload(); // Simple reload for logout
            }

            function handleLogView() {
                console.log("Log view clicked.");
                 // í•„ìš”í•œ ìš”ì†Œë“¤ì„ ì´ í•¨ìˆ˜ ë‚´ì—ì„œ ë‹¤ì‹œ ì°¾ìŒ
                const currentMainContent = document.getElementById('main-content');
                const currentLogContent = document.getElementById('log-content');

                if (selectedUserId) {
                    if (currentMainContent) currentMainContent.classList.add('hidden');
                    if (currentLogContent) currentLogContent.classList.remove('hidden');

                    // Dynamically add listener for backToMapBtn only when log view is shown
                    const backBtn = document.getElementById('backToMapBtn'); // Get the button again
                    if (backBtn) {
                        // Remove potential duplicate listener before adding
                        backBtn.removeEventListener('click', handleBackToMap);
                        backBtn.addEventListener('click', handleBackToMap);
                        console.log("Back to Map listener added/updated in handleLogView.");
                    } else {
                        console.error("backToMapBtn element not found in handleLogView!");
                    }
                    loadAllLogs(selectedUserId);
                } else {
                    customAlert("ë¨¼ì € ì‚¬ìš©ì ëª©ë¡ì—ì„œ ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            }

            function handleBackToMap() {
                 console.log("Back to map clicked.");
                 // í•„ìš”í•œ ìš”ì†Œë“¤ì„ ì´ í•¨ìˆ˜ ë‚´ì—ì„œ ë‹¤ì‹œ ì°¾ìŒ
                 const currentMainContent = document.getElementById('main-content');
                 const currentLogContent = document.getElementById('log-content');
                 if (currentLogContent) currentLogContent.classList.add('hidden');
                 if (currentMainContent) currentMainContent.classList.remove('hidden');
            }

             // --- ìƒˆ ë²„íŠ¼ í•¸ë“¤ëŸ¬ ---
             function handleNewButtonClick() {
                 console.log("New button clicked.");
                 window.location.href = 'loge.html';
             }


            // --- ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
            // [ìˆ˜ì •] ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë¡œê·¸ì¸ í¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì—¬ë¶€ ê²°ì •
            function setupInitialEventListeners(addLoginFormListener = true) {
                 console.log("Setting up initial event listeners...");
                 if (addLoginFormListener) {
                     if (loginForm) {
                         loginForm.addEventListener('submit', handleLoginSubmit);
                         console.log("Login form listener added initially.");
                     } else {
                         console.error("loginForm element not found initially.");
                     }
                 }
                // Add modal close button listener
                const modalCloseButton = document.querySelector('#custom-modal button');
                if (modalCloseButton) {
                    modalCloseButton.addEventListener('click', () => {
                        const modal = document.getElementById('custom-modal');
                        if(modal) modal.style.display = 'none';
                    });
                }
                // userInfo ë‹«ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆë„ ì—¬ê¸°ì„œ ì¶”ê°€
                if (closeUserInfoButton) {
                     closeUserInfoButton.addEventListener('click', closeUserInfo);
                     console.log("Close User Info button listener added initially.");
                } else {
                     console.error("closeUserInfoButton not found initially.");
                }
            }

             // --- ë¡œê·¸ì¸ ì„±ê³µ/ì„¸ì…˜ ìœ ì§€ ì‹œ í˜¸ì¶œë˜ëŠ” ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
            function setupMainUIEventListeners() {
                 console.log("Setting up main UI event listeners after login.");
                 // ìš”ì†Œ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                 const currentLogoutBtn = document.getElementById('logoutBtn');
                 const currentLogBtn = document.getElementById('logBtn');
                 const currentNewBtn = document.getElementById('newBtn'); // ìƒˆ ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°

                 if (currentLogoutBtn) {
                     currentLogoutBtn.addEventListener('click', handleLogout);
                     console.log("Logout button listener added.");
                 } else {
                     console.error("logoutBtn element not found after login.");
                 }

                 if (currentLogBtn) {
                     currentLogBtn.addEventListener('click', handleLogView);
                     console.log("Log button listener added.");
                 } else {
                     console.error("logBtn element not found after login.");
                 }

                 // ìƒˆ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                 if (currentNewBtn) {
                     currentNewBtn.addEventListener('click', handleNewButtonClick);
                     console.log("New button listener added.");
                 } else {
                     console.error("newBtn element not found after login.");
                 }
                 // backToMapBtn listener is added dynamically in handleLogView
            }

            // --- ì´ˆê¸° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤í–‰ (ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë¶„ê¸°) ---
            // ì´ ë¡œì§ì€ íŒŒì¼ ìƒë‹¨ DOMContentLoaded ì‹œì‘ ë¶€ë¶„ìœ¼ë¡œ ì´ë™í•¨

        }); // DOMContentLoaded ë‹«ê¸°
    </script>
</body>
</html>