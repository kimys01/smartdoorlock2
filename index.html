<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="color-scheme" content="light only">
    <meta name="supported-color-schemes" content="light">

    <title>Smart Doorlock Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="indexstyle.css?v=3.0">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container" class="hidden">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™">Smart Doorlock</h1> 
        <div class="button-group">
            <button id="mapBtn" disabled>ì§€ë„</button>
            <button id="logBtn" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="newBtn">DB ì¡°íšŒ</button>
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" title="ë‹«ê¸°">âœ•</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div> 
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <h2 id="logUserTitle">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">ë„ì–´ë½ ë¡œê·¸</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">ì•± ë¡œê·¸</button>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section active-tab-content">
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <h2>DataBase</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ID ì…ë ¥">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDBData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <h3 id="result-title">User List:</h3>
            <div id="result-area">
                <div style="padding:20px; text-align:center; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">í™•ì¸</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">í™•ì¸</button>
                <button id="cancelLogoutBtn" style="flex: 1; background-color: #aaa;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("App initialized.");

        // --- Global Variables ---
        let DOORLOCK_LAT = 36.3308358;   
        let DOORLOCK_LNG = 127.3364818;
        let MAX_DISTANCE_KM = 3.0;
        let database, map, doorlockMarker, currentPolyline, selectedLogMarker, selectedUserId;
        let markers = [], zoneCircles = [], currentUserLocationLogs = [];

        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.web.app", 
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        try {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase Load Fail");
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            alert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");
            return;
        }

        // --- Helper Functions ---
        function formatTimestamp(ts) {
            if (!ts) return 'ì‹œê°„ ì—†ìŒ';
            const date = new Date(ts);
            if (isNaN(date.getTime())) return ts; 
            return date.toLocaleString('ko-KR', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
            });
        }

        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * (Math.PI/180);
            const dLon = (lon2-lon1) * (Math.PI/180); 
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        }

        function customAlert(msg) {
            document.getElementById('modal-message').textContent = msg;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        // --- Core Logic ---
        function loadUserDoorlockAndInit(userId, callback) {
            database.ref('users/' + userId).once('value').then((snap) => {
                const user = snap.val();
                if (!user || !user.my_doorlocks) throw new Error("ì—°ê²°ëœ ë„ì–´ë½ ì—†ìŒ");
                const doorlockKeys = Object.keys(user.my_doorlocks);
                const doorlockId = doorlockKeys[0]; 
                return database.ref('doorlocks/' + doorlockId).once('value');
            }).then((snap) => {
                const dlData = snap.val();
                if (dlData && dlData.location) {
                    DOORLOCK_LAT = parseFloat(dlData.location.latitude);
                    DOORLOCK_LNG = parseFloat(dlData.location.longitude);
                    if (map) {
                        map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                        drawDoorlockZones();
                    }
                }
                if (callback) callback();
            }).catch((err) => {
                console.error(err);
                if (callback) callback(); 
            });
        }

        // --- Load Logs Logic ---
        function loadAllLogs(userId) {
            const dlContainer = document.querySelector('#doorLockLogs .log-entries');
            const appContainer = document.querySelector('#appLogs .log-entries');
            
            // [ìˆ˜ì •ë¨] í…ìŠ¤íŠ¸ ë³€ê²½: "ì „ì²´ ë¡œê·¸ ê¸°ë¡" -> "ì˜ ë¡œê·¸ ê¸°ë¡"
            document.getElementById('logUserTitle').textContent = `${userId}ì˜ ë¡œê·¸ ê¸°ë¡`;
            
            dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ë„ì–´ë½ ë¡œê·¸ ë¡œë”© ì¤‘...</div>';
            appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ì•± ë¡œê·¸ ë¡œë”© ì¤‘...</div>';

            database.ref('users/' + userId).once('value').then((userSnap) => {
                const user = userSnap.val();
                
                // 1. APP LOGS
                database.ref(`users/${userId}/app_logs`).once('value').then(snap => {
                    if (!snap.exists()) {
                        appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ì•± ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    } else {
                        appContainer.innerHTML = '';
                        const logs = [];
                        snap.forEach(childSnapshot => { logs.push(childSnapshot.val()); });
                        logs.sort((a, b) => {
                            const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                            const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                            return timeB - timeA; 
                        });

                        logs.forEach(log => {
                            const div = document.createElement('div');
                            div.className = 'log-card status-app'; 
                            let title = "ì•± í™œë™"; let detail = "";
                            if (log.message) title = log.message; 
                            else if (log.event) title = log.event;
                            else if (log.new_auth) { title = "ì¸ì¦ ë°©ì‹ ë³€ê²½"; detail = `ê°’: ${log.new_auth}`; }
                            else if (log.detailSettings) { title = "ì„¤ì • ë³€ê²½"; detail = JSON.stringify(log.detailSettings).replace(/["{}]/g, "").replace(/,/g, ", "); } 
                            else { detail = JSON.stringify(log).replace(/["{}]/g, ""); }

                            div.style.backgroundColor = "#fff"; div.style.marginBottom = "10px";
                            div.style.padding = "10px"; div.style.borderRadius = "8px";
                            div.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)"; div.style.borderLeft = "5px solid #28a745"; 

                            div.innerHTML = `
                                <div class="log-header-row"><span>ğŸ•’ ${formatTimestamp(log.timestamp)}</span><span>ğŸ“± App</span></div>
                                <div class="log-body-row"><span style="font-weight:600; color:#333; font-size:15px;">${title}</span></div>
                                ${detail ? `<div class="log-detail-box">${detail}</div>` : ''}
                            `;
                            appContainer.appendChild(div);
                        });
                    }
                });

                // 2. DOORLOCK LOGS
                let doorlockIds = [];
                if (user && user.my_doorlocks) { doorlockIds = Object.keys(user.my_doorlocks); }

                if (doorlockIds.length === 0) {
                    dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#dc3545;">ì—°ê²°ëœ ë„ì–´ë½ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    const promises = doorlockIds.map(id => database.ref(`doorlocks/${id}/logs`).once('value'));
                    Promise.all(promises).then(snapshots => {
                        let allLogs = [];
                        snapshots.forEach(snap => { 
                            if (snap.exists()) { 
                                snap.forEach(c => { 
                                    const val = c.val();
                                    allLogs.push(val); 
                                }); 
                            } 
                        });

                        if (allLogs.length === 0) {
                            dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ê¸°ë¡ ì—†ìŒ</div>';
                        } else {
                            dlContainer.innerHTML = '';
                            allLogs.sort((a, b) => {
                                const timeAStr = a.timestamp || a.time || a.date || a.datetime || a.created_at || 0;
                                const timeBStr = b.timestamp || b.time || b.date || b.datetime || b.created_at || 0;
                                const timeA = new Date(timeAStr).getTime() || 0;
                                const timeB = new Date(timeBStr).getTime() || 0;
                                return timeB - timeA;
                            });

                            allLogs.forEach(log => {
                                const div = document.createElement('div');
                                let who = log.user || log.userId || log.id || log.who || log.name || "ì•Œ ìˆ˜ ì—†ìŒ";
                                let timeValue = log.timestamp || log.time || log.date || log.datetime || log.created_at;
                                let methodRawValue = log.method || log.auth || log.type || log.category || "unknown";
                                let methodRaw = String(methodRawValue).toUpperCase(); 
                                let methodDisp = methodRawValue; 
                                let methodIcon = "ğŸ”‘"; 

                                if (methodRaw.includes("PW") || methodRaw.includes("PASS")) { methodDisp = "ë¹„ë°€ë²ˆí˜¸"; methodIcon = "ğŸ”¢"; } 
                                else if (methodRaw.includes("RF") || methodRaw.includes("CARD") || methodRaw.includes("TAG")) { methodDisp = "ì¹´ë“œí‚¤"; methodIcon = "ğŸ’³"; } 
                                else if (methodRaw.includes("APP") || methodRaw.includes("BLE") || methodRaw.includes("BLUE") || methodRaw.includes("PHONE")) { methodDisp = "ì•±(ë¸”ë£¨íˆ¬ìŠ¤)"; methodIcon = "ğŸ“±"; } 
                                else if (methodRaw.includes("FINGER") || methodRaw.includes("BIO")) { methodDisp = "ì§€ë¬¸"; methodIcon = "ğŸ‘†"; }

                                let actionRawValue = log.command || log.status || log.state || log.action || log.event || log.msg || "ì•Œ ìˆ˜ ì—†ìŒ";
                                let actionRaw = String(actionRawValue).toUpperCase(); 
                                let actionDisp = actionRawValue; 
                                let actionIcon = "â“";
                                let statusColor = "#333"; let statusBg = "#fff";

                                if (actionRaw.includes("UNLOCK") || actionRaw.includes("OPEN") || actionRaw === "1" || actionRaw === "TRUE" || actionRaw.includes("SUCCESS")) {
                                    actionDisp = "ë¬¸ ì—´ë¦¼"; actionIcon = "ğŸ”“"; statusColor = "#007bff"; statusBg = "#e7f3ff";
                                } 
                                else if (actionRaw.includes("LOCK") || actionRaw.includes("CLOSE") || actionRaw === "0" || actionRaw === "FALSE") {
                                    actionDisp = "ë¬¸ ì ê¹€"; actionIcon = "ğŸ”’"; statusColor = "#dc3545"; statusBg = "#ffeef0";
                                }
                                else if (actionRaw.includes("WARN") || actionRaw.includes("ALERT") || actionRaw.includes("FAIL")) {
                                    actionDisp = "ê²½ê³ /ì‹¤íŒ¨"; actionIcon = "ğŸš¨"; statusColor = "#ffc107"; statusBg = "#fff3cd";
                                }

                                div.style.backgroundColor = "#fff"; div.style.marginBottom = "12px";
                                div.style.padding = "12px 16px"; div.style.borderRadius = "12px";
                                div.style.boxShadow = "0 2px 8px rgba(0,0,0,0.08)";
                                div.style.borderLeft = `5px solid ${statusColor}`;

                                div.innerHTML = `
                                    <div style="font-size: 12px; color: #888; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;">
                                        ğŸ•’ ${formatTimestamp(timeValue)}
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <span style="background: #f5f5f5; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #444;">ğŸ‘¤ ${who}</span>
                                            <span style="background: #f0f7ff; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #0056b3;">${methodIcon} ${methodDisp}</span>
                                        </div>
                                        <div style="background: ${statusBg}; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 14px; color: ${statusColor}; display: flex; align-items: center; gap: 5px;">
                                            ${actionIcon} ${actionDisp}
                                        </div>
                                    </div>
                                `;
                                dlContainer.appendChild(div);
                            });
                        }
                    });
                }
            });
        }

        // --- UI Logic ---
        window.switchLogTab = function(tabName) {
            document.querySelectorAll('.log-tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.log-section').forEach(s => s.classList.remove('active-tab-content'));
            if(tabName === 'doorlock') document.getElementById('doorLockLogs').classList.add('active-tab-content');
            else document.getElementById('appLogs').classList.add('active-tab-content');
        }

        // --- Map Logic ---
        function initMap() {
            const container = document.getElementById('map');
            map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
            drawDoorlockZones();
            if (sessionStorage.getItem('isAdmin') === 'true') loadUserList();
        }

        function drawDoorlockZones() {
            if (!map) return;
            if (doorlockMarker) doorlockMarker.setMap(null);
            zoneCircles.forEach(c => c.setMap(null)); zoneCircles = [];
            const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
            doorlockMarker = new kakao.maps.Marker({ position: pos, map: map, title: "ë„ì–´ë½" });
            [1000, 2000, 3000].forEach((r, i) => {
                const color = i===0?'#FF0000':(i===1?'#FFA500':'#008000');
                const circle = new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1 });
                circle.setMap(map); zoneCircles.push(circle);
            });
        }

        function selectUser(userId) {
            if (sessionStorage.getItem('isAdmin') === 'true') clearMapAndInfo();

            selectedUserId = userId;
            document.getElementById('logBtn').disabled = false;
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('infoArea').innerHTML = `
                <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
                <div class="filter-group">
                    <button id="btnAll" class="filter-btn active">ì „ì²´</button>
                    <button id="btnRange" class="filter-btn">ë²”ìœ„ ë‚´</button>
                </div>
                <div class="log-list" id="miniLogList">ë¡œë”© ì¤‘...</div>
            `;
            document.getElementById('btnAll').onclick = () => { 
                document.getElementById('btnAll').classList.add('active');
                document.getElementById('btnRange').classList.remove('active');
                renderLocationLogs(false); 
            };
            document.getElementById('btnRange').onclick = () => { 
                document.getElementById('btnRange').classList.add('active');
                document.getElementById('btnAll').classList.remove('active');
                renderLocationLogs(true); 
            };
            database.ref(`users/${userId}/location_logs`).once('value').then(snap => {
                currentUserLocationLogs = [];
                if(snap.exists()) {
                    snap.forEach(c => { if(c.val().latitude) currentUserLocationLogs.push(c.val()); });
                    currentUserLocationLogs.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
                }
                renderLocationLogs(false);
            });
        }

        function renderLocationLogs(filter) {
            const listDiv = document.getElementById('miniLogList');
            listDiv.innerHTML = '';
            markers.forEach(m => { if(m.customOverlay) m.customOverlay.setMap(null); m.setMap(null); }); markers = [];
            if(currentPolyline) currentPolyline.setMap(null);
            if(currentUserLocationLogs.length === 0) { listDiv.innerHTML = 'ê¸°ë¡ ì—†ìŒ'; return; }
            let path = [];
            const bounds = new kakao.maps.LatLngBounds();
            bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
            currentUserLocationLogs.forEach(pos => {
                const lat = parseFloat(pos.latitude); const lng = parseFloat(pos.longitude);
                const dist = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                if(filter && dist > MAX_DISTANCE_KM) return;
                const div = document.createElement('div');
                div.className = 'log-entry';
                div.innerHTML = `${formatTimestamp(pos.timestamp)} <br> ê±°ë¦¬: <strong>${dist.toFixed(2)}km</strong>`;
                div.onclick = () => { map.setCenter(new kakao.maps.LatLng(lat, lng)); map.setLevel(4); };
                listDiv.appendChild(div);
                if(path.length < 50) { 
                    const p = new kakao.maps.LatLng(lat, lng); path.push(p); bounds.extend(p);
                    const dot = document.createElement('div');
                    dot.style.width='8px'; dot.style.height='8px'; dot.style.background='blue'; dot.style.borderRadius='50%';
                    const m = new kakao.maps.CustomOverlay({ position: p, content: dot, yAnchor: 0.5 });
                    m.setMap(map); markers.push(m);
                }
            });
            listDiv.scrollTop = 0;
            if(path.length > 0) {
                currentPolyline = new kakao.maps.Polyline({ path: path, strokeWeight: 3, strokeColor: '#0000FF', strokeOpacity: 0.6 });
                currentPolyline.setMap(map); map.setBounds(bounds);
            }
        }

        function clearMapAndInfo() { markers.forEach(m => m.setMap(null)); markers = []; if(currentPolyline) currentPolyline.setMap(null); }

        // --- Admin & Navigation ---
        function loadUserList() {
            const list = document.getElementById('userList');
            database.ref('users').once('value').then(snap => {
                list.innerHTML = '<h2>User List</h2>';
                snap.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'user'; div.textContent = c.key;
                    div.onclick = () => loadUserDoorlockAndInit(c.key, () => selectUser(c.key));
                    list.appendChild(div);
                });
            });
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        window.searchUser = function() {
            const input = document.getElementById('search-input');
            const keyword = input.value.trim();
            const area = document.getElementById('result-area');

            if (!keyword) {
                customAlert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            area.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ê²€ìƒ‰ ì¤‘...</div>';

            database.ref('users').once('value').then(snap => {
                if (!snap.exists()) {
                    area.innerHTML = '<div style="padding:20px; text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                const allUsers = snap.val();
                const searchResult = {};
                let count = 0;

                for (const [userId, userData] of Object.entries(allUsers)) {
                    if (userId.toLowerCase().includes(keyword.toLowerCase())) {
                        searchResult[userId] = userData;
                        count++;
                    }
                }

                if (count > 0) {
                    renderGrid(searchResult);
                } else {
                    area.innerHTML = `<div style="padding:20px; text-align:center; color:#dc3545;">
                        '<strong>${keyword}</strong>' ê°€ í¬í•¨ëœ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>`;
                }

            }).catch(err => {
                console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", err);
                area.innerHTML = '<div style="padding:20px; text-align:center;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        };

        const searchInputObj = document.getElementById('search-input');
        if(searchInputObj) {
            searchInputObj.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    window.searchUser();
                }
            });
        }

        window.loadAllDBData = function() {
            const area = document.getElementById('result-area');
            area.innerHTML = 'ë¡œë”© ì¤‘...';
            database.ref('users').once('value').then(snap => {
                if(!snap.exists()) { area.innerHTML = 'ë°ì´í„° ì—†ìŒ'; return; }
                renderGrid(snap.val());
            });
        }
        
        // ì•„ì½”ë””ì–¸ í˜•íƒœë¡œ ë Œë”ë§
        function renderGrid(data) {
            const resultArea = document.getElementById('result-area');
            let html = '<div class="accordion-container">';
            
            for(const [userId, userData] of Object.entries(data)) {
                html += `
                    <div class="user-accordion-item">
                        <div class="user-accordion-header" onclick="toggleAccordion(this)">
                            <span>ğŸ‘¤ <strong>${userId}</strong></span>
                            <span class="icon-arrow">â–¼</span>
                        </div>
                        <div class="user-accordion-body hidden">
                            <div class="firebase-view">${createTreeView(userData, 0)}</div>
                        </div>
                    </div>
                `;
            }
            html += '</div>';
            resultArea.innerHTML = html;
        }

        // ì•„ì½”ë””ì–¸ í† ê¸€ ê¸°ëŠ¥
        window.toggleAccordion = function(header) {
            const currentBody = header.nextElementSibling;
            const isHidden = currentBody.classList.contains('hidden');

            const allHeaders = document.querySelectorAll('.user-accordion-header');
            const allBodies = document.querySelectorAll('.user-accordion-body');
            
            allHeaders.forEach(h => h.classList.remove('active-header'));
            allBodies.forEach(b => b.classList.add('hidden')); 

            if (isHidden) {
                header.classList.add('active-header');
                currentBody.classList.remove('hidden');
            }
        };

        function createTreeView(data, depth) {
            let html = '';
            const indent = '<span style="display:inline-block; width:' + (depth * 15) + 'px;"></span>';
            if (typeof data === 'object' && data !== null) {
                for (const [k, v] of Object.entries(data)) {
                    if (typeof v === 'object' && v !== null) {
                        html += `<div class="fv-item">${indent}<span class="fv-key" onclick="this.nextElementSibling.classList.toggle('fv-hidden')">â–¼ ${k}</span><div class="fv-children">${createTreeView(v, depth + 1)}</div></div>`;
                    } else {
                        html += `<div class="fv-item">${indent}<span class="fv-key">${k}:</span> <span class="fv-string">${v}</span></div>`;
                    }
                }
            } else {
                html += `<div class="fv-item">${indent}${data}</div>`;
            }
            return html;
        }

        // --- Event Listeners ---
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('username').value;
            const pw = document.getElementById('password').value;
            
            database.ref('admin_pass').once('value').then(snap => {
                let isAdmin = false;
                snap.forEach(c => { if(c.val().adminId===id && c.val().password===pw) isAdmin=true; });
                if(isAdmin) {
                    sessionStorage.setItem('isAdmin', 'true');
                    showMain(true, id);
                    return;
                }
                database.ref('users/' + id).once('value').then(usnap => {
                    if(usnap.exists() && usnap.val().password === pw) {
                        sessionStorage.setItem('isAdmin', 'false');
                        sessionStorage.setItem('userId', id);
                        showMain(false, id);
                    } else {
                        customAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                    }
                });
            });
        };

        function showMain(isAdmin, uid) {
            document.getElementById('login-container').classList.add('hidden'); // ë¡œê·¸ì¸ ìˆ¨ê¹€
            document.getElementById('header').classList.remove('hidden'); // í—¤ë” ë³´ì„
            document.getElementById('main-content').classList.remove('hidden'); // ë©”ì¸ ë³´ì„
            
            // ë‹«ê¸° ë²„íŠ¼ê³¼ DBì¡°íšŒ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
            const closeBtn = document.getElementById('closeUserInfoBtn');
            const dbBtn = document.getElementById('newBtn'); // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼

            DOORLOCK_LAT = 36.3308358;
            DOORLOCK_LNG = 127.3364818;
            
            if(isAdmin) {
                // --- ê´€ë¦¬ì ëª¨ë“œ ---
                document.getElementById('userList').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
                
                if(closeBtn) closeBtn.style.display = 'block'; // ë‹«ê¸° ë²„íŠ¼ ë³´ì„
                if(dbBtn) dbBtn.style.display = 'inline-block'; // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼ ë³´ì„

                if(window.kakao) kakao.maps.load(initMap);
            } else {
                // --- ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ ---
                document.getElementById('userList').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                
                if(closeBtn) closeBtn.style.display = 'none'; // ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€
                if(dbBtn) dbBtn.style.display = 'none'; // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼ ìˆ¨ê¹€

                if(window.kakao) kakao.maps.load(() => {
                    initMap();
                    loadUserDoorlockAndInit(uid, () => selectUser(uid));
                });
            }
            setupNav();
        }

        function setupNav() {
            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
            document.getElementById('logoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.remove('hidden');
            document.getElementById('confirmLogoutBtn').onclick = () => { sessionStorage.clear(); location.reload(); };
            document.getElementById('cancelLogoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.add('hidden');
            
            // íƒ€ì´í‹€ í´ë¦­ ì‹œ ì´ˆê¸° í™”ë©´ ì´ë™
            const headerTitle = document.getElementById('header-title');
            if(headerTitle) {
                headerTitle.style.cursor = 'pointer';
                headerTitle.onclick = () => window.location.reload();
            }

            document.getElementById('logBtn').onclick = () => {
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('db-content').classList.add('hidden');
                document.getElementById('log-content').classList.remove('hidden');
                document.getElementById('mapBtn').disabled = false;
                document.getElementById('logBtn').disabled = true;
                document.getElementById('newBtn').disabled = false;
                if(selectedUserId) loadAllLogs(selectedUserId);
            };
            
            document.getElementById('mapBtn').onclick = () => {
                document.getElementById('log-content').classList.add('hidden');
                document.getElementById('db-content').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('mapBtn').disabled = true;
                document.getElementById('logBtn').disabled = false;
                document.getElementById('newBtn').disabled = false;
                if(map) map.relayout();
            };

            document.getElementById('newBtn').onclick = () => {
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('log-content').classList.add('hidden');
                document.getElementById('db-content').classList.remove('hidden');
                document.getElementById('mapBtn').disabled = false;
                document.getElementById('logBtn').disabled = false;
                document.getElementById('newBtn').disabled = true;
                loadAllDBData();
            };
            
            document.getElementById('closeUserInfoBtn').onclick = () => {
                document.getElementById('userInfo').classList.add('hidden');
                clearMapAndInfo();
            };
        }

        // Auto Login Check
        if (sessionStorage.getItem('isAdmin')) {
            showMain(sessionStorage.getItem('isAdmin') === 'true', sessionStorage.getItem('userId'));
        } else {
            document.getElementById('login-container').classList.remove('hidden');
        }
    });
</script>
</body>
</html>




