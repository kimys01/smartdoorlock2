<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light only">
    <meta name="supported-color-schemes" content="light">
    <title>Smart Doorlock Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="indexstyle.css?v=3.0">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>

<body>

    <div id="login-container" class="hidden">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™">Smart Doorlock</h1>
        <div class="button-group">
            <button id="mapBtn" disabled>ì§€ë„</button>
            <button id="logBtn" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="newBtn">DB ì¡°íšŒ</button>
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" title="ë‹«ê¸°">âœ•</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <h2 id="logUserTitle">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">ë„ì–´ë½ ë¡œê·¸</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">ì•± ë¡œê·¸</button>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section active-tab-content">
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <h2>DataBase</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ID ì…ë ¥">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDBData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <h3 id="result-title">User List:</h3>
            <div id="result-area">
                <div style="padding:20px; text-align:center; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">í™•ì¸</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">í™•ì¸</button>
                <button id="cancelLogoutBtn" style="flex: 1; background-color: #aaa;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("App initialized.");

            // --- Global Variables ---
            let DOORLOCK_LAT = 37.566826;
            let DOORLOCK_LNG = 126.9786567;
            let MAX_DISTANCE_KM = 3.0;
            let database, map, doorlockMarker, currentPolyline, selectedUserId;
            let markers = [], zoneCircles = [], currentUserLocationLogs = [];

            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.web.app",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            try {
                if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase Load Fail");
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (e) {
                alert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");
                return;
            }

            // === Helper Functions ===
            function formatTimestamp(ts) {
                if (!ts) return 'ì‹œê°„ ì—†ìŒ';
                const date = new Date(ts);
                if (isNaN(date.getTime())) return ts;
                return date.toLocaleString('ko-KR', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                });
            }

            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * (Math.PI / 180);
                const dLon = (lon2 - lon1) * (Math.PI / 180);
                const a = Math.sin(dLat / 2) ** 2 +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                    Math.sin(dLon / 2) ** 2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            function customAlert(msg) {
                document.getElementById('modal-message').textContent = msg;
                document.getElementById('custom-modal').style.display = 'flex';
            }

            // === Core: Doorlock ìœ„ì¹˜ ë¡œë”© ===
            function loadUserDoorlockAndInit(userId, callback) {
                database.ref('users/' + userId).once('value').then((snap) => {
                    const user = snap.val();
                    if (!user || !user.my_doorlocks) throw new Error("ì—°ê²°ëœ ë„ì–´ë½ ì—†ìŒ");
                    const doorlockId = Object.keys(user.my_doorlocks)[0];
                    return database.ref('doorlocks/' + doorlockId).once('value');
                }).then((snap) => {
                    const dlData = snap.val();
                    if (dlData && dlData.location) {
                        DOORLOCK_LAT = parseFloat(dlData.location.latitude);
                        DOORLOCK_LNG = parseFloat(dlData.location.longitude);
                        if (map) {
                            map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                            drawDoorlockZones();
                        }
                    }
                    if (callback) callback();
                }).catch((err) => {
                    console.error(err);
                    if (callback) callback();
                });
            }

            // === Logs í™”ë©´ ===
            function loadAllLogs(userId) {
                const dlContainer = document.querySelector('#doorLockLogs .log-entries');
                const appContainer = document.querySelector('#appLogs .log-entries');
                document.getElementById('logUserTitle').textContent = `${userId}ì˜ ë¡œê·¸ ê¸°ë¡`;

                dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ë„ì–´ë½ ë¡œê·¸ ë¡œë”© ì¤‘...</div>';
                appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ì•± ë¡œê·¸ ë¡œë”© ì¤‘...</div>';

                database.ref('users/' + userId).once('value').then(userSnap => {
                    const user = userSnap.val();

                    // ì•± ë¡œê·¸
                    database.ref(`users/${userId}/app_logs`).once('value').then(snap => {
                        if (!snap.exists()) {
                            appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ì•± ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        } else {
                            appContainer.innerHTML = '';
                            const logs = [];
                            snap.forEach(c => logs.push(c.val()));
                            
                            // [ìˆ˜ì •ë¨] ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì˜›ë‚  -> ìµœì‹ )
                            logs.sort((a, b) => (new Date(a.timestamp || 0)) - (new Date(b.timestamp || 0)));

                            logs.forEach(log => {
                                const div = document.createElement('div');
                                div.className = 'log-card status-app';
                                let title = log.message || log.event || "ì•± í™œë™";
                                let detail = "";
                                if (log.new_auth) detail = `ì¸ì¦ ë°©ì‹: ${log.new_auth}`;
                                else if (log.detailSettings) detail = JSON.stringify(log.detailSettings).replace(/["{}]/g, "").replace(/,/g, ", ");
                                else if (!title) detail = JSON.stringify(log).replace(/["{}]/g, "");

                                div.innerHTML = `
                                  <div class="log-header-row"><span>ğŸ•’ ${formatTimestamp(log.timestamp)}</span><span>ğŸ“± App</span></div>
                                  <div class="log-body-row"><span style="font-weight:600; color:#333; font-size:15px;">${title}</span></div>
                                  ${detail ? `<div class="log-detail-box">${detail}</div>` : ''}
                                `;
                                appContainer.appendChild(div);
                            });
                        }
                    });

                    // ë„ì–´ë½ ë¡œê·¸
                    let doorlockIds = [];
                    if (user && user.my_doorlocks) doorlockIds = Object.keys(user.my_doorlocks);
                    if (doorlockIds.length === 0) {
                        dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#dc3545;">ì—°ê²°ëœ ë„ì–´ë½ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    } else {
                        const promises = doorlockIds.map(id => database.ref(`doorlocks/${id}/logs`).once('value'));
                        Promise.all(promises).then(snapshots => {
                            let allLogs = [];
                            snapshots.forEach(snap => {
                                if (snap.exists()) snap.forEach(c => allLogs.push(c.val()));
                            });
                            if (allLogs.length === 0) {
                                dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ê¸°ë¡ ì—†ìŒ</div>';
                            } else {
                                dlContainer.innerHTML = '';
                                // [ìˆ˜ì •ë¨] ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì˜›ë‚  -> ìµœì‹ )
                                allLogs.sort((a, b) => (new Date(a.timestamp || a.time || 0)) - (new Date(b.timestamp || b.time || 0)));

                                allLogs.forEach(log => {
                                    const div = document.createElement('div');
                                    const who = log.user || log.userId || log.id || "ì•Œ ìˆ˜ ì—†ìŒ";
                                    const timeValue = log.timestamp || log.time || log.date || log.datetime || log.created_at;
                                    let methodRaw = String(log.method || log.auth || log.type || log.category || "unknown").toUpperCase();
                                    let methodDisp = "ê¸°íƒ€", methodIcon = "ğŸ”‘";

                                    if (methodRaw.includes("PW") || methodRaw.includes("PASS")) { methodDisp = "ë¹„ë°€ë²ˆí˜¸"; methodIcon = "ğŸ”¢"; }
                                    else if (methodRaw.includes("RF") || methodRaw.includes("CARD") || methodRaw.includes("TAG")) { methodDisp = "ì¹´ë“œí‚¤"; methodIcon = "ğŸ’³"; }
                                    else if (methodRaw.includes("APP") || methodRaw.includes("BLE") || methodRaw.includes("PHONE")) { methodDisp = "ì•±(ë¸”ë£¨íˆ¬ìŠ¤)"; methodIcon = "ğŸ“±"; }
                                    else if (methodRaw.includes("FINGER") || methodRaw.includes("BIO")) { methodDisp = "ì§€ë¬¸"; methodIcon = "ğŸ‘†"; }

                                    let actionRaw = String(log.command || log.status || log.state || log.action || log.event || log.msg || "ì•Œ ìˆ˜ ì—†ìŒ").toUpperCase();
                                    let actionDisp = actionRaw, actionIcon = "â“";
                                    let statusColor = "#333", statusBg = "#fff";

                                    if (actionRaw.includes("UNLOCK") || actionRaw.includes("OPEN") || actionRaw === "1" || actionRaw === "TRUE" || actionRaw.includes("SUCCESS")) {
                                        actionDisp = "ë¬¸ ì—´ë¦¼"; actionIcon = "ğŸ”“"; statusColor = "#007bff"; statusBg = "#e7f3ff";
                                    } else if (actionRaw.includes("LOCK") || actionRaw.includes("CLOSE") || actionRaw === "0" || actionRaw === "FALSE") {
                                        actionDisp = "ë¬¸ ì ê¹€"; actionIcon = "ğŸ”’"; statusColor = "#dc3545"; statusBg = "#ffeef0";
                                    } else if (actionRaw.includes("WARN") || actionRaw.includes("ALERT") || actionRaw.includes("FAIL")) {
                                        actionDisp = "ê²½ê³ /ì‹¤íŒ¨"; actionIcon = "ğŸš¨"; statusColor = "#ffc107"; statusBg = "#fff3cd";
                                    }

                                    div.className = "log-card";
                                    div.style.borderLeftColor = statusColor;
                                    div.innerHTML = `
                              <div style="font-size:12px;color:#888;margin-bottom:8px;border-bottom:1px solid #f0f0f0;padding-bottom:5px;">
                                ğŸ•’ ${formatTimestamp(timeValue)}
                              </div>
                              <div style="display:flex;justify-content:space-between;align-items:center;">
                                <div style="display:flex;gap:8px;align-items:center;">
                                  <span style="background:#f5f5f5;padding:4px 10px;border-radius:20px;font-size:13px;font-weight:600;color:#444;">ğŸ‘¤ ${who}</span>
                                  <span style="background:#f0f7ff;padding:4px 10px;border-radius:20px;font-size:13px;font-weight:600;color:#0056b3;">${methodIcon} ${methodDisp}</span>
                                </div>
                                <div style="background:${statusBg};padding:5px 12px;border-radius:8px;font-weight:bold;font-size:14px;color:${statusColor};display:flex;align-items:center;gap:5px;">
                                  ${actionIcon} ${actionDisp}
                                </div>
                              </div>
                            `;
                                    dlContainer.appendChild(div);
                                });
                            }
                        });
                    }
                });
            }

            // --- íƒ­ ì „í™˜ ---
            window.switchLogTab = function (tabName) {
                document.querySelectorAll('.log-tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');
                document.querySelectorAll('.log-section').forEach(s => s.classList.remove('active-tab-content'));
                if (tabName === 'doorlock') document.getElementById('doorLockLogs').classList.add('active-tab-content');
                else document.getElementById('appLogs').classList.add('active-tab-content');
            };

            // --- Map ---
            function initMap() {
                const container = document.getElementById('map');
                map = new kakao.maps.Map(container, {
                    center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG),
                    level: 7
                });
                drawDoorlockZones();
                const role = sessionStorage.getItem('role');
                if (role === 'ADMIN') loadUserList();
            }

            function drawDoorlockZones() {
                if (!map) return;
                if (doorlockMarker) doorlockMarker.setMap(null);
                zoneCircles.forEach(c => c.setMap(null)); zoneCircles = [];
                const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
                doorlockMarker = new kakao.maps.Marker({ position: pos, map: map, title: "ë„ì–´ë½" });
                [1000, 2000, 3000].forEach((r, i) => {
                    const color = i === 0 ? '#FF0000' : (i === 1 ? '#FFA500' : '#008000');
                    const circle = new kakao.maps.Circle({
                        center: pos, radius: r, strokeWeight: 1,
                        strokeColor: color, strokeStyle: 'dashed',
                        fillColor: color, fillOpacity: 0.1
                    });
                    circle.setMap(map); zoneCircles.push(circle);
                });
            }

            function selectUser(userId) {
                const role = sessionStorage.getItem('role'); // 'ADMIN' | 'USER'
                selectedUserId = userId;

                // ê³µí†µ: ì§€ë„/ë¡œê·¸ì— ì„ íƒëœ ì‚¬ìš©ì ë°˜ì˜
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('infoArea').innerHTML = `
            <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
            <div class="filter-group">
                <button id="btnAll" class="filter-btn active">ì „ì²´</button>
                <button id="btnRange" class="filter-btn">ë²”ìœ„ ë‚´</button>
            </div>
            <div class="log-list" id="miniLogList">ë¡œë”© ì¤‘...</div>
        `;

                // ì‚¬ìš©ì ëª¨ë“œì—ì„œë§Œ: logBtn í™œì„±í™” (ê´€ë¦¬ìëŠ” ì „ì²´ ë¡œê·¸ ë²„íŠ¼ í•­ìƒ ì‚¬ìš©)
                if (role === 'USER') {
                    document.getElementById('logBtn').disabled = false;
                }

                document.getElementById('btnAll').onclick = () => {
                    document.getElementById('btnAll').classList.add('active');
                    document.getElementById('btnRange').classList.remove('active');
                    renderLocationLogs(false);
                };
                document.getElementById('btnRange').onclick = () => {
                    document.getElementById('btnRange').classList.add('active');
                    document.getElementById('btnAll').classList.remove('active');
                    renderLocationLogs(true);
                };

                database.ref(`users/${userId}/location_logs`).once('value').then(snap => {
                    currentUserLocationLogs = [];
                    if (snap.exists()) {
                        snap.forEach(c => { if (c.val().latitude) currentUserLocationLogs.push(c.val()); });
                        // [ìˆ˜ì •ë¨] ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ì˜›ë‚  -> ìµœì‹ )
                        currentUserLocationLogs.sort((a, b) => {
                            const timeA = new Date(a.timestamp || 0).getTime();
                            const timeB = new Date(b.timestamp || 0).getTime();
                            return timeA - timeB;
                        });
                    }
                    renderLocationLogs(false);
                    // ì„ íƒ í›„ ì§€ë„ ì„¼í„°/ì¤Œ ì¬ì •ë ¬
                    if (map) {
                        map.relayout();
                        map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                    }
                });
            }

            function renderLocationLogs(filter) {
                const listDiv = document.getElementById('miniLogList');
                listDiv.innerHTML = '';
                markers.forEach(m => { if (m.customOverlay) m.customOverlay.setMap(null); m.setMap(null); });
                markers = [];
                if (currentPolyline) currentPolyline.setMap(null);

                if (currentUserLocationLogs.length === 0) {
                    listDiv.innerHTML = 'ê¸°ë¡ ì—†ìŒ';
                    return;
                }

                let path = [];
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));

                currentUserLocationLogs.forEach(pos => {
                    const lat = parseFloat(pos.latitude);
                    const lng = parseFloat(pos.longitude);
                    const dist = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                    if (filter && dist > MAX_DISTANCE_KM) return;

                    const div = document.createElement('div');
                    div.className = 'log-entry';
                    div.innerHTML = `${formatTimestamp(pos.timestamp)} <br> ê±°ë¦¬: <strong>${dist.toFixed(2)}km</strong>`;
                    div.onclick = () => {
                        map.setCenter(new kakao.maps.LatLng(lat, lng));
                        map.setLevel(4);
                    };
                    listDiv.appendChild(div);

                    if (path.length < 50) {
                        const p = new kakao.maps.LatLng(lat, lng);
                        path.push(p);
                        bounds.extend(p);
                        const dot = document.createElement('div');
                        dot.style.width = '8px'; dot.style.height = '8px';
                        dot.style.background = 'blue'; dot.style.borderRadius = '50%';
                        const m = new kakao.maps.CustomOverlay({ position: p, content: dot, yAnchor: 0.5 });
                        m.setMap(map); markers.push(m);
                    }
                });

                listDiv.scrollTop = 0;

                if (path.length > 0) {
                    currentPolyline = new kakao.maps.Polyline({
                        path: path,
                        strokeWeight: 3,
                        strokeColor: '#0000FF',
                        strokeOpacity: 0.6
                    });
                    currentPolyline.setMap(map);
                    map.setBounds(bounds);
                }
            }

            function clearMapAndInfo() {
                markers.forEach(m => m.setMap(null));
                markers = [];
                if (currentPolyline) currentPolyline.setMap(null);
            }

            function loadUserList() {
                const list = document.getElementById('userList');
                database.ref('users').once('value').then(snap => {
                    list.innerHTML = '<h2>User List</h2>';
                    snap.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'user';
                        div.textContent = c.key;
                        div.onclick = () => loadUserDoorlockAndInit(c.key, () => selectUser(c.key));
                        list.appendChild(div);
                    });
                });
            }

            // --- ë¡œê·¸ì¸ ì²˜ë¦¬ ---
            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('username').value;
                const pw = document.getElementById('password').value;

                database.ref('admin_pass').once('value').then(snap => {
                    let isAdmin = false;
                    snap.forEach(c => {
                        if (c.val().adminId === id && c.val().password === pw) isAdmin = true;
                    });

                    if (isAdmin) {
                        sessionStorage.setItem('role', 'ADMIN');
                        sessionStorage.setItem('userId', id);
                        showMain('ADMIN', id);
                        return;
                    }

                    database.ref('users/' + id).once('value').then(usnap => {
                        if (usnap.exists() && usnap.val().password === pw) {
                            sessionStorage.setItem('role', 'USER');
                            sessionStorage.setItem('userId', id);
                            showMain('USER', id);
                        } else {
                            customAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                        }
                    });
                });
            };

            // === ì—­í•  ê¸°ë°˜ ë©”ì¸ í™”ë©´ ì „í™˜ ===
            function showMain(role, uid) {
                const body = document.body;
                const login = document.getElementById('login-container');
                const header = document.getElementById('header');
                const main = document.getElementById('main-content');
                const userInfo = document.getElementById('userInfo');
                const userList = document.getElementById('userList');
                const closeBtn = document.getElementById('closeUserInfoBtn');
                const dbBtn = document.getElementById('newBtn');

                login.classList.add('hidden');
                header.classList.remove('hidden');
                main.classList.remove('hidden');

                if (role === 'ADMIN') {
                    // ê´€ë¦¬ì ëª¨ë“œ
                    body.classList.remove('user-mode');

                    userList.classList.remove('hidden');
                    userInfo.classList.add('hidden');

                    if (closeBtn) closeBtn.style.display = 'block';
                    if (dbBtn) dbBtn.style.display = 'inline-block';

                    if (window.kakao) kakao.maps.load(initMap);

                    // ê´€ë¦¬ì: logBtn/mapBtn/newBtn ê¸°ë³¸ ìƒíƒœ
                    document.getElementById('mapBtn').disabled = true;
                    document.getElementById('logBtn').disabled = true;
                    document.getElementById('newBtn').disabled = false;

                } else {
                    // ì‚¬ìš©ì ëª¨ë“œ
                    body.classList.add('user-mode');

                    userList.classList.add('hidden');
                    userInfo.classList.remove('hidden');

                    if (closeBtn) closeBtn.style.display = 'none';
                    if (dbBtn) dbBtn.style.display = 'none';

                    if (window.kakao) kakao.maps.load(() => {
                        initMap();
                        loadUserDoorlockAndInit(uid, () => selectUser(uid));
                    });

                    // ì‚¬ìš©ì: ì§€ë„ ë¨¼ì €, ë¡œê·¸ ë²„íŠ¼ì€ ì„ íƒ í›„ í™œì„±í™”
                    document.getElementById('mapBtn').disabled = true;
                    document.getElementById('logBtn').disabled = true;
                    document.getElementById('newBtn').disabled = true;
                }

                setupNav();
            }

            function setupNav() {
                document.getElementById('logoutBtn').onclick = () =>
                    document.getElementById('logout-confirm-modal').classList.remove('hidden');

                document.getElementById('confirmLogoutBtn').onclick = () => {
                    sessionStorage.clear();
                    location.reload();
                };
                document.getElementById('cancelLogoutBtn').onclick = () =>
                    document.getElementById('logout-confirm-modal').classList.add('hidden');

                const headerTitle = document.getElementById('header-title');
                headerTitle.style.cursor = 'pointer';
                headerTitle.onclick = () => window.location.reload();

                document.getElementById('logBtn').onclick = () => {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('db-content').classList.add('hidden');
                    document.getElementById('log-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = false;
                    document.getElementById('logBtn').disabled = true;
                    document.getElementById('newBtn').disabled = false;
                    if (selectedUserId) loadAllLogs(selectedUserId);
                };

                document.getElementById('mapBtn').onclick = () => {
                    document.getElementById('log-content').classList.add('hidden');
                    document.getElementById('db-content').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = true;
                    document.getElementById('logBtn').disabled = false;
                    document.getElementById('newBtn').disabled = false;
                    if (map) map.relayout();
                };

                document.getElementById('newBtn').onclick = () => {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('log-content').classList.add('hidden');
                    document.getElementById('db-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = false;
                    document.getElementById('logBtn').disabled = false;
                    document.getElementById('newBtn').disabled = true;
                    loadAllDBData();
                };

                document.getElementById('closeUserInfoBtn').onclick = () => {
                    document.getElementById('userInfo').classList.add('hidden');
                    clearMapAndInfo();
                };
            }

            // === ì¶”ê°€ëœ DB ì¡°íšŒ ê´€ë ¨ í•¨ìˆ˜ë“¤ ===
            window.loadAllDBData = function () {
                const resultArea = document.getElementById('result-area');
                resultArea.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';

                database.ref('users').once('value').then(snap => {
                    if (!snap.exists()) {
                        resultArea.innerHTML = '<div style="padding:20px; text-align:center;">ë°ì´í„° ì—†ìŒ</div>';
                        return;
                    }
                    renderDBList(snap);
                });
            }

            window.searchUser = function () {
                const input = document.getElementById('search-input').value.trim();
                if (!input) {
                    alert("IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                    return;
                }

                const resultArea = document.getElementById('result-area');
                resultArea.innerHTML = 'ë¡œë”© ì¤‘...';

                database.ref('users/' + input).once('value').then(snap => {
                    if (!snap.exists()) {
                        resultArea.innerHTML = '<div style="padding:20px; text-align:center;">ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }
                    const data = {};
                    data[snap.key] = snap.val();
                    renderDBList({ val: () => data, forEach: (cb) => { cb({ key: snap.key, val: () => snap.val() }); } });
                });
            }

            function renderDBList(snapshot) {
                const resultArea = document.getElementById('result-area');
                resultArea.innerHTML = '';

                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.innerHTML = `
            <tr style="background:#f0f0f0; border-bottom:2px solid #ddd;">
                <th style="padding:10px; text-align:left;">User ID</th>
                <th style="padding:10px; text-align:left;">Name / Info</th>
                <th style="padding:10px; text-align:left;">Doorlocks</th>
            </tr>
        `;

                snapshot.forEach(child => {
                    const user = child.val();
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';

                    const doorlocks = user.my_doorlocks ? Object.keys(user.my_doorlocks).join(', ') : 'ì—†ìŒ';

                    tr.innerHTML = `
                <td style="padding:10px;">${child.key}</td>
                <td style="padding:10px;">${user.name || 'ì´ë¦„ ì—†ìŒ'}</td>
                <td style="padding:10px;">${doorlocks}</td>
            `;
                    table.appendChild(tr);
                });
                resultArea.appendChild(table);
            }

            // --- Auto Login ---
            const savedRole = sessionStorage.getItem('role'); // 'ADMIN' | 'USER' | null
            const savedUid = sessionStorage.getItem('userId');
            if (savedRole && savedUid) {
                showMain(savedRole, savedUid);
            } else {
                document.getElementById('login-container').classList.remove('hidden');
            }
        });
    </script>
</body>

</html>
