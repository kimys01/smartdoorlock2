<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Doorlock - Demo</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
  <header id="header" class="hidden">
    <h1>Smart Doorlock</h1>
    <div class="button-group">
      <button id="mapBtn" disabled>지도</button>
      <button id="logBtn" disabled>로그 보기</button>
      <button id="dbBtn">DB 조회</button>
      <button id="logoutBtn">로그아웃</button>
    </div>
  </header>

  <main>
    <section id="login-container">
      <h2>SmartDoorLock</h2>
      <form id="login-form">
        <label>아이디
          <input id="username" type="text" required />
        </label>
        <label>비밀번호
          <input id="password" type="password" required />
        </label>
        <button type="submit">로그인</button>
      </form>
      <div id="login-note" class="note"></div>
    </section>

    <section id="main-content" class="hidden">
      <aside id="sidebar">
        <div id="userList"><h3>User List</h3></div>
      </aside>
      <section id="mapArea">
        <h3>Map</h3>
        <div id="map"></div>
      </section>
    </section>

    <section id="log-content" class="hidden">
      <h3 id="logUserTitle">전체 로그</h3>
      <div id="doorLockLogs"></div>
      <div id="appLogs"></div>
      <button id="backToMain">뒤로</button>
    </section>

    <section id="db-content" class="hidden">
      <h3>DataBase</h3>
      <input id="search-input" placeholder="검색할 사용자 ID 입력" />
      <button id="searchBtn">검색</button>
      <button id="allBtn">전체 목록</button>
      <div id="result-area"></div>
      <button id="dbBack">뒤로</button>
    </section>
  </main>

  <div id="modal" class="hidden">
    <div class="modal-inner">
      <p id="modal-text"></p>
      <button id="modal-close">확인</button>
    </div>
  </div>

  <script>
  // --- app.js 내용 (내장) ---
  document.addEventListener('DOMContentLoaded', () => {
    const loginForm = document.getElementById('login-form');
    const loginNote = document.getElementById('login-note');
    const header = document.getElementById('header');
    const mainContent = document.getElementById('main-content');
    const mapBtn = document.getElementById('mapBtn');
    const logBtn = document.getElementById('logBtn');
    const dbBtn = document.getElementById('dbBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const firebaseConfig = {
      apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
      authDomain: "smartdoorlock-b4636.web.app",
      databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
      projectId: "smartdoorlock-b4636",
      storageBucket: "smartdoorlock-b4636.firebasestorage.app",
      messagingSenderId: "104489505270",
      appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
      measurementId: "G-4TH9MB9WPM"
    };

    try {
      if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error('Firebase SDK 로드 실패');
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      window.database = firebase.database();
    } catch (err) {
      console.error('Firebase init error:', err);
      loginNote.textContent = 'Firebase 초기화 실패. 네트워크 또는 스크립트 로드 확인.';
      return;
    }

    loginForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      loginNote.textContent = '';
      const id = document.getElementById('username').value.trim();
      const pw = document.getElementById('password').value;

      if (!id || !pw) { loginNote.textContent = '아이디와 비밀번호를 입력하세요.'; return; }

      database.ref('admin_pass').once('value').then(snap => {
        let isAdmin = false;
        snap.forEach(child => {
          const v = child.val();
          if (v && v.adminId === id && v.password === pw) isAdmin = true;
        });

        if (isAdmin) {
          sessionStorage.setItem('isAdmin', 'true');
          sessionStorage.setItem('userId', id);
          onLoginSuccess(true, id);
          return;
        }

        return database.ref('users/' + id).once('value').then(userSnap => {
          if (!userSnap.exists()) throw new Error('사용자 없음');
          const user = userSnap.val();
          if (user.password === pw) {
            sessionStorage.setItem('isAdmin', 'false');
            sessionStorage.setItem('userId', id);
            onLoginSuccess(false, id);
          } else {
            throw new Error('비밀번호 불일치');
          }
        });
      }).catch(err => {
        console.error('로그인 오류:', err);
        loginNote.textContent = '로그인 실패: ' + (err.message || '알 수 없는 오류');
      });
    });

    function onLoginSuccess(isAdmin, uid) {
      document.getElementById('login-container').classList.add('hidden');
      header.classList.remove('hidden');
      mainContent.classList.remove('hidden');
      mapBtn.disabled = false;
      logBtn.disabled = false;
      if (isAdmin) loadUserList();
    }

    function loadUserList() {
      const list = document.getElementById('userList');
      list.innerHTML = '<h3>User List</h3><div>로딩 중...</div>';
      database.ref('users').once('value').then(snap => {
        list.innerHTML = '<h3>User List</h3>';
        snap.forEach(child => {
          const id = child.key;
          const div = document.createElement('div');
          div.textContent = id;
          div.className = 'user';
          div.onclick = () => alert('사용자 선택: ' + id);
          list.appendChild(div);
        });
      }).catch(err => {
        console.error('유저 목록 로드 실패', err);
        list.innerHTML = '<h3>User List</h3><div>로드 실패</div>';
      });
    }

    mapBtn.addEventListener('click', () => {
      document.getElementById('main-content').classList.remove('hidden');
      document.getElementById('log-content').classList.add('hidden');
      document.getElementById('db-content').classList.add('hidden');
    });
    logBtn.addEventListener('click', () => {
      document.getElementById('log-content').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    });
    dbBtn.addEventListener('click', () => {
      if (sessionStorage.getItem('isAdmin') !== 'true') {
        showModal('관리자만 DB 조회가 가능합니다.');
        return;
      }
      document.getElementById('db-content').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
    });
    logoutBtn.addEventListener('click', () => {
      sessionStorage.clear();
      location.reload();
    });

    const modal = document.getElementById('modal');
    const modalText = document.getElementById('modal-text');
    document.getElementById('modal-close').addEventListener('click', () => modal.classList.add('hidden'));
    function showModal(msg) { modalText.textContent = msg; modal.classList.remove('hidden'); }
  });
  </script>
</body>
</html>
