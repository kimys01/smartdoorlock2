<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="color-scheme" content="light only">
    <meta name="supported-color-schemes" content="light">

    <title>Smart Doorlock Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="indexstyle.css?v=3.0">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container" class="hidden">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" title="ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ì´ë™">Smart Doorlock</h1> 
        <div class="button-group">
            <button id="mapBtn" disabled>ì§€ë„</button>
            <button id="logBtn" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="newBtn">DB ì¡°íšŒ</button>
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" title="ë‹«ê¸°">âœ•</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div> 
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <h2 id="logUserTitle">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">ë„ì–´ë½ ë¡œê·¸</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">ì•± ë¡œê·¸</button>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section active-tab-content">
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <h2>DataBase</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ID ì…ë ¥">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDBData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <h3 id="result-title">User List:</h3>
            <div id="result-area">
                <div style="padding:20px; text-align:center; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">í™•ì¸</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">í™•ì¸</button>
                <button id="cancelLogoutBtn" style="flex: 1; background-color: #aaa;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  console.log("App initialized.");

Â  Â  Â  Â  // --- Global Variables ---
Â  Â  Â  Â  let DOORLOCK_LAT = 36.3308358;Â  Â 
Â  Â  Â  Â  let DOORLOCK_LNG = 127.3364818;
Â  Â  Â  Â  let MAX_DISTANCE_KM = 3.0;
Â  Â  Â  Â  let database, map, doorlockMarker, currentPolyline, selectedLogMarker, selectedUserId;
Â  Â  Â  Â  let markers = [], zoneCircles = [], currentUserLocationLogs = [];

Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
Â  Â  Â  Â  Â  Â  authDomain: "smartdoorlock-b4636.web.app",Â 
Â  Â  Â  Â  Â  Â  databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
Â  Â  Â  Â  Â  Â  projectId: "smartdoorlock-b4636",
Â  Â  Â  Â  Â  Â  storageBucket: "smartdoorlock-b4636.firebasestorage.app",
Â  Â  Â  Â  Â  Â  messagingSenderId: "104489505270",
Â  Â  Â  Â  Â  Â  appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
Â  Â  Â  Â  Â  Â  measurementId: "G-4TH9MB9WPM"
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase Load Fail");
Â  Â  Â  Â  Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  Â  Â  Â  Â  database = firebase.database();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  // alert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”."); // alert ëŒ€ì‹  customAlert ì‚¬ìš©
            customAlert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Helper Functions ---
Â  Â  Â  Â  function formatTimestamp(ts) {
Â  Â  Â  Â  Â  Â  if (!ts) return 'ì‹œê°„ ì—†ìŒ';
Â  Â  Â  Â  Â  Â  const date = new Date(ts);
Â  Â  Â  Â  Â  Â  if (isNaN(date.getTime())) return ts;Â 
Â  Â  Â  Â  Â  Â  return date.toLocaleString('ko-KR', {
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric', month: '2-digit', day: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
Â  Â  Â  Â  Â  Â  const R = 6371;Â 
Â  Â  Â  Â  Â  Â  const dLat = (lat2-lat1) * (Math.PI/180);
Â  Â  Â  Â  Â  Â  const dLon = (lon2-lon1) * (Math.PI/180);Â 
Â  Â  Â  Â  Â  Â  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);Â 
Â  Â  Â  Â  Â  Â  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function customAlert(msg) {
Â  Â  Â  Â  Â  Â  document.getElementById('modal-message').textContent = msg;
Â  Â  Â  Â  Â  Â  document.getElementById('custom-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Core Logic ---
Â  Â  Â  Â  function loadUserDoorlockAndInit(userId, callback) {
Â  Â  Â  Â  Â  Â  database.ref('users/' + userId).once('value').then((snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const user = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (!user || !user.my_doorlocks) throw new Error("ì—°ê²°ëœ ë„ì–´ë½ ì—†ìŒ");
Â  Â  Â  Â  Â  Â  Â  Â  const doorlockKeys = Object.keys(user.my_doorlocks);
Â  Â  Â  Â  Â  Â  Â  Â  const doorlockId = doorlockKeys[0];Â 
Â  Â  Â  Â  Â  Â  Â  Â  return database.ref('doorlocks/' + doorlockId).once('value');
Â  Â  Â  Â  Â  Â  }).then((snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const dlData = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  if (dlData && dlData.location) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DOORLOCK_LAT = parseFloat(dlData.location.latitude);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DOORLOCK_LNG = parseFloat(dlData.location.longitude);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (map) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  drawDoorlockZones();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (callback) callback();
Â  Â  Â  Â  Â  Â  }).catch((err) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  if (callback) callback();Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Load Logs Logic ---
Â  Â  Â  Â  function loadAllLogs(userId) {
Â  Â  Â  Â  Â  Â  const dlContainer = document.querySelector('#doorLockLogs .log-entries');
Â  Â  Â  Â  Â  Â  const appContainer = document.querySelector('#appLogs .log-entries');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // [ìˆ˜ì •ë¨] í…ìŠ¤íŠ¸ ë³€ê²½: "ì „ì²´ ë¡œê·¸ ê¸°ë¡" -> "ì˜ ë¡œê·¸ ê¸°ë¡"
Â  Â  Â  Â  Â  Â  document.getElementById('logUserTitle').textContent = `${userId}ì˜ ë¡œê·¸ ê¸°ë¡`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ë„ì–´ë½ ë¡œê·¸ ë¡œë”© ì¤‘...</div>';
Â  Â  Â  Â  Â  Â  appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ì•± ë¡œê·¸ ë¡œë”© ì¤‘...</div>';

Â  Â  Â  Â  Â  Â  database.ref('users/' + userId).once('value').then((userSnap) => {
Â  Â  Â  Â  Â  Â  Â  Â  const user = userSnap.val();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // 1. APP LOGS
Â  Â  Â  Â  Â  Â  Â  Â  database.ref(`users/${userId}/app_logs`).once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ì•± ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const logs = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(childSnapshot => { logs.push(childSnapshot.val()); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logs.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return timeB - timeA;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logs.forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'log-card status-app';Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let title = "ì•± í™œë™"; let detail = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log.message) title = log.message;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (log.event) title = log.event;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (log.new_auth) { title = "ì¸ì¦ ë°©ì‹ ë³€ê²½"; detail = `ê°’: ${log.new_auth}`; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (log.detailSettings) { title = "ì„¤ì • ë³€ê²½"; detail = JSON.stringify(log.detailSettings).replace(/["{}]/g, "").replace(/,/g, ", "); }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else { detail = JSON.stringify(log).replace(/["{}]/g, ""); }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.backgroundColor = "#fff"; div.style.marginBottom = "10px";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.padding = "10px"; div.style.borderRadius = "8px";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.boxShadow = "0 2px 4px rgba(0,0,0,0.1)"; div.style.borderLeft = "5px solid #28a745";Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="log-header-row"><span>ğŸ•’ ${formatTimestamp(log.timestamp)}</span><span>ğŸ“± App</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="log-body-row"><span style="font-weight:600; color:#333; font-size:15px;">${title}</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${detail ? `<div class="log-detail-box">${detail}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  appContainer.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 2. DOORLOCK LOGS
Â  Â  Â  Â  Â  Â  Â  Â  let doorlockIds = [];
Â  Â  Â  Â  Â  Â  Â  Â  if (user && user.my_doorlocks) { doorlockIds = Object.keys(user.my_doorlocks); }

Â  Â  Â  Â  Â  Â  Â  Â  if (doorlockIds.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#dc3545;">ì—°ê²°ëœ ë„ì–´ë½ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const promises = doorlockIds.map(id => database.ref(`doorlocks/${id}/logs`).once('value'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Promise.all(promises).then(snapshots => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let allLogs = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snapshots.forEach(snap => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (snap.exists()) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(c => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const val = c.val();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allLogs.push(val);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (allLogs.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ê¸°ë¡ ì—†ìŒ</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dlContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allLogs.sort((a, b) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeAStr = a.timestamp || a.time || a.date || a.datetime || a.created_at || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeBStr = b.timestamp || b.time || b.date || b.datetime || b.created_at || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeA = new Date(timeAStr).getTime() || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timeB = new Date(timeBStr).getTime() || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return timeB - timeA;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allLogs.forEach(log => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let who = log.user || log.userId || log.id || log.who || log.name || "ì•Œ ìˆ˜ ì—†ìŒ";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let timeValue = log.timestamp || log.time || log.date || log.datetime || log.created_at;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let methodRawValue = log.method || log.auth || log.type || log.category || "unknown";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let methodRaw = String(methodRawValue).toUpperCase();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let methodDisp = methodRawValue;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let methodIcon = "ğŸ”‘";Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (methodRaw.includes("PW") || methodRaw.includes("PASS")) { methodDisp = "ë¹„ë°€ë²ˆí˜¸"; methodIcon = "ğŸ”¢"; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (methodRaw.includes("RF") || methodRaw.includes("CARD") || methodRaw.includes("TAG")) { methodDisp = "ì¹´ë“œí‚¤"; methodIcon = "ğŸ’³"; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (methodRaw.includes("APP") || methodRaw.includes("BLE") || methodRaw.includes("BLUE") || methodRaw.includes("PHONE")) { methodDisp = "ì•±(ë¸”ë£¨íˆ¬ìŠ¤)"; methodIcon = "ğŸ“±"; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (methodRaw.includes("FINGER") || methodRaw.includes("BIO")) { methodDisp = "ì§€ë¬¸"; methodIcon = "ğŸ‘†"; }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionRawValue = log.command || log.status || log.state || log.action || log.event || log.msg || "ì•Œ ìˆ˜ ì—†ìŒ";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionRaw = String(actionRawValue).toUpperCase();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionDisp = actionRawValue;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let actionIcon = "â“";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let statusColor = "#333"; let statusBg = "#fff";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (actionRaw.includes("UNLOCK") || actionRaw.includes("OPEN") || actionRaw === "1" || actionRaw === "TRUE" || actionRaw.includes("SUCCESS")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionDisp = "ë¬¸ ì—´ë¦¼"; actionIcon = "ğŸ”“"; statusColor = "#007bff"; statusBg = "#e7f3ff";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (actionRaw.includes("LOCK") || actionRaw.includes("CLOSE") || actionRaw === "0" || actionRaw === "FALSE") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionDisp = "ë¬¸ ì ê¹€"; actionIcon = "ğŸ”’"; statusColor = "#dc3545"; statusBg = "#ffeef0";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (actionRaw.includes("WARN") || actionRaw.includes("ALERT") || actionRaw.includes("FAIL")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionDisp = "ê²½ê³ /ì‹¤íŒ¨"; actionIcon = "ğŸš¨"; statusColor = "#ffc107"; statusBg = "#fff3cd";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.backgroundColor = "#fff"; div.style.marginBottom = "12px";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.padding = "12px 16px"; div.style.borderRadius = "12px";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.boxShadow = "0 2px 8px rgba(0,0,0,0.08)";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.style.borderLeft = `5px solid ${statusColor}`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 12px; color: #888; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ•’ ${formatTimestamp(timeValue)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="display: flex; gap: 8px; align-items: center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: #f5f5f5; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #444;">ğŸ‘¤ ${who}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="background: #f0f7ff; padding: 4px 10px; border-radius: 20px; font-size: 13px; font-weight: 600; color: #0056b3;">${methodIcon} ${methodDisp}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="background: ${statusBg}; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 14px; color: ${statusColor}; display: flex; align-items: center; gap: 5px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionIcon} ${actionDisp}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dlContainer.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UI Logic ---
Â  Â  Â  Â  window.switchLogTab = function(tabName) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.log-tab-btn').forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.getElementById('tab-' + tabName).classList.add('active');
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.log-section').forEach(s => s.classList.remove('active-tab-content'));
Â  Â  Â  Â  Â  Â  if(tabName === 'doorlock') document.getElementById('doorLockLogs').classList.add('active-tab-content');
Â  Â  Â  Â  Â  Â  else document.getElementById('appLogs').classList.add('active-tab-content');
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Map Logic ---
Â  Â  Â  Â  function initMap() {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('map');
Â  Â  Â  Â  Â  Â  map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
Â  Â  Â  Â  Â  Â  drawDoorlockZones();
Â  Â  Â  Â  Â  Â  if (sessionStorage.getItem('isAdmin') === 'true') loadUserList();
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawDoorlockZones() {
Â  Â  Â  Â  Â  Â  if (!map) return;
Â  Â  Â  Â  Â  Â  if (doorlockMarker) doorlockMarker.setMap(null);
Â  Â  Â  Â  Â  Â  zoneCircles.forEach(c => c.setMap(null)); zoneCircles = [];
Â  Â  Â  Â  Â  Â  const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
Â  Â  Â  Â  Â  Â  doorlockMarker = new kakao.maps.Marker({ position: pos, map: map, title: "ë„ì–´ë½" });
Â  Â  Â  Â  Â  Â  [1000, 2000, 3000].forEach((r, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const color = i===0?'#FF0000':(i===1?'#FFA500':'#008000');
Â  Â  Â  Â  Â  Â  Â  Â  const circle = new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1 });
Â  Â  Â  Â  Â  Â  Â  Â  circle.setMap(map); zoneCircles.push(circle);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function selectUser(userId) {
Â  Â  Â  Â  Â  Â  if (sessionStorage.getItem('isAdmin') === 'true') clearMapAndInfo();
Â  Â  Â  Â  Â  Â  selectedUserId = userId;
Â  Â  Â  Â  Â  Â  document.getElementById('logBtn').disabled = false;
Â  Â  Â  Â  Â  Â  document.getElementById('userInfo').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('infoArea').innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="filter-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnAll" class="filter-btn active">ì „ì²´</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnRange" class="filter-btn">ë²”ìœ„ ë‚´</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="log-list" id="miniLogList">ë¡œë”© ì¤‘...</div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.getElementById('btnAll').onclick = () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnAll').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnRange').classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  renderLocationLogs(false);Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  document.getElementById('btnRange').onclick = () => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnRange').classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('btnAll').classList.remove('active');
Â  Â  Â  Â  Â  Â  Â  Â  renderLocationLogs(true);Â 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  database.ref(`users/${userId}/location_logs`).once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  currentUserLocationLogs = [];
Â  Â  Â  Â  Â  Â  Â  Â  if(snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(c => { if(c.val().latitude) currentUserLocationLogs.push(c.val()); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
                    // ìˆ˜ì •ëœ ë¶€ë¶„: ìœ„ì¹˜ ë¡œê·¸ë¥¼ ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
                    currentUserLocationLogs.sort((a, b) => {
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        return timeB - timeA;
                    });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  renderLocationLogs(false);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderLocationLogs(filter) {
Â  Â  Â  Â  Â  Â  const listDiv = document.getElementById('miniLogList');
Â  Â  Â  Â  Â  Â  listDiv.innerHTML = '';
Â  Â  Â  Â  Â  Â  markers.forEach(m => { if(m.customOverlay) m.customOverlay.setMap(null); m.setMap(null); }); markers = [];
Â  Â  Â  Â  Â  Â  if(currentPolyline) currentPolyline.setMap(null);
Â  Â  Â  Â  Â  Â  if(currentUserLocationLogs.length === 0) { listDiv.innerHTML = 'ê¸°ë¡ ì—†ìŒ'; return; }
Â  Â  Â  Â  Â  Â  let path = [];
Â  Â  Â  Â  Â  Â  const bounds = new kakao.maps.LatLngBounds();
Â  Â  Â  Â  Â  Â  bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
Â  Â  Â  Â  Â  Â  
            // ì •ë ¬ëœ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒí•˜ë©° ë Œë”ë§
            currentUserLocationLogs.forEach(pos => {
Â  Â  Â  Â  Â  Â  Â  Â  const lat = parseFloat(pos.latitude); const lng = parseFloat(pos.longitude);
Â  Â  Â  Â  Â  Â  Â  Â  const dist = getDistanceFromLatLonInKm(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
Â  Â  Â  Â  Â  Â  Â  Â  if(filter && dist > MAX_DISTANCE_KM) return;
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'log-entry';
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `${formatTimestamp(pos.timestamp)} <br> ê±°ë¦¬: <strong>${dist.toFixed(2)}km</strong>`;
Â  Â  Â  Â  Â  Â  Â  Â  div.onclick = () => { map.setCenter(new kakao.maps.LatLng(lat, lng)); map.setLevel(4); };
Â  Â  Â  Â  Â  Â  Â  Â  listDiv.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  if(path.length < 50) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const p = new kakao.maps.LatLng(lat, lng); path.push(p); bounds.extend(p);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dot = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dot.style.width='8px'; dot.style.height='8px'; dot.style.background='blue'; dot.style.borderRadius='50%';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const m = new kakao.maps.CustomOverlay({ position: p, content: dot, yAnchor: 0.5 });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  m.setMap(map); markers.push(m);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  listDiv.scrollTop = 0;
Â  Â  Â  Â  Â  Â  if(path.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  currentPolyline = new kakao.maps.Polyline({ path: path, strokeWeight: 3, strokeColor: '#0000FF', strokeOpacity: 0.6 });
Â  Â  Â  Â  Â  Â  Â  Â  currentPolyline.setMap(map); map.setBounds(bounds);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function clearMapAndInfo() { markers.forEach(m => m.setMap(null)); markers = []; if(currentPolyline) currentPolyline.setMap(null); }

Â  Â  Â  Â  // --- Admin & Navigation ---
Â  Â  Â  Â  function loadUserList() {
Â  Â  Â  Â  Â  Â  const list = document.getElementById('userList');
Â  Â  Â  Â  Â  Â  database.ref('users').once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  list.innerHTML = '<h2>User List</h2>';
Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(c => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.className = 'user'; div.textContent = c.key;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  div.onclick = () => loadUserDoorlockAndInit(c.key, () => selectUser(c.key));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // ê²€ìƒ‰ ê¸°ëŠ¥
Â  Â  Â  Â  window.searchUser = function() {
Â  Â  Â  Â  Â  Â  const input = document.getElementById('search-input');
Â  Â  Â  Â  Â  Â  const keyword = input.value.trim();
Â  Â  Â  Â  Â  Â  const area = document.getElementById('result-area');

Â  Â  Â  Â  Â  Â  if (!keyword) {
Â  Â  Â  Â  Â  Â  Â  Â  customAlert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  area.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">ê²€ìƒ‰ ì¤‘...</div>';

Â  Â  Â  Â  Â  Â  database.ref('users').once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!snap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  area.innerHTML = '<div style="padding:20px; text-align:center;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const allUsers = snap.val();
Â  Â  Â  Â  Â  Â  Â  Â  const searchResult = {};
Â  Â  Â  Â  Â  Â  Â  Â  let count = 0;

Â  Â  Â  Â  Â  Â  Â  Â  for (const [userId, userData] of Object.entries(allUsers)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userId.toLowerCase().includes(keyword.toLowerCase())) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  searchResult[userId] = userData;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderGrid(searchResult);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  area.innerHTML = `<div style="padding:20px; text-align:center; color:#dc3545;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  '<strong>${keyword}</strong>' ê°€ í¬í•¨ëœ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("ê²€ìƒ‰ ì˜¤ë¥˜:", err);
Â  Â  Â  Â  Â  Â  Â  Â  area.innerHTML = '<div style="padding:20px; text-align:center;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  const searchInputObj = document.getElementById('search-input');
Â  Â  Â  Â  if(searchInputObj) {
Â  Â  Â  Â  Â  Â  searchInputObj.addEventListener('keypress', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (e.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.searchUser();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  window.loadAllDBData = function() {
Â  Â  Â  Â  Â  Â  const area = document.getElementById('result-area');
Â  Â  Â  Â  Â  Â  area.innerHTML = 'ë¡œë”© ì¤‘...';
Â  Â  Â  Â  Â  Â  database.ref('users').once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  if(!snap.exists()) { area.innerHTML = 'ë°ì´í„° ì—†ìŒ'; return; }
Â  Â  Â  Â  Â  Â  Â  Â  renderGrid(snap.val());
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ì•„ì½”ë””ì–¸ í˜•íƒœë¡œ ë Œë”ë§
Â  Â  Â  Â  function renderGrid(data) {
Â  Â  Â  Â  Â  Â  const resultArea = document.getElementById('result-area');
Â  Â  Â  Â  Â  Â  let html = '<div class="accordion-container">';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  for(const [userId, userData] of Object.entries(data)) {
Â  Â  Â  Â  Â  Â  Â  Â  html += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-accordion-item">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-accordion-header" onclick="toggleAccordion(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>ğŸ‘¤ <strong>${userId}</strong></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon-arrow">â–¼</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-accordion-body hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="firebase-view">${createTreeView(userData, 0)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  html += '</div>';
Â  Â  Â  Â  Â  Â  resultArea.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // ì•„ì½”ë””ì–¸ í† ê¸€ ê¸°ëŠ¥
Â  Â  Â  Â  window.toggleAccordion = function(header) {
Â  Â  Â  Â  Â  Â  const currentBody = header.nextElementSibling;
Â  Â  Â  Â  Â  Â  const isHidden = currentBody.classList.contains('hidden');

Â  Â  Â  Â  Â  Â  const allHeaders = document.querySelectorAll('.user-accordion-header');
Â  Â  Â  Â  Â  Â  const allBodies = document.querySelectorAll('.user-accordion-body');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  allHeaders.forEach(h => h.classList.remove('active-header'));
Â  Â  Â  Â  Â  Â  allBodies.forEach(b => b.classList.add('hidden'));Â 

Â  Â  Â  Â  Â  Â  if (isHidden) {
Â  Â  Â  Â  Â  Â  Â  Â  header.classList.add('active-header');
Â  Â  Â  Â  Â  Â  Â  Â  currentBody.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  function createTreeView(data, depth) {
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  const indent = '<span style="display:inline-block; width:' + (depth * 15) + 'px;"></span>';
Â  Â  Â  Â  Â  Â  if (typeof data === 'object' && data !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  for (const [k, v] of Object.entries(data)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (typeof v === 'object' && v !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="fv-item">${indent}<span class="fv-key" onclick="this.nextElementSibling.classList.toggle('fv-hidden')">â–¼ ${k}</span><div class="fv-children">${createTreeView(v, depth + 1)}</div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="fv-item">${indent}<span class="fv-key">${k}:</span> <span class="fv-string">${v}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="fv-item">${indent}${data}</div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return html;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â  document.getElementById('login-form').onsubmit = (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const id = document.getElementById('username').value;
Â  Â  Â  Â  Â  Â  const pw = document.getElementById('password').value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  database.ref('admin_pass').once('value').then(snap => {
Â  Â  Â  Â  Â  Â  Â  Â  let isAdmin = false;
Â  Â  Â  Â  Â  Â  Â  Â  snap.forEach(c => { if(c.val().adminId===id && c.val().password===pw) isAdmin=true; });
Â  Â  Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('isAdmin', 'true');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMain(true, id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  database.ref('users/' + id).once('value').then(usnap => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(usnap.exists() && usnap.val().password === pw) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('isAdmin', 'false');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('userId', id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showMain(false, id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  customAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };

Â  Â  Â  Â  function showMain(isAdmin, uid) {
Â  Â  Â  Â  Â  Â  document.getElementById('login-container').classList.add('hidden'); // ë¡œê·¸ì¸ ìˆ¨ê¹€
Â  Â  Â  Â  Â  Â  document.getElementById('header').classList.remove('hidden'); // í—¤ë” ë³´ì„
Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.remove('hidden'); // ë©”ì¸ ë³´ì„
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ë‹«ê¸° ë²„íŠ¼ê³¼ DBì¡°íšŒ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
Â  Â  Â  Â  Â  Â  const closeBtn = document.getElementById('closeUserInfoBtn');
Â  Â  Â  Â  Â  Â  const dbBtn = document.getElementById('newBtn'); // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼

Â  Â  Â  Â  Â  Â  if(isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  // --- ê´€ë¦¬ì ëª¨ë“œ ---
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userList').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userInfo').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(closeBtn) closeBtn.style.display = 'block'; // ë‹«ê¸° ë²„íŠ¼ ë³´ì„
Â  Â  Â  Â  Â  Â  Â  Â  if(dbBtn) dbBtn.style.display = 'inline-block'; // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼ ë³´ì„

Â  Â  Â  Â  Â  Â  Â  Â  if(window.kakao) kakao.maps.load(initMap);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // --- ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ ---
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userList').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userInfo').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(closeBtn) closeBtn.style.display = 'none'; // ë‹«ê¸° ë²„íŠ¼ ìˆ¨ê¹€
Â  Â  Â  Â  Â  Â  Â  Â  if(dbBtn) dbBtn.style.display = 'none'; // [ì¶”ê°€ë¨] DB ì¡°íšŒ ë²„íŠ¼ ìˆ¨ê¹€

Â  Â  Â  Â  Â  Â  Â  Â  if(window.kakao) kakao.maps.load(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initMap();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadUserDoorlockAndInit(uid, () => selectUser(uid));
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  setupNav();
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupNav() {
Â  Â  Â  Â  Â  Â  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
Â  Â  Â  Â  Â  Â  document.getElementById('logoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  document.getElementById('confirmLogoutBtn').onclick = () => { sessionStorage.clear(); location.reload(); };
Â  Â  Â  Â  Â  Â  document.getElementById('cancelLogoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.add('hidden');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // íƒ€ì´í‹€ í´ë¦­ ì‹œ ì´ˆê¸° í™”ë©´ ì´ë™
Â  Â  Â  Â  Â  Â  const headerTitle = document.getElementById('header-title');
Â  Â  Â  Â  Â  Â  if(headerTitle) {
Â  Â  Â  Â  Â  Â  Â  Â  headerTitle.style.cursor = 'pointer';
Â  Â  Â  Â  Â  Â  Â  Â  headerTitle.onclick = () => window.location.reload();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('logBtn').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('db-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('log-content').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mapBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logBtn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  if(selectedUserId) loadAllLogs(selectedUserId);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('mapBtn').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('log-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('db-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mapBtn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  if(map) map.relayout();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  document.getElementById('newBtn').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('main-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('log-content').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('db-content').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('mapBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('logBtn').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('newBtn').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  loadAllDBData();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('closeUserInfoBtn').onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('userInfo').classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  clearMapAndInfo();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }

Â  Â  Â  Â  // Auto Login Check
Â  Â  Â  Â  if (sessionStorage.getItem('isAdmin')) {
Â  Â  Â  Â  Â  Â  showMain(sessionStorage.getItem('isAdmin') === 'true', sessionStorage.getItem('userId'));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  document.getElementById('login-container').classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  });
</script>
</body>
</html>




