<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doorlock Admin</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”’</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="indexstyle.css">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2>
        <form id="login-form" onsubmit="handleLoginSubmit(event)">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" onclick="showDashboard()">Smart Doorlock</h1>
        <div class="button-group">
            <button id="mapBtn" onclick="hideLogView()" disabled>ì§€ë„</button>
            <button id="logBtn" onclick="showLogView()" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="dbEditBtn" onclick="showDbViewer()">DB ì¡°íšŒ</button>
            <button id="logoutBtn" onclick="confirmLogout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h2 style="margin:0; font-size:18px;">User Info</h2>
                    <button id="closeUserInfoBtn" onclick="clearMapAndInfo()" style="border:none; background:none; font-size:1.2rem; cursor:pointer; color:#999;">âœ•</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 id="logUserTitle" style="margin:0;">ì „ì²´ ë¡œê·¸</h2>
                <button onclick="hideLogView()" style="padding:5px 10px; border:1px solid #ccc; border-radius:4px; cursor:pointer;">âœ• ë‹«ê¸°</button>
            </div>
        </div>
        
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">ë„ì–´ë½ ë¡œê·¸</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">ì•± ë¡œê·¸</button>
        </div>

        <div class="log-container">
            <div id="doorLockSection" class="log-section active-tab-content">
                <div class="log-entries" id="doorLockEntries"></div>
            </div>
            <div id="appLogSection" class="log-section">
                <div class="log-entries" id="appLogEntries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2>DataBase</h2>
                <button onclick="hideLogView()" style="padding:5px 10px; cursor:pointer;">ë©”ì¸ìœ¼ë¡œ</button>
            </div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ID (ì˜ˆ: 123456)" onkeypress="if(event.key==='Enter') searchUser()">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDbData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <div id="result-area">
                <div style="text-align:center; color:#999; padding:20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none'">í™•ì¸</button>
        </div>
    </div>
    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button onclick="executeLogout()" style="flex: 1; background:#71b7e6; color:white; border:none; padding:10px; border-radius:5px;">í™•ì¸</button>
                <button onclick="document.getElementById('logout-confirm-modal').classList.add('hidden')" style="flex: 1; background:#ccc; border:none; padding:10px; border-radius:5px;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================
        // [1] ì „ì—­ ë³€ìˆ˜ ë° ì„¤ì •
        // ====================================================
        const DOORLOCK_LAT = 37.566826; 
        const DOORLOCK_LNG = 126.9786567;
        const MAX_DISTANCE_KM = 3.0;

        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.firebaseapp.com",
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        let database;
        let map;
        let markers = [];
        let currentPolyline;
        let selectedLogMarker;
        let selectedUserId = null;
        let currentUserLocationLogs = [];

        // Firebase ì´ˆê¸°í™”
        try {
            if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase SDK missing.");
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized.");
        } catch (e) {
            alert("Firebase Init Error: " + e);
        }

        // ====================================================
        // [2] ì „ì—­ í•¨ìˆ˜ ì •ì˜
        // ====================================================

        function customAlert(msg) {
            const el = document.getElementById('modal-message');
            if(el) {
                el.textContent = msg;
                document.getElementById('custom-modal').style.display = 'flex';
            } else alert(msg);
        }

        // --- í™”ë©´ ì „í™˜ ---
        function showDashboard(isAdmin, loggedInUserId) {
            if (isAdmin === undefined) isAdmin = sessionStorage.getItem('isAdmin') === 'true';
            if (loggedInUserId === undefined) loggedInUserId = sessionStorage.getItem('userId');

            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('header').classList.remove('hidden');
            document.getElementById('log-content').classList.add('hidden');
            document.getElementById('db-content').classList.add('hidden'); // DBí™”ë©´ ìˆ¨ê¹€
            document.body.style.overflow = 'auto';

            document.getElementById('mapBtn').disabled = true;
            document.getElementById('dbEditBtn').disabled = false;
            
            const userListDiv = document.getElementById('userList');
            const userInfoDiv = document.getElementById('userInfo');

            if (isAdmin) {
                userListDiv.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                if (!map && typeof kakao !== 'undefined') {
                    kakao.maps.load(initMap);
                } else if (map) {
                    setTimeout(() => { 
                        map.relayout(); 
                        map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG)); 
                    }, 100);
                }
            } else {
                userListDiv.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                selectedUserId = loggedInUserId;
                if (!map && typeof kakao !== 'undefined') {
                    kakao.maps.load(() => { initMap(); selectUser(loggedInUserId); });
                }
            }
        }

        function showDbViewer() {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('log-content').classList.add('hidden');
            document.getElementById('db-content').classList.remove('hidden');
            
            document.getElementById('mapBtn').disabled = false; 
            document.getElementById('dbEditBtn').disabled = true;
            
            loadAllDbData();
        }

        function showLogView() {
            const userId = selectedUserId || sessionStorage.getItem('userId');
            if (!userId) return customAlert("ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('db-content').classList.add('hidden');
            document.getElementById('log-content').classList.remove('hidden');

            document.getElementById('mapBtn').disabled = false; 
            document.getElementById('logBtn').disabled = true;

            // íƒ­ ì´ˆê¸°í™”
            switchLogTab('doorlock');
            loadAllLogs(userId);
        }

        function hideLogView() { showDashboard(); }

        function confirmLogout() {
            document.getElementById('logout-confirm-modal').classList.remove('hidden');
        }

        function executeLogout() {
            sessionStorage.clear(); 
            window.location.reload();
        }

        // --- íƒ­ ì „í™˜ ê¸°ëŠ¥ (CSSì™€ ì—°ë™) ---
        function switchLogTab(tabName) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.log-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');

            // ì„¹ì…˜ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.log-section').forEach(sec => sec.classList.remove('active-tab-content'));
            if (tabName === 'doorlock') {
                document.getElementById('doorLockSection').classList.add('active-tab-content');
            } else {
                document.getElementById('appLogSection').classList.add('active-tab-content');
            }
        }

        // --- ë¡œê·¸ ë¡œë“œ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„) ---
        function loadAllLogs(userId) {
            const dlEntries = document.getElementById('doorLockEntries');
            const appEntries = document.getElementById('appLogEntries');
            
            document.getElementById('logUserTitle').textContent = `${userId} ì „ì²´ ë¡œê·¸`;
            dlEntries.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ë¡œë”© ì¤‘...</div>';
            appEntries.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">ë¡œë”© ì¤‘...</div>';

            // 1. ë„ì–´ë½ ë¡œê·¸ (doorlock_logs/USER_ID)
            database.ref('doorlock_logs/' + userId).once('value').then(snap => {
                dlEntries.innerHTML = '';
                if (!snap.exists()) { 
                    dlEntries.innerHTML = '<div style="padding:20px;text-align:center;">ê¸°ë¡ ì—†ìŒ</div>'; return; 
                }
                
                const logs = [];
                snap.forEach(c => logs.push(c.val()));
                logs.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()); // ìµœì‹ ìˆœ

                logs.forEach(log => {
                    // CSS í´ë˜ìŠ¤ ë§¤í•‘
                    let statusClass = 'status-open'; // ê¸°ë³¸ íŒŒë‘
                    let icon = 'ğŸ”“';
                    let statusText = log.status || '-';
                    
                    if (statusText.includes('ì ê¹€')) {
                        statusClass = 'status-close'; // ë¹¨ê°•
                        icon = 'ğŸ”’';
                    }

                    // ì¹´ë“œ HTML ìƒì„±
                    const div = document.createElement('div');
                    div.className = `log-card ${statusClass}`;
                    div.innerHTML = `
                        <div class="log-header-row">
                            <span>ğŸ•’ ${log.timestamp}</span>
                            <span>Device</span>
                        </div>
                        <div class="log-body-row">
                            <div style="display:flex;align-items:center;">
                                <span class="badge method">ğŸ”‘ ${log.method || 'ê¸°íƒ€'}</span>
                            </div>
                            <div class="status-text ${statusClass === 'status-open' ? 'text-blue' : 'text-red'}">
                                ${icon} ${statusText}
                            </div>
                        </div>
                    `;
                    dlEntries.appendChild(div);
                });
            });

            // 2. ì•± ë¡œê·¸
            database.ref('users/' + userId + '/app_logs').once('value').then(snap => {
                appEntries.innerHTML = '';
                if (!snap.exists()) { 
                    appEntries.innerHTML = '<div style="padding:20px;text-align:center;">ê¸°ë¡ ì—†ìŒ</div>'; return; 
                }

                const logs = [];
                snap.forEach(cat => {
                    const val = cat.val();
                    if(typeof val === 'object' && val !== null) {
                        Object.keys(val).forEach(key => {
                            const d = val[key];
                            if(d && typeof d === 'object') logs.push({...d, _type: key});
                        });
                    }
                });
                logs.sort((a,b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());

                logs.forEach(log => {
                    const div = document.createElement('div');
                    div.className = 'log-card status-app'; // ì´ˆë¡ìƒ‰ ë¼ì¸
                    
                    let title = "ì•± í™œë™";
                    let detail = "";

                    if(log.new_auth) { title = "ì¸ì¦ ë°©ì‹ ë³€ê²½"; detail = log.new_auth; }
                    else if(log.new_name) { title = "ì´ë¦„ ë³€ê²½"; detail = log.new_name; }
                    else if(log.event) { title = log.event; }
                    else { title = "ê¸°íƒ€ ì„¤ì •"; detail = JSON.stringify(log); }

                    div.innerHTML = `
                        <div class="log-header-row">
                            <span>ğŸ•’ ${log.timestamp}</span>
                            <span>App</span>
                        </div>
                        <div class="log-body-row">
                            <span style="font-weight:600;color:#333;">${title}</span>
                        </div>
                        ${detail ? `<div class="log-detail-box">${detail}</div>` : ''}
                    `;
                    appEntries.appendChild(div);
                });
            });
        }

        // --- ì§€ë„ ë° ì‚¬ìš©ì ë¡œì§ ---
        function initMap() {
            const container = document.getElementById('map');
            if(!container) return;
            map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
            map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
            map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
            drawDoorlockZones();
            if (sessionStorage.getItem('isAdmin') === 'true') loadUserList();
        }

        function drawDoorlockZones() {
            const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
            new kakao.maps.Marker({ position: pos, map: map });
            [1000, 2000, 3000].forEach((r, i) => {
                const color = ['#FF0000', '#FFA500', '#008000'][i];
                new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeOpacity: 0.8, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1, map: map });
            });
        }

        function loadUserList() {
            database.ref('users').once('value').then(snap => {
                const list = document.getElementById('userList');
                while (list.childNodes.length > 2) { list.removeChild(list.lastChild); }
                snap.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'user';
                    div.textContent = c.key;
                    div.onclick = () => selectUser(c.key);
                    list.appendChild(div);
                });
            });
        }

        function selectUser(userId) {
            clearMapAndInfo();
            selectedUserId = userId;
            document.getElementById('logBtn').disabled = false;
            const infoArea = document.getElementById('infoArea');
            document.getElementById('userInfo').classList.remove('hidden');

            infoArea.innerHTML = `
                <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
                <div class="filter-group">
                    <button onclick="renderLocationLogs(false, this)" class="filter-btn active">ì „ì²´ ê²½ë¡œ</button>
                    <button onclick="renderLocationLogs(true, this)" class="filter-btn">3km ì´ë‚´</button>
                </div>
                <div class="log-list" id="miniLogList">Loading...</div>
            `;

            database.ref('users/' + userId + '/location_logs').once('value').then(snap => {
                currentUserLocationLogs = [];
                if (snap.exists()) {
                    snap.forEach(c => currentUserLocationLogs.push(c.val()));
                    currentUserLocationLogs.sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
                }
                renderLocationLogs(false);
            });
        }

        function renderLocationLogs(filterRange, btn) {
            if(btn) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            const listDiv = document.getElementById('miniLogList');
            if (!listDiv) return;
            listDiv.innerHTML = '';
            
            // ë§ˆì»¤ ì´ˆê¸°í™”
            markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
            markers = [];
            if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }

            if (currentUserLocationLogs.length === 0) { listDiv.innerHTML = 'ê¸°ë¡ ì—†ìŒ'; return; }

            let path = [];
            const bounds = new kakao.maps.LatLngBounds();
            bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
            let count = 0;

            currentUserLocationLogs.forEach(pos => {
                if (!pos.latitude || !pos.longitude) return;
                const lat = parseFloat(pos.latitude);
                const lng = parseFloat(pos.longitude);
                const dist = getDist(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);

                if (filterRange && dist > MAX_DISTANCE_KM) return;

                const item = document.createElement('div');
                item.className = 'log-entry';
                item.innerHTML = `<small>${pos.timestamp}</small><br>ê±°ë¦¬: <b>${dist.toFixed(2)}km</b>`;
                item.onclick = () => { 
                    if(map) { map.panTo(new kakao.maps.LatLng(lat, lng)); map.setLevel(4); }
                };
                listDiv.appendChild(item);

                if (count < 50) {
                    const p = new kakao.maps.LatLng(lat, lng);
                    path.push(p); bounds.extend(p);
                    const img = document.createElement('img');
                    img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                    img.className = 'custom-marker-dot';
                    const marker = new kakao.maps.CustomOverlay({ position: p, content: img, yAnchor: 0.5 });
                    marker.setMap(map);
                    markers.push(marker);
                    count++;
                }
            });

            if (path.length > 0) {
                currentPolyline = new kakao.maps.Polyline({
                    path: path, strokeWeight: 4, strokeColor: '#FF00FF', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                });
                map.setBounds(bounds);
            }
        }

        function clearMapAndInfo() {
            markers.forEach(m => m.setMap(null)); markers = [];
            if (currentPolyline) currentPolyline.setMap(null);
            document.getElementById('infoArea').innerHTML = '';
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('logBtn').disabled = true;
            if (sessionStorage.getItem('isAdmin') === 'true') selectedUserId = null;
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- DB ì¡°íšŒ (íŠ¸ë¦¬ ë·°) ---
        function loadAllDbData() {
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = '<div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</div>';
            database.ref('users').once('value').then(snap => {
                if(snap.exists()) renderGrid(snap.val());
                else resultArea.innerHTML = 'ë°ì´í„° ì—†ìŒ';
            });
        }

        function searchUser() {
            const userId = document.getElementById('search-input').value.trim();
            if(!userId) return alert("ID ì…ë ¥");
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = 'ê²€ìƒ‰ ì¤‘...';
            database.ref('users/' + userId).once('value').then(snap => {
                if(snap.exists()) { const wrap = {}; wrap[userId] = snap.val(); renderGrid(wrap); }
                else resultArea.innerHTML = 'ê²°ê³¼ ì—†ìŒ';
            });
        }

        function renderGrid(data) {
            const resultArea = document.getElementById('result-area');
            // í…Œì´ë¸” ìƒì„± ë¡œì§ (ìƒëµ ê°€ëŠ¥ ì‹œ ê°„ë‹¨íˆ)
            let html = '';
            for (const [id, val] of Object.entries(data)) {
                html += `<div style="margin-bottom:10px; border:1px solid #eee; padding:10px; border-radius:8px;">
                            <h3 style="color:#007bff;">${id}</h3>
                            <div class="firebase-view" style="font-family:monospace; font-size:13px;">${createFirebaseView(val, 0)}</div>
                         </div>`;
            }
            resultArea.innerHTML = html;
        }

        function createFirebaseView(data, depth) {
            let html = '';
            const indent = `<span style="display:inline-block; width:${depth*15}px"></span>`;
            if (typeof data === 'object' && data !== null) {
                for (const [key, value] of Object.entries(data)) {
                    const isObj = typeof value === 'object' && value !== null;
                    if (isObj) {
                        const cls = depth < 2 ? '' : 'fv-hidden';
                        const arrow = depth < 2 ? 'â–¼' : 'â–¶';
                        html += `<div>${indent}<span class="fv-key" style="cursor:pointer; color:#000080; font-weight:bold;" onclick="toggleNode(this)">${arrow} ${key}</span><div class="fv-children ${cls}">${createFirebaseView(value, depth + 1)}</div></div>`;
                    } else {
                        html += `<div>${indent}<span style="color:#000080; font-weight:bold;">${key}:</span> <span style="color:#a31515;">${value}</span></div>`;
                    }
                }
            }
            return html;
        }

        window.toggleNode = function(el) {
            const child = el.nextElementSibling;
            if(child) {
                child.classList.toggle('fv-hidden');
                el.textContent = child.classList.contains('fv-hidden') ? el.textContent.replace('â–¼','â–¶') : el.textContent.replace('â–¶','â–¼');
            }
        };

        // --- ë¡œê·¸ì¸ ---
        function handleLoginSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('username').value.trim();
            const pw = document.getElementById('password').value.trim();

            database.ref('admin_pass').once('value').then(snap => {
                let isAdmin = false;
                if (snap.exists()) { 
                    snap.forEach(c => { 
                        if (c.val().adminId === id && c.val().password === pw) isAdmin = true; 
                    }); 
                }
                if (isAdmin) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('isAdmin', 'true');
                    sessionStorage.setItem('userId', id);
                    showDashboard(true, id);
                } else {
                    database.ref('users').once('value').then(userSnap => {
                        let isUser = false;
                        if (userSnap.exists()) { userSnap.forEach(c => { if(c.key === id) isUser = true; }); }
                        if (isUser) { 
                            sessionStorage.setItem('isLoggedIn', 'true');
                            sessionStorage.setItem('isAdmin', 'false');
                            sessionStorage.setItem('userId', id);
                            showDashboard(false, id); 
                        } else {
                            customAlert('ë¡œê·¸ì¸ ì‹¤íŒ¨');
                        }
                    });
                }
            });
        }

        // ì´ˆê¸° ì‹¤í–‰
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showDashboard(sessionStorage.getItem('isAdmin') === 'true', sessionStorage.getItem('userId'));
        } else {
            document.getElementById('login-container').classList.remove('hidden');
        }
    });
    </script>
</body>
</html>
