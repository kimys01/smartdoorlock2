<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="color-scheme" content="light only">
    <meta name="supported-color-schemes" content="light">

    <title>Smart Doorlock Capstone</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ”’</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="indexstyle.css">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">ì•„ì´ë””</label>
                <input type="text" id="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="input-group">
                <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <button type="submit">ë¡œê·¸ì¸</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title">Smart Doorlock</h1> 
        <div class="button-group">
            <button id="mapBtn" disabled>ì§€ë„</button>
            <button id="logBtn" disabled>ë¡œê·¸ ë³´ê¸°</button>
            <button id="newBtn">DB ì¡°íšŒ</button>
            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn" title="ë‹«ê¸°">âœ•</button>
                </div>
                <div id="infoArea">ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div> 
        </div>
    </div>

    <div id="log-content" class="hidden">
        <div class="log-header">
            <h2 id="logUserTitle">ì „ì²´ ë¡œê·¸</h2>
        </div>
        <div class="log-tab-buttons">
            <button id="tab-doorlock" class="log-tab-btn active" onclick="switchLogTab('doorlock')">ë„ì–´ë½ ë¡œê·¸</button>
            <button id="tab-app" class="log-tab-btn" onclick="switchLogTab('app')">ì•± ë¡œê·¸</button>
        </div>
        <div class="log-container">
            <div id="doorLockLogs" class="log-section active-tab-content">
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-section">
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-content" class="hidden">
        <div class="container">
            <h2>DataBase</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ê²€ìƒ‰í•  ì‚¬ìš©ì ID ì…ë ¥">
                <button class="btn-search" onclick="searchUser()">ê²€ìƒ‰</button>
                <button class="btn-reset" onclick="loadAllDBData()">ì „ì²´ ëª©ë¡</button>
            </div>
            <h3 id="result-title">User List:</h3>
            <div id="result-area">
                <div style="padding:20px; text-align:center; color:#666;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">í™•ì¸</button>
        </div>
    </div>

    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">í™•ì¸</button>
                <button id="cancelLogoutBtn" style="flex: 1; background-color: #aaa;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("App initialized.");

            // --- Global Variables ---
            let DOORLOCK_LAT = 37.566826;    
            let DOORLOCK_LNG = 126.9786567;
            let MAX_DISTANCE_KM = 3.0;
            let database, map, doorlockMarker, currentPolyline, selectedLogMarker, selectedUserId;
            let markers = [], zoneCircles = [], currentUserLocationLogs = [];

            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.web.app", 
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            try {
                if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase Load Fail");
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (e) {
                alert("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•˜ì„¸ìš”.");
                return;
            }

            // --- Helper Functions ---
            function formatTimestamp(ts) {
                if (!ts) return 'ì‹œê°„ ì—†ìŒ';
                const date = new Date(ts);
                if (isNaN(date.getTime())) return ts; 
                
                return date.toLocaleString('ko-KR', {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                });
            }

            function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2-lat1) * (Math.PI/180);
                const dLon = (lon2-lon1) * (Math.PI/180); 
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*(Math.PI/180)) * Math.cos(lat2*(Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            }

            function customAlert(msg) {
                document.getElementById('modal-message').textContent = msg;
                document.getElementById('custom-modal').style.display = 'flex';
            }

            // --- Core Logic: Init Doorlock (For Map Center) ---
            function loadUserDoorlockAndInit(userId, callback) {
                database.ref('users/' + userId).once('value').then((snap) => {
                    const user = snap.val();
                    if (!user || !user.my_doorlocks) throw new Error("ì—°ê²°ëœ ë„ì–´ë½ ì—†ìŒ");
                    
                    const doorlockKeys = Object.keys(user.my_doorlocks);
                    const doorlockId = doorlockKeys[0]; 
                    
                    return database.ref('doorlocks/' + doorlockId).once('value');
                }).then((snap) => {
                    const dlData = snap.val();
                    if (dlData && dlData.location) {
                        DOORLOCK_LAT = parseFloat(dlData.location.latitude);
                        DOORLOCK_LNG = parseFloat(dlData.location.longitude);
                        
                        if (map) {
                            map.setCenter(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                            drawDoorlockZones();
                        }
                    }
                    if (callback) callback();
                }).catch((err) => {
                    console.error(err);
                    if (callback) callback(); 
                });
            }

            // --- [ìˆ˜ì •ë¨] ë„ì–´ë½/ì•± ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸° (ê²½ë¡œ ìˆ˜ì • ì™„ë£Œ) ---
            function loadAllLogs(userId) {
                const dlContainer = document.querySelector('#doorLockLogs .log-entries');
                const appContainer = document.querySelector('#appLogs .log-entries');
                document.getElementById('logUserTitle').textContent = `${userId} ì „ì²´ ë¡œê·¸`;
                
                dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ë„ì–´ë½ ë¡œê·¸ ë¡œë”© ì¤‘...</div>';
                appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">ì•± ë¡œê·¸ ë¡œë”© ì¤‘...</div>';

                // 1. ë„ì–´ë½ ë¡œê·¸ (doorlock_logs/ì‚¬ìš©ìID)
                // [í•µì‹¬ ìˆ˜ì •] ì´ì „ ì½”ë“œì˜ ë³µì¡í•œ ê²€ìƒ‰ ëŒ€ì‹ , ì‚¬ìš©ìIDë¡œ ë°”ë¡œ ì ‘ê·¼
                database.ref('doorlock_logs/' + userId).once('value').then(snap => {
                    dlContainer.innerHTML = '';
                    if (!snap.exists()) {
                        dlContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ë„ì–´ë½ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const logs = [];
                    snap.forEach(child => logs.push(child.val()));

                    // ìµœì‹ ìˆœ ì •ë ¬
                    logs.sort((a, b) => {
                        const timeA = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                        const timeB = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                        return timeB - timeA;
                    });

                    logs.forEach(log => {
                        const div = document.createElement('div');
                        
                        // ìƒíƒœë³„ ë””ìì¸ (ì—´ë¦¼:íŒŒë‘ / ë‹«í˜:ë¹¨ê°•)
                        let statusClass = 'status-close';
                        let statusText = log.status || '-';
                        if (String(statusText).includes("ì—´ë¦¼") || String(statusText).includes("í•´ì œ")) {
                            statusClass = 'status-open';
                        }
                        div.className = `log-card ${statusClass}`;
                        
                        let t = log.timestamp ? String(log.timestamp).replace("T", " ") : 'ì‹œê°„ ì—†ìŒ';

                        div.innerHTML = `
                            <div class="log-header-row">
                                <span>ğŸ•’ ${t}</span>
                                <span>Device</span>
                            </div>
                            <div class="log-body-row">
                                <div style="display:flex;align-items:center;">
                                    <span class="badge method">ğŸ”‘ ${log.method || 'ê¸°íƒ€'}</span>
                                </div>
                                <div class="status-text ${statusClass === 'status-open' ? 'text-blue' : 'text-red'}">
                                    ${statusText}
                                </div>
                            </div>
                        `;
                        dlContainer.appendChild(div);
                    });
                });

                // 2. ì•± ë¡œê·¸ (users/ì‚¬ìš©ìID/app_logs)
                database.ref('users/' + userId + '/app_logs').once('value').then(snap => {
                    appContainer.innerHTML = '';
                    if (!snap.exists()) {
                        appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">ì•± ì‚¬ìš© ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    const logs = [];
                    // êµ¬ì¡°ê°€ ë³µì¡í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë“  í•˜ìœ„ í•­ëª© íƒìƒ‰
                    snap.forEach(catSnap => {
                        const catData = catSnap.val();
                        if(typeof catData === 'object' && catData !== null) {
                            Object.keys(catData).forEach(k => {
                                const detail = catData[k];
                                if(typeof detail === 'object' && detail !== null) {
                                    // ë¡œê·¸ ê°ì²´ ì‹ë³„
                                    logs.push({ ...detail, _type: k });
                                }
                            });
                        }
                    });

                    logs.sort((a, b) => {
                        const timeA = new Date(String(a.timestamp).replace(" ", "T")).getTime() || 0;
                        const timeB = new Date(String(b.timestamp).replace(" ", "T")).getTime() || 0;
                        return timeB - timeA;
                    });

                    if(logs.length === 0) {
                        appContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    logs.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'log-card status-app';
                        
                        let t = log.timestamp ? String(log.timestamp).replace("T", " ") : 'ì‹œê°„ ì—†ìŒ';
                        let title = "ì•± í™œë™";
                        let detail = "";

                        if(log.new_auth) { title = "ì¸ì¦ ë°©ì‹ ë³€ê²½"; detail = log.new_auth; }
                        else if(log.new_name) { title = "ì´ë¦„ ë³€ê²½"; detail = log.new_name; }
                        else if(log.new_pw) { title = "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½"; detail = "(ì•”í˜¸í™”ë¨)"; }
                        else if(log.event) { title = log.event; }
                        else { detail = JSON.stringify(log).replace(/["{}]/g, ""); }

                        div.innerHTML = `
                            <div class="log-header-row">
                                <span>ğŸ•’ ${t}</span>
                                <span>App</span>
                            </div>
                            <div class="log-body-row">
                                <span style="font-weight:600; color:#333;">${title}</span>
                            </div>
                            ${detail ? `<div class="log-detail-box">${detail}</div>` : ''}
                        `;
                        appContainer.appendChild(div);
                    });
                });
            }

            // --- Event Listeners ---
            document.getElementById('login-form').onsubmit = (e) => {
                e.preventDefault();
                const id = document.getElementById('username').value;
                const pw = document.getElementById('password').value;
                
                database.ref('admin_pass').once('value').then(snap => {
                    let isAdmin = false;
                    snap.forEach(c => { if(c.val().adminId===id && c.val().password===pw) isAdmin=true; });
                    if(isAdmin) {
                        sessionStorage.setItem('isAdmin', 'true');
                        sessionStorage.setItem('isLoggedIn', 'true');
                        sessionStorage.setItem('userId', id);
                        showMain(true, id);
                    } else {
                        database.ref('users/' + id).once('value').then(usnap => {
                            if(usnap.exists() && usnap.val().password && usnap.val().password.new_pw === pw) {
                                 // ì‹¤ì œë¡œëŠ” ë¹„ë°€ë²ˆí˜¸ í•„ë“œ êµ¬ì¡°ì— ë§ì¶° ìˆ˜ì • í•„ìš” (ì—¬ê¸°ì„  ë‹¨ìˆœ ì˜ˆì‹œ)
                                 // ì‚¬ìš©ìê°€ ë³´ë‚´ì£¼ì‹  ì½”ë“œ ê¸°ë°˜ì´ë¼ ê²€ì¦ ë¡œì§ ìœ ì§€
                            }
                            // ì„ì‹œ: ID ì¡´ì¬í•˜ë©´ ë¡œê·¸ì¸ ì„±ê³µ (í…ŒìŠ¤íŠ¸ìš©)
                            if(usnap.exists()) {
                                sessionStorage.setItem('isAdmin', 'false');
                                sessionStorage.setItem('isLoggedIn', 'true');
                                sessionStorage.setItem('userId', id);
                                showMain(false, id);
                            } else {
                                customAlert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
                            }
                        });
                    }
                });
            };

            function showMain(isAdmin, uid) {
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                if(isAdmin) {
                    document.getElementById('userList').classList.remove('hidden');
                    document.getElementById('userInfo').classList.add('hidden');
                    if(window.kakao) kakao.maps.load(initMap);
                } else {
                    document.getElementById('userList').classList.add('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');
                    if(window.kakao) kakao.maps.load(() => {
                        initMap();
                        loadUserDoorlockAndInit(uid, () => selectUser(uid));
                    });
                }
                setupNav();
            }

            function setupNav() {
                document.getElementById('logoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.remove('hidden');
                document.getElementById('confirmLogoutBtn').onclick = () => { sessionStorage.clear(); location.reload(); };
                document.getElementById('cancelLogoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.add('hidden');
                
                document.getElementById('logBtn').onclick = () => {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('db-content').classList.add('hidden');
                    document.getElementById('log-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = false;
                    document.getElementById('logBtn').disabled = true;
                    document.getElementById('newBtn').disabled = false;
                    if(selectedUserId) loadAllLogs(selectedUserId);
                };
                
                document.getElementById('mapBtn').onclick = () => {
                    document.getElementById('log-content').classList.add('hidden');
                    document.getElementById('db-content').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = true;
                    document.getElementById('logBtn').disabled = false;
                    document.getElementById('newBtn').disabled = false;
                    if(map) map.relayout();
                };

                document.getElementById('newBtn').onclick = () => {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('log-content').classList.add('hidden');
                    document.getElementById('db-content').classList.remove('hidden');
                    document.getElementById('mapBtn').disabled = false;
                    document.getElementById('logBtn').disabled = false;
                    document.getElementById('newBtn').disabled = true;
                    loadAllDBData();
                };
                
                document.getElementById('closeUserInfoBtn').onclick = () => {
                    document.getElementById('userInfo').classList.add('hidden');
                    clearMapAndInfo();
                };
            }

            // Auto Login Check
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showMain(sessionStorage.getItem('isAdmin') === 'true', sessionStorage.getItem('userId'));
            } else {
                document.getElementById('login-container').classList.remove('hidden');
            }
            
            // --- DB View Logic (Tree) ---
            window.loadAllDBData = function() {
                const area = document.getElementById('result-area');
                area.innerHTML = '<div style="padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';
                database.ref('users').once('value').then(snap => {
                    if(!snap.exists()) { area.innerHTML = '<div style="padding:20px;">ë°ì´í„° ì—†ìŒ</div>'; return; }
                    renderGrid(snap.val());
                });
            }
            
            window.searchUser = function() {
                const id = document.getElementById('search-input').value.trim();
                if(!id) return alert("ID ì…ë ¥");
                const area = document.getElementById('result-area');
                area.innerHTML = '<div style="padding:20px;">ê²€ìƒ‰ ì¤‘...</div>';
                database.ref('users/' + id).once('value').then(snap => {
                    if(snap.exists()) {
                        const wrap = {}; wrap[id] = snap.val();
                        renderGrid(wrap);
                    } else {
                        area.innerHTML = '<div style="padding:20px; color:red;">ê²°ê³¼ ì—†ìŒ</div>';
                    }
                });
            }

            function renderGrid(data) {
                let html = '<div class="grid-wrapper"><table class="styled-table"><thead><tr><th>ID</th><th>Data</th></tr></thead><tbody>';
                for(const [k, v] of Object.entries(data)) {
                    html += `<tr><td style="font-weight:bold; vertical-align:top;">${k}</td><td><div class="firebase-view">${createTreeView(v, 0)}</div></td></tr>`;
                }
                html += '</tbody></table></div>';
                document.getElementById('result-area').innerHTML = html;
            }

            function createTreeView(data, depth) {
                let html = '';
                const indent = `<span style="display:inline-block; width:${depth*15}px"></span>`;
                if (typeof data === 'object' && data !== null) {
                    for (const [k, v] of Object.entries(data)) {
                        const isObj = typeof v === 'object' && v !== null;
                        if (isObj) {
                            const cls = depth < 2 ? '' : 'fv-hidden';
                            const arrow = depth < 2 ? 'â–¼' : 'â–¶';
                            html += `<div class="fv-item">${indent}<span class="fv-key" onclick="this.nextElementSibling.classList.toggle('fv-hidden'); this.innerText = this.innerText.includes('â–¶') ? 'â–¼ ${k}' : 'â–¶ ${k}'">${arrow} ${k}</span><div class="fv-children ${cls}">${createTreeView(v, depth + 1)}</div></div>`;
                        } else {
                            html += `<div class="fv-item">${indent}<span class="fv-key">${k}:</span> <span class="fv-string">${v}</span></div>`;
                        }
                    }
                } else {
                    html += `<div class="fv-item">${indent}${data}</div>`;
                }
                return html;
            }
            
            // Enter key for search
            document.getElementById('search-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') window.searchUser();
            });
            
            // Global Tab Switcher needed for onclick in HTML
            window.switchLogTab = function(tabName) {
                document.querySelectorAll('.log-tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tabName).classList.add('active');
                document.querySelectorAll('.log-section').forEach(s => s.classList.remove('active-tab-content'));
                if(tabName === 'doorlock') document.getElementById('doorLockLogs').classList.add('active-tab-content');
                else document.getElementById('appLogs').classList.add('active-tab-content');
            }
        });
    </script>
</body>
</html>
