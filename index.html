<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Doorlock Admin</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="indexstyle.css">

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="login-container">
        <h2>SmartDoorLock</h2>
        <form id="login-form">
            <div class="input-group">
                <label for="username">아이디</label>
                <input type="text" id="username" placeholder="아이디를 입력하세요" required>
            </div>
            <div class="input-group">
                <label for="password">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요" required>
            </div>
            <button type="submit">로그인</button>
        </form>
    </div>

    <div id="header" class="hidden">
        <h1 id="header-title" onclick="showDashboard()">Smart Doorlock</h1>
        <div class="button-group">
            <button id="mapBtn" disabled>지도</button>
            <button id="logBtn" disabled>로그 보기</button>
            <button id="dbEditBtn">DB 조회</button>
            <button id="logoutBtn">로그아웃</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <div id="sidebar">
            <div id="userInfo" class="hidden">
                <div class="info-header">
                    <h2>User Info</h2>
                    <button id="closeUserInfoBtn">X</button>
                </div>
                <div id="infoArea">사용자를 선택해주세요.</div>
            </div>
            <div id="userList">
                <h2>User List</h2>
            </div>
        </div>
        <div id="mapArea">
            <h2>Map</h2>
            <div id="map"></div>
        </div>
    </div>

    <div id="log-modal-content" class="hidden">
        <div class="log-header-bar">
            <button onclick="hideLogView()">← 지도로 돌아가기</button>
            <h2 id="logUserTitle" style="margin:0;">전체 로그</h2>
        </div>
        <div class="log-layout">
            <div id="doorLockLogs" class="log-box">
                <h3>DoorLock Logs</h3>
                <div class="log-entries"></div>
            </div>
            <div id="appLogs" class="log-box">
                <h3>App Logs</h3>
                <div class="log-entries"></div>
            </div>
        </div>
    </div>

    <div id="db-viewer-content" class="hidden">
        <div class="db-container">
            <h2>데이터베이스 조회 (Interactive Tree)</h2>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="검색할 사용자 ID를 입력하세요 (예: 123456)">
                <button class="btn-search" onclick="searchUser()">검색</button>
                <button class="btn-reset" onclick="loadAllDbData()">전체 목록</button>
            </div>
            <h3 id="result-title">사용자 목록:</h3>
            <div id="result-area">
                <div class="message-box">데이터를 불러오는 중...</div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <p id="modal-message"></p>
            <button onclick="document.getElementById('custom-modal').style.display='none';">확인</button>
        </div>
    </div>
    <div id="logout-confirm-modal" class="hidden">
        <div class="modal-content">
            <p>로그아웃 하시겠습니까?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button id="confirmLogoutBtn" style="flex: 1;">확인</button>
                <button onclick="document.getElementById('logout-confirm-modal').classList.add('hidden')" style="flex: 1; background-color: #aaa;">취소</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("App Started.");

            // 전역 설정 및 변수
            const DOORLOCK_LAT = 37.566826; 
            const DOORLOCK_LNG = 126.9786567;
            const MAX_DISTANCE_KM = 3.0;

            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            let database;
            let map;
            let markers = [];
            let currentPolyline;
            let selectedLogMarker;
            let selectedUserId = null;
            let currentUserLocationLogs = [];

            // Firebase 초기화
            try {
                if (typeof firebase === 'undefined' || !firebase.initializeApp) throw new Error("Firebase SDK missing.");
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
            } catch (e) {
                alert("Firebase Init Error: " + e);
                return;
            }
            // 버튼 이벤트 연결
            document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
            document.getElementById('logoutBtn').onclick = () => document.getElementById('logout-confirm-modal').classList.remove('hidden');
            document.getElementById('confirmLogoutBtn').onclick = executeLogout;
            
            document.getElementById('header-title').onclick = () => showDashboard();
            document.getElementById('mapBtn').onclick = hideLogView; 
            document.getElementById('logBtn').onclick = showLogView;
            document.getElementById('dbEditBtn').onclick = showDbViewer; 
            
            document.getElementById('closeUserInfoBtn').onclick = clearMapAndInfo;
            document.getElementById('search-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') searchUser();
            });

            // ==================
            // 화면 전환 함수들
            // ==================
            window.showDashboard = function(isAdmin, loggedInUserId) {
                if (isAdmin === undefined) isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                if (loggedInUserId === undefined) loggedInUserId = sessionStorage.getItem('userId');

                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('header').classList.remove('hidden');
                document.getElementById('log-modal-content').classList.add('hidden');
                document.getElementById('db-viewer-content').classList.add('hidden');
                document.body.style.overflow = 'auto';
                document.body.style.background = 'linear-gradient(135deg, #71b7e6, #9b59b6)';

                document.getElementById('mapBtn').disabled = true;
                document.getElementById('dbEditBtn').disabled = false;
                
                const userListDiv = document.getElementById('userList');
                const userInfoDiv = document.getElementById('userInfo');

                if (isAdmin) {
                    userListDiv.classList.remove('hidden');
                    userInfoDiv.classList.add('hidden');
                    if (!map && typeof kakao !== 'undefined') kakao.maps.load(initMap);
                } else {
                    userListDiv.classList.add('hidden');
                    userInfoDiv.classList.remove('hidden');
                    selectedUserId = loggedInUserId;
                    if (!map && typeof kakao !== 'undefined') {
                        kakao.maps.load(() => { initMap(); selectUser(loggedInUserId); });
                    }
                }
            };

            window.showDbViewer = function() {
                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('log-modal-content').classList.add('hidden');
                document.getElementById('db-viewer-content').classList.remove('hidden');
                
                document.body.style.background = '#f9f9f9'; 
                document.getElementById('mapBtn').disabled = false; 
                document.getElementById('dbEditBtn').disabled = true;
                
                loadAllDbData();
            };

            window.showLogView = function() {
                const userId = selectedUserId || sessionStorage.getItem('userId');
                if (!userId) return alert("사용자를 선택해주세요.");

                document.getElementById('main-content').classList.add('hidden');
                document.getElementById('log-modal-content').classList.remove('hidden');
                document.getElementById('db-viewer-content').classList.add('hidden');

                document.getElementById('mapBtn').disabled = false; 
                document.getElementById('logBtn').disabled = true;

                loadAllLogs(userId);
            };

            window.hideLogView = function() { showDashboard(); };


            // ==================
            // 기능 로직 (지도/로그인)
            // ==================
            function initMap() {
                const container = document.getElementById('map');
                map = new kakao.maps.Map(container, { center: new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG), level: 7 });
                map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                drawDoorlockZones();
                
                if (sessionStorage.getItem('isAdmin') === 'true') loadUserList();
            }

            function drawDoorlockZones() {
                const pos = new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG);
                new kakao.maps.Marker({ position: pos, map: map, title: "Home" });
                [1000, 2000, 3000].forEach((r, i) => {
                    const color = ['#FF0000', '#FFA500', '#008000'][i];
                    new kakao.maps.Circle({ center: pos, radius: r, strokeWeight: 1, strokeColor: color, strokeOpacity: 0.8, strokeStyle: 'dashed', fillColor: color, fillOpacity: 0.1, map: map });
                });
            }

            function loadUserList() {
                database.ref('users').once('value').then(snap => {
                    const list = document.getElementById('userList');
                    Array.from(list.querySelectorAll('.user')).forEach(e => e.remove());
                    snap.forEach(c => {
                        const div = document.createElement('div');
                        div.className = 'user';
                        div.textContent = c.key;
                        div.onclick = () => selectUser(c.key);
                        list.appendChild(div);
                    });
                });
            }

            function selectUser(userId) {
                clearMapAndInfo();
                selectedUserId = userId;
                document.getElementById('logBtn').disabled = false;
                const infoArea = document.getElementById('infoArea');
                document.getElementById('userInfo').classList.remove('hidden');

                infoArea.innerHTML = `
                    <div style="margin-bottom:10px;"><strong>ID:</strong> ${userId}</div>
                    <div class="filter-group">
                        <button id="showAllBtn" class="filter-btn active">전체 경로</button>
                        <button id="showRangeBtn" class="filter-btn">3km 이내</button>
                    </div>
                    <div class="log-list">Loading...</div>
                `;
                document.getElementById('showAllBtn').onclick = (e) => { setActiveBtn(e.target); renderLocationLogs(false); };
                document.getElementById('showRangeBtn').onclick = (e) => { setActiveBtn(e.target); renderLocationLogs(true); };
                function setActiveBtn(btn) {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                }

                database.ref('users/' + userId + '/location_logs').once('value').then(snap => {
                    currentUserLocationLogs = [];
                    if (snap.exists()) {
                        snap.forEach(c => currentUserLocationLogs.push(c.val()));
                        currentUserLocationLogs.sort((a, b) => b.timestamp - a.timestamp);
                    }
                    renderLocationLogs(false);
                });
            }

            function renderLocationLogs(filterRange) {
                const listDiv = document.querySelector('.log-list');
                if (!listDiv) return;
                listDiv.innerHTML = '';
                markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
                markers = [];
                if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }

                if (currentUserLocationLogs.length === 0) { listDiv.innerHTML = '기록 없음'; return; }

                let path = [];
                const bounds = new kakao.maps.LatLngBounds();
                bounds.extend(new kakao.maps.LatLng(DOORLOCK_LAT, DOORLOCK_LNG));
                let count = 0;

                currentUserLocationLogs.forEach(pos => {
                    if (!pos.latitude || !pos.longitude) return;
                    const lat = parseFloat(pos.latitude);
                    const lng = parseFloat(pos.longitude);
                    const dist = getDist(DOORLOCK_LAT, DOORLOCK_LNG, lat, lng);
                    if (filterRange && dist > MAX_DISTANCE_KM) return;

                    const item = document.createElement('div');
                    item.className = 'log-entry';
                    const time = pos.timestamp ? new Date(pos.timestamp).toLocaleString() : '-';
                    item.innerHTML = `<small>${time}</small><br>거리: <b>${dist.toFixed(2)}km</b>`;
                    item.onclick = () => { if(map) map.panTo(new kakao.maps.LatLng(lat, lng)); };
                    listDiv.appendChild(item);

                    if (count < 50) {
                        const p = new kakao.maps.LatLng(lat, lng);
                        path.push(p);
                        bounds.extend(p);
                        const img = document.createElement('img');
                        img.src = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png';
                        img.className = 'custom-marker-dot';
                        const marker = new kakao.maps.CustomOverlay({ position: p, content: img, yAnchor: 0.5 });
                        marker.setMap(map);
                        markers.push(marker);
                        count++;
                    }
                });

                if (path.length > 0) {
                    currentPolyline = new kakao.maps.Polyline({
                        path: path, strokeWeight: 4, strokeColor: '#FF00FF', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                    });
                    map.setBounds(bounds);
                }
            }

            function clearMapAndInfo() {
                markers.forEach(m => { if(m.co) m.co.setMap(null); m.setMap(null); });
                markers = [];
                if (currentPolyline) { currentPolyline.setMap(null); currentPolyline = null; }
                document.getElementById('infoArea').innerHTML = '';
                document.getElementById('userInfo').classList.add('hidden');
                document.getElementById('logBtn').disabled = true;
                if (sessionStorage.getItem('isAdmin') === 'true') selectedUserId = null;
            }

            function getDist(lat1, lon1, lat2, lon2) {
                const R = 6371; 
                const dLat = (lat2-lat1) * Math.PI/180;
                const dLon = (lon2-lon1) * Math.PI/180;
                const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            // 상세 로그 (도어락/앱)
            function loadAllLogs(userId) {
                const doorDiv = document.querySelector('#doorLockLogs .log-entries');
                const appDiv = document.querySelector('#appLogs .log-entries');
                document.getElementById('logUserTitle').textContent = `${userId} 전체 로그`;
                doorDiv.innerHTML = 'Loading...'; appDiv.innerHTML = 'Loading...';

                database.ref('doorlock_logs/' + userId).once('value').then(snap => {
                    doorDiv.innerHTML = '';
                    if(!snap.exists()) { doorDiv.innerHTML = '없음'; return; }
                    const arr = [];
                    snap.forEach(c => arr.push(c.val()));
                    arr.reverse().forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'full-log-entry';
                        let t = '시간없음';
                        if (typeof log.timestamp === 'string') t = log.timestamp.replace(" ", "T");
                        div.innerHTML = `<strong>${t}</strong><br>방식: ${log.method}<br>상태: ${log.status}`;
                        doorDiv.appendChild(div);
                    });
                });

                database.ref('users/' + userId + '/app_logs').once('value').then(snap => {
                    appDiv.innerHTML = '';
                    if(!snap.exists()) { appDiv.innerHTML = '없음'; return; }
                    const arr = [];
                    const val = snap.val();
                    if (val.change && val.change.auth) arr.push({ type: '권한변경', ...val.change.auth });
                    if(arr.length === 0) appDiv.innerHTML = '표시할 형식의 로그 없음';
                    arr.forEach(log => {
                        const div = document.createElement('div');
                        div.className = 'full-log-entry';
                        div.innerHTML = `<strong>${log.timestamp}</strong>: ${log.new_auth || '이벤트'}`;
                        appDiv.appendChild(div);
                    });
                });
            }

            // ==================
            // DB 조회 (트리 뷰)
            // ==================
            window.loadAllDbData = function() {
                const resultArea = document.getElementById('result-area');
                document.getElementById('result-title').textContent = "전체 사용자 목록 (users):";
                resultArea.innerHTML = '<div class="message-box">불러오는 중...</div>';
                document.getElementById('search-input').value = '';
                database.ref('users').once('value').then(snap => {
                    if(snap.exists()) renderGrid(snap.val());
                    else resultArea.innerHTML = '<div class="message-box">데이터 없음</div>';
                });
            };

            window.searchUser = function() {
                const userId = document.getElementById('search-input').value.trim();
                if(!userId) return alert("ID 입력");
                const resultArea = document.getElementById('result-area');
                document.getElementById('result-title').textContent = `'${userId}' 검색 결과:`;
                resultArea.innerHTML = '<div class="message-box">검색 중...</div>';
                database.ref('users/' + userId).once('value').then(snap => {
                    if(snap.exists()) { const wrap = {}; wrap[userId] = snap.val(); renderGrid(wrap); }
                    else resultArea.innerHTML = '<div class="message-box">결과 없음</div>';
                });
            };

            function renderGrid(data) {
                const resultArea = document.getElementById('result-area');
                let html = `
                    <div class="grid-wrapper"><table class="styled-table">
                    <thead><tr><th style="width:150px;">ID</th><th>Data Tree</th></tr></thead><tbody>
                `;
                for (const [id, val] of Object.entries(data)) {
                    const treeHtml = createFirebaseView(val, 0);
                    html += `<tr><td style="vertical-align:top; font-weight:bold; color:#007bff;">${id}</td><td><div class="firebase-view">${treeHtml}</div></td></tr>`;
                }
                html += `</tbody></table></div>`;
                resultArea.innerHTML = html;
            }

            function createFirebaseView(data, depth) {
                let html = '';
                const indent = '<span class="fv-indent"></span>'.repeat(depth);
                if (typeof data === 'object' && data !== null) {
                    for (const [key, value] of Object.entries(data)) {
                        const isObj = typeof value === 'object' && value !== null;
                        if (isObj) {
                            const isExpanded = depth < 2; 
                            const arrow = isExpanded ? '▼' : '▶';
                            const rotate = isExpanded ? 'rotate(0deg)' : 'rotate(-90deg)';
                            const cls = isExpanded ? '' : 'fv-hidden';
                            html += `
                            <div class="fv-item">${indent}
                                <div class="fv-key-box" onclick="toggleNode(this)">
                                    <span class="fv-arrow" style="transform:${rotate}">${arrow}</span>
                                    <span class="fv-key">${key}</span>
                                </div>
                                <div class="fv-children ${cls}">${createFirebaseView(value, depth + 1)}</div>
                            </div>`;
                        } else {
                            html += `<div class="fv-item">${indent}<span style="display:inline-block;width:16px;"></span><span class="fv-key">${key}:</span> ${formatValue(value)}</div>`;
                        }
                    }
                } else {
                    html += `<div class="fv-item">${indent}${formatValue(data)}</div>`;
                }
                return html;
            }

            window.toggleNode = function(el) {
                const child = el.nextElementSibling;
                const arrow = el.querySelector('.fv-arrow');
                if(child) {
                    if(child.classList.contains('fv-hidden')) {
                        child.classList.remove('fv-hidden');
                        arrow.textContent = '▼'; arrow.style.transform = 'rotate(0deg)';
                    } else {
                        child.classList.add('fv-hidden');
                        arrow.textContent = '▶'; arrow.style.transform = 'rotate(-90deg)';
                    }
                }
            };

            function formatValue(v) {
                if (typeof v === 'string') return `<span class="fv-string">"${v}"</span>`;
                if (typeof v === 'number') return `<span class="fv-number">${v}</span>`;
                if (v === true || v === false) return `<span class="fv-boolean">${v}</span>`;
                return v;
            }

            function handleLoginSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('username').value.trim();
                const pw = document.getElementById('password').value.trim();
                database.ref('admin_pass').once('value').then(snap => {
                    let isAdmin = false;
                    if (snap.exists()) { snap.forEach(c => { if (c.val().adminId === id && c.val().password === pw) isAdmin = true; }); }
                    if (isAdmin) {
                        setSession(true, true, id); showDashboard(true, id);
                    } else {
                        database.ref('users').once('value').then(userSnap => {
                            let isUser = false;
                            if (userSnap.exists()) { userSnap.forEach(c => { if(c.key === id) isUser = true; }); }
                            if (isUser) { setSession(true, false, id); showDashboard(false, id); }
                            else customAlert('로그인 실패');
                        });
                    }
                });
            }
            function setSession(loggedIn, admin, uid) {
                sessionStorage.setItem('isLoggedIn', loggedIn);
                sessionStorage.setItem('isAdmin', admin);
                sessionStorage.setItem('userId', uid);
            }
            function executeLogout() {
                sessionStorage.clear(); window.location.reload();
            }
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            if (isLoggedIn) {
                const isAdmin = sessionStorage.getItem('isAdmin') === 'true';
                const userId = sessionStorage.getItem('userId');
                // 이제 showDashboard 함수가 위에서 이미 만들어졌으므로 에러가 나지 않습니다.
                showDashboard(isAdmin, userId);
            } else {
                document.getElementById('login-container').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>

