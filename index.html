<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone Project</title>

    <!-- Google Fonts Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- í†µí•© CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            padding-top: 70px; /* í—¤ë” ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
            /* overflow: hidden; /* ë¡œê·¸ì¸ ì‹œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            /* ë¡œê·¸ì¸ í›„ ìŠ¤í¬ë¡¤ì´ í•„ìš”í•˜ë¯€ë¡œ bodyì—ì„œ overflow: hidden ì œê±° */
        }

        .hidden { display: none !important; }

        /* ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ */
        #login-container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: absolute; /* ë¡œê·¸ì¸ í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #login-container h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #71b7e6;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #login-container button:hover {
            opacity: 0.9;
        }

        .extra-links {
            margin-top: 20px;
            font-size: 14px;
        }
        .extra-links a {
            color: #555;
            text-decoration: none;
        }
        .extra-links a:hover {
            text-decoration: underline;
            color: #71b7e6;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ìŠ¤íƒ€ì¼ */
        #header {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            padding: 10px 20px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 500;
        }
        #header h1 { margin: 0; font-size: 24px; }

        /* í—¤ë” ë²„íŠ¼ ê·¸ë£¹ */
        #header .button-group {
            display: flex;
            gap: 10px;
        }

        /* ğŸŒŸ í—¤ë” ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (DB ë²„íŠ¼ ì œì™¸) */
        #logoutBtn, #logBtn {
            padding: 8px 15px;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ */
        }

        /* ğŸŒŸ ê° ë²„íŠ¼ ìƒ‰ìƒ */
        #logoutBtn { background-color: #dc3545; } /* ë¡œê·¸ì•„ì›ƒ: ë¹¨ê°„ìƒ‰ */
        #logBtn { background-color: #007bff; } /* ë¡œê·¸ ë³´ê¸°: íŒŒë€ìƒ‰ */


        /* ğŸŒŸ ê° ë²„íŠ¼ hover íš¨ê³¼ */
        #logoutBtn:hover { background-color: #c82333; }
        #logBtn:hover { background-color: #0056b3; }


        /* ğŸŒŸ ë¡œê·¸ ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ */
        #logBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6; /* ë¹„í™œì„±í™” ì‹œ ì•½ê°„ íˆ¬ëª…í•˜ê²Œ */
        }

        #main-content {
            display: flex;
            padding: 10px;
            gap: 20px;
            width: 100%;
            height: calc(100vh - 70px); /* í—¤ë” ë†’ì´ ì œì™¸ */
            background-color: #fff;
            overflow: hidden; /* ìì‹ ìš”ì†Œë“¤ì´ ë„˜ì¹˜ì§€ ì•Šë„ë¡ */
        }


        #sidebar {
            display: flex;
            flex-direction: column;
            width: 12.5%;
            gap: 15px;
            height: 100%;
        }

        #userList, #userInfo, #mapArea {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }

        #userList {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
        }
        #userInfo {
            overflow-y: auto;
            height: 45%;
            flex-shrink: 0;
        }
        #mapArea { flex-grow: 1; }

        .user {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .user:hover { background-color: #f0f0f0; }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #map {
            width: 100%;
            height: calc(100% - 40px); /* ì œëª© ë†’ì´ ë“±ì„ ê³ ë ¤ */
            margin-top: 10px;
        }
        .log-entry {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
            line-height: 1.5; /* ì¤„ ê°„ê²© ì¶”ê°€ */
        }
        .log-entry:hover {
            background-color: #e9ecef;
        }

        /* ë¡œê·¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        #log-content {
            width: 100%;
            height: calc(100vh - 70px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: #fff;
            position: fixed; /* ë©”ì¸ ì»¨í…ì¸  ìœ„ì— ë®ì–´ì”Œìš°ë„ë¡ */
            top: 70px; /* í—¤ë” ì•„ë˜ */
            left: 0;
            z-index: 600; /* ë©”ì¸ ì»¨í…ì¸ ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ */
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        #backToMapBtn {
            padding: 8px 15px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #backToMapBtn:hover {
            background-color: #e0e0e0;
        }

        .log-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
        }

        .log-section {
            width: 50%;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .log-section h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .log-section .log-entries {
            overflow-y: auto;
            flex-grow: 1;
        }

        .full-log-entry {
            padding: 8px 5px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* ì»¤ìŠ¤í…€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            text-align: center;
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .modal-content button {
            padding: 10px 20px;
            background-color: #71b7e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* --- ğŸŒŸ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´(ì •ë³´ì°½) ìŠ¤íƒ€ì¼ ì¶”ê°€ --- */
        .custom-overlay-info {
            padding: 5px 10px;
            font-size: 12px;
            text-align: left;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid #ccc;
        }
    </style>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§€ì—°ì„ ìœ„í•´ í•¨ìˆ˜ë¡œ ë˜í•‘ ---
        function initializeApp() {
            console.log("initializeApp called."); // ë””ë²„ê·¸ ë¡œê·¸

            // --- ğŸŒŸ í•„ìˆ˜ DOM ìš”ì†Œ í™•ì¸ ---
            const loginContainer = document.getElementById('login-container');
            const mainContent = document.getElementById('main-content');
            const header = document.getElementById('header');
            const logContent = document.getElementById('log-content');

            // --- ğŸŒŸ ì´ˆê¸° UI ìƒíƒœ ì„¤ì • ---
            if (loginContainer) loginContainer.classList.remove('hidden');
            if (mainContent) mainContent.classList.add('hidden');
            if (header) header.classList.add('hidden');
            if (logContent) logContent.classList.add('hidden');

            // --- ğŸŒŸ í•„ìˆ˜ ìš”ì†Œ ì—†ìœ¼ë©´ ì¤‘ë‹¨ ---
            if (!loginContainer || !mainContent || !header || !logContent) {
                console.error("Critical UI elements not found. Aborting initialization.");
                alert("í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜: í•„ìˆ˜ UI ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }


            // ì»¤ìŠ¤í…€ alert í•¨ìˆ˜
            function customAlert(message) {
                const modal = document.getElementById('custom-modal');
                const messageElem = document.getElementById('modal-message');
                if (modal && messageElem) {
                    messageElem.textContent = message;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                } else {
                    console.error("Custom modal elements not found, using standard alert.");
                    alert(message);
                }
            }

            // â–¼â–¼â–¼ Firebase ì„¤ì • ì •ë³´ â–¼â–¼â–¼
            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            // ì „ì—­ ë³€ìˆ˜ (Firebase ì´ˆê¸°í™” í›„ í• ë‹¹)
            let database;
            let map;
            let markers = [];
            let currentPolyline;
            let selectedLogMarker;
            let selectedUserId = null;
            let selectedMarkerImage;
            let pathMarkerImage;

            // --- Firebase ì•± ì´ˆê¸°í™” ---
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
                customAlert("Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”."); // ğŸŒŸ customAlert ì‚¬ìš©
                return; // Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }

            // ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
            function initMap() {
                try {
                    selectedMarkerImage = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                        new kakao.maps.Size(32, 35),
                        { offset: new kakao.maps.Point(16, 35) }
                    );
                    pathMarkerImage = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_dot.png',
                        new kakao.maps.Size(12, 12),
                        { offset: new kakao.maps.Point(6, 6) }
                    );
                    const container = document.getElementById('map');
                    if (!container) {
                        console.error("Map container not found!");
                        return;
                    }
                    map = new kakao.maps.Map(container, {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 4
                    });
                    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                    loadUserList();
                } catch (mapError) {
                    console.error("ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜:", mapError);
                    customAlert("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }

            // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ í•¨ìˆ˜
            function loadUserList() {
                if (!database) {
                    console.error("Firebase Databaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (loadUserList)");
                    return;
                }
                const userListDiv = document.getElementById('userList');
                const h2 = userListDiv?.querySelector('h2');
                if (!h2) {
                    console.error("userListDiv ë˜ëŠ” h2 ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
                const usersRef = database.ref('users');

                usersRef.once('value').then((snapshot) => {
                    // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€)
                    const existingUsers = userListDiv.querySelectorAll('.user');
                    existingUsers.forEach(el => el.remove());

                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        const userElement = document.createElement('div');
                        userElement.className = 'user';
                        userElement.dataset.name = userId;
                        userElement.textContent = userId;
                        userElement.addEventListener('click', () => selectUser(userId));
                        h2.insertAdjacentElement('afterend', userElement);
                    });
                }).catch(error => {
                    console.error("ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                    customAlert("ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            }

            // ì§€ë„ ë° ì •ë³´ ì´ˆê¸°í™” í•¨ìˆ˜
            function clearMapAndInfo() {
                markers.forEach(marker => {
                    if (marker.customOverlay) {
                        marker.customOverlay.setMap(null);
                    }
                    marker.setMap(null);
                });
                markers = [];
                if (currentPolyline) {
                    currentPolyline.setMap(null);
                    currentPolyline = null;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    selectedLogMarker = null;
                }
                const infoArea = document.getElementById('infoArea');
                if (infoArea) {
                    infoArea.innerHTML = '';
                }
                 // ì‚¬ìš©ì ì •ë³´ ì˜ì—­ ìˆ¨ê¸°ê¸°
                const userInfoDiv = document.getElementById('userInfo');
                if (userInfoDiv) userInfoDiv.classList.add('hidden');
                // ë¡œê·¸ ë²„íŠ¼ ë¹„í™œì„±í™”
                const logBtn = document.getElementById('logBtn');
                if (logBtn) logBtn.disabled = true;
                // ì§€ë„ ì„¤ëª… ì´ˆê¸°í™”
                const mapUserElem = document.getElementById('mapUser');
                if (mapUserElem) mapUserElem.textContent = 'ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ë©´ ì´ë™ ê²½ë¡œê°€ í‘œì‹œë©ë‹ˆë‹¤.';

            }

            // ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ í•¨ìˆ˜
            function showLocationOnMap(lat, lng) {
                console.log("showLocationOnMap í˜¸ì¶œë¨:", { lat, lng, mapDefined: !!map });
                if (!map) {
                    customAlert("ì§€ë„ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                    console.error("ì˜ëª»ëœ ì¢Œí‘œê°’ì…ë‹ˆë‹¤:", lat, lng);
                    customAlert("ì˜ëª»ëœ ìœ„ì¹˜ ì •ë³´ì…ë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                }
                const position = new kakao.maps.LatLng(lat, lng);
                selectedLogMarker = new kakao.maps.Marker({
                    position: position,
                    map: map,
                    image: selectedMarkerImage
                });
                map.panTo(position);
            }

            // ì‚¬ìš©ì ì„ íƒ í•¨ìˆ˜
            function selectUser(userId) {
                clearMapAndInfo(); // ë¨¼ì € ì§€ë„ì™€ ì •ë³´ì°½ í´ë¦¬ì–´
                selectedUserId = userId;
                const logBtn = document.getElementById('logBtn');
                if(logBtn) logBtn.disabled = false;

                const infoArea = document.getElementById('infoArea');
                const userInfoDiv = document.getElementById('userInfo'); // userInfo ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°

                if (infoArea && userInfoDiv) { // ë‘ ìš”ì†Œ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
                    infoArea.innerHTML = `<p><strong>ì‚¬ìš©ì ID:</strong> ${userId}</p><h3>ì „ì²´ ìœ„ì¹˜ ê¸°ë¡</h3><div class="log-list" style="max-height: 400px; overflow-y: auto;"></div>`;
                    userInfoDiv.classList.remove('hidden'); // userInfo ë³´ì´ê¸°
                } else {
                    console.error("infoArea ë˜ëŠ” userInfo ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                if (!database) {
                    console.error("Firebase Databaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (selectUser)");
                    return;
                }
                const locationsRef = database.ref('users/' + userId + '/location_logs');

                locationsRef.once('value').then((snapshot) => {
                    const logListDiv = infoArea.querySelector('.log-list');
                    if (!logListDiv) {
                        console.error(".log-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                        return;
                    }
                    if (!snapshot.exists()) {
                        logListDiv.innerHTML = 'í‘œì‹œí•  ìœ„ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
                        // return; // ê¸°ë¡ì´ ì—†ì–´ë„ ìµœê·¼ 10ê°œëŠ” ë¡œë“œ ì‹œë„
                    } else {
                        const logs = [];
                        snapshot.forEach(childSnapshot => logs.push(childSnapshot.val()));
                        logs.reverse().forEach(pos => {
                            if (!pos.latitude || !pos.longitude) return;

                            const parsedLat = parseFloat(pos.latitude);
                            const parsedLng = parseFloat(pos.longitude);

                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';

                            let displayText = `ìœ„ë„: ${parsedLat.toFixed(6)}<br>ê²½ë„: ${parsedLng.toFixed(6)}`;
                            if (pos.altitude !== undefined && pos.altitude !== null) {
                                displayText += `<br>ê³ ë„: ${parseFloat(pos.altitude).toFixed(2)}m`;
                            }
                            logEntry.innerHTML = displayText;

                            logEntry.addEventListener('click', () => showLocationOnMap(parsedLat, parsedLng));
                            logListDiv.appendChild(logEntry);
                        });
                    }
                }).catch(error => {
                    console.error("ìœ„ì¹˜ ê¸°ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                    customAlert("ìœ„ì¹˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                 });


                const recentLocationsQuery = database.ref('users/' + userId + '/location_logs').limitToLast(10);

                recentLocationsQuery.once('value').then((snapshot) => {
                    const mapUserElem = document.getElementById('mapUser');
                    if (!mapUserElem) {
                         console.error("mapUser ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                         return;
                    }
                    if (!snapshot.exists()) {
                        mapUserElem.textContent = `${userId} ì‚¬ìš©ìì˜ ìœ„ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`;
                        return; // ìµœê·¼ ê¸°ë¡ ì—†ìœ¼ë©´ ì—¬ê¸°ì„œ ì¢…ë£Œ
                    }
                    mapUserElem.textContent = `${userId}ì˜ ìµœê·¼ ì´ë™ ê²½ë¡œ (ìµœëŒ€ 10ê°œ)ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`;
                    let path = [];
                    const bounds = new kakao.maps.LatLngBounds();
                    // let lastPos = null; // lastPos ì‚¬ìš©ë˜ì§€ ì•ŠìŒ

                     // ê¸°ì¡´ ë§ˆì»¤ ë° í´ë¦¬ë¼ì¸ ì œê±° (selectUser ì‹œì‘ ì‹œ clearMapAndInfoì—ì„œ ì²˜ë¦¬ë¨)

                    snapshot.forEach((snap) => {
                        const pos = snap.val();
                        if (!pos.latitude || !pos.longitude) return;

                        const parsedLat = parseFloat(pos.latitude);
                        const parsedLng = parseFloat(pos.longitude);
                        const latlng = new kakao.maps.LatLng(parsedLat, parsedLng);
                        path.push(latlng);

                        const marker = new kakao.maps.Marker({
                            position: latlng,
                            map: map,
                            image: pathMarkerImage
                        });

                        // --- ë§ˆì»¤ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´(ì •ë³´ì°½) ì¶”ê°€ ---
                        const timestamp = pos.timestamp || Date.now();
                        const formattedTime = new Date(timestamp).toLocaleString('ko-KR', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });

                        const overlayContent = `<div class="custom-overlay-info">
                                                    <strong>${formattedTime}</strong><br>
                                                    ìœ„ë„: ${parsedLat.toFixed(6)}<br>
                                                    ê²½ë„: ${parsedLng.toFixed(6)}
                                                </div>`;

                        const customOverlay = new kakao.maps.CustomOverlay({
                            content: overlayContent,
                            position: latlng,
                            xAnchor: 0.5,
                            yAnchor: 2.5,
                            zIndex: 3
                        });

                        marker.customOverlay = customOverlay; // ì˜¤ë²„ë ˆì´ ì°¸ì¡° ì €ì¥

                        kakao.maps.event.addListener(marker, 'mouseover', function() {
                            customOverlay.setMap(map);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function() {
                            customOverlay.setMap(null);
                        });

                        // --- ë§ˆì»¤ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì¶”ê°€ ë ---

                        markers.push(marker); // ìƒˆë¡œ ìƒì„±ëœ ë§ˆì»¤ ë°°ì—´ì— ì¶”ê°€
                        bounds.extend(latlng);
                        // lastPos = latlng; // lastPos ì‚¬ìš©ë˜ì§€ ì•ŠìŒ
                    });

                    if (path.length > 0 && map) {
                        // ê¸°ì¡´ í´ë¦¬ë¼ì¸ ì œê±° (selectUser ì‹œì‘ ì‹œ clearMapAndInfoì—ì„œ ì²˜ë¦¬ë¨)
                        currentPolyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: 4, strokeColor: '#FF0000', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                        });
                        map.setBounds(bounds);
                    }
                }).catch(error => {
                     console.error("ìµœê·¼ ìœ„ì¹˜ ë¡œë“œ ì˜¤ë¥˜:", error);
                     customAlert("ìµœê·¼ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                 });
            }

            // ì‚¬ìš©ì ì •ë³´ ë‹«ê¸° í•¨ìˆ˜
            function closeUserInfo() {
                const userInfoDiv = document.getElementById('userInfo');
                if (userInfoDiv) userInfoDiv.classList.add('hidden');
            }

            // ëª¨ë“  ë¡œê·¸ ë¡œë“œ í•¨ìˆ˜
            function loadAllLogs(userId) {
                if (!database) {
                     console.error("Firebase Databaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (loadAllLogs)");
                     return;
                }
                const doorLockLogContainer = document.querySelector('#doorLockLogs .log-entries');
                const appLogContainer = document.querySelector('#appLogs .log-entries');
                const logUserTitle = document.getElementById('logUserTitle');

                if (!doorLockLogContainer || !appLogContainer || !logUserTitle) {
                    console.error("ë¡œê·¸ í‘œì‹œ ì˜ì—­ ë˜ëŠ” íƒ€ì´í‹€ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                logUserTitle.textContent = `${userId} ì‚¬ìš©ìì˜ ì „ì²´ ë¡œê·¸`;
                doorLockLogContainer.innerHTML = '<em>ë¡œë”© ì¤‘...</em>';
                appLogContainer.innerHTML = '<em>ë¡œë”© ì¤‘...</em>';

                const doorLockRef = database.ref('users/' + userId + '/door_lock_logs');
                doorLockRef.once('value').then((snapshot) => {
                    doorLockLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        doorLockLogContainer.innerHTML = 'í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }
                    const logs = [];
                    snapshot.forEach(child => logs.push(child.val()));
                    logs.reverse().forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = 'full-log-entry';
                        const formattedTime = new Date(log.timestamp || Date.now()).toLocaleString('ko-KR');
                        entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.action || 'N/A'}`;
                        doorLockLogContainer.appendChild(entry);
                    });
                }).catch(error => {
                    console.error("ë„ì–´ë½ ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:", error);
                    doorLockLogContainer.innerHTML = 'ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨';
                });

                const appLogRef = database.ref('users/' + userId + '/app_logs');
                appLogRef.once('value').then((snapshot) => {
                    appLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        appLogContainer.innerHTML = 'í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                        return;
                    }
                    const logs = [];
                    snapshot.forEach(child => logs.push(child.val()));
                    logs.reverse().forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = 'full-log-entry';
                        const formattedTime = new Date(log.timestamp || Date.now()).toLocaleString('ko-KR');
                        entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.event || 'N/A'}`;
                        appLogContainer.appendChild(entry);
                    });
                }).catch(error => {
                     console.error("ì•± ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:", error);
                     appLogContainer.innerHTML = 'ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨';
                 });
            }


            // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ í•¨ìˆ˜ ì •ì˜ ---
            function handleLoginSubmit(e) {
                e.preventDefault();
                console.log("Login submitted.");
                // const loginContainer = document.getElementById('login-container'); // ì´ë¯¸ ì „ì—­ì—ì„œ ê°€ì ¸ì˜´
                // const mainContent = document.getElementById('main-content');
                // const header = document.getElementById('header');
                const body = document.querySelector('body');
                const usernameInput = document.getElementById('username')?.value.trim();
                const passwordInput = document.getElementById('password')?.value.trim();

                if (!usernameInput || !passwordInput) {
                    customAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (!database) {
                    console.error("Firebase Databaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (Login Submit)");
                    customAlert("ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì˜¤ë¥˜");
                    return;
                }
                const adminRef = database.ref('admin_pass');

                adminRef.once('value').then((snapshot) => {
                    let loginSuccess = false;
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const adminData = childSnapshot.val();
                            if (adminData.adminId === usernameInput && adminData.password === passwordInput) {
                                loginSuccess = true;
                                return true;
                            }
                        });
                    }

                    if (loginSuccess) {
                        console.log("Login successful.");
                        if (loginContainer) loginContainer.classList.add('hidden');
                        if (mainContent) mainContent.classList.remove('hidden');
                        if (header) header.classList.remove('hidden');
                        if(body) {
                            body.style.background = '#fff';
                            body.style.overflow = 'auto';
                        }
                        if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                            console.log("Loading Kakao Maps...");
                            kakao.maps.load(initMap);
                        } else {
                             console.error("Kakao Maps SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜ load í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.");
                             customAlert("ì§€ë„ SDK ë¡œë”© ì˜¤ë¥˜");
                        }
                    } else {
                        console.log("Login failed.");
                        customAlert('ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                }).catch(error => {
                     console.error("ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
                     customAlert("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                 });
            }

            function handleLogout() {
                console.log("Logout clicked.");
                // ê°„ë‹¨í•˜ê²Œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
                window.location.reload();
            }

            function handleLogView() {
                console.log("Log view clicked.");
                // const mainContent = document.getElementById('main-content'); // ì´ë¯¸ ì „ì—­ì—ì„œ ê°€ì ¸ì˜´
                // const logContent = document.getElementById('log-content');
                if (selectedUserId) {
                    if (mainContent) mainContent.classList.add('hidden');
                    if (logContent) logContent.classList.remove('hidden');
                    // ë¡œê·¸ í˜ì´ì§€ í‘œì‹œ í›„ backToMapBtn ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    const backToMapBtn = document.getElementById('backToMapBtn');
                    if (backToMapBtn) {
                        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                        backToMapBtn.removeEventListener('click', handleBackToMap);
                        backToMapBtn.addEventListener('click', handleBackToMap);
                         console.log("Back to Map listener added/updated."); // ë””ë²„ê·¸ ë¡œê·¸
                    } else {
                        console.error("backToMapBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (handleLogView)");
                    }
                    loadAllLogs(selectedUserId);
                } else {
                    customAlert("ì‚¬ìš©ìë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            }

            // function handleDbButtonClick() {
            //      console.log("DB button clicked.");
            //      window.location.href = 'smart_doorlock_firestore_log.html';
            // }

            function handleBackToMap() {
                 console.log("Back to map clicked.");
                 // const mainContent = document.getElementById('main-content'); // ì´ë¯¸ ì „ì—­ì—ì„œ ê°€ì ¸ì˜´
                 // const logContent = document.getElementById('log-content');
                 if (logContent) logContent.classList.add('hidden');
                 if (mainContent) mainContent.classList.remove('hidden');
            }


            // --- ëª¨ë“  ë²„íŠ¼/í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜ ---
            function setupEventListeners() {
                 console.log("Setting up event listeners...");
                // í˜ì´ì§€ ë¡œë“œ ì‹œ í•„ìš”í•œ ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
                const loginForm = document.getElementById('login-form');
                const logoutBtn = document.getElementById('logoutBtn');
                const logBtn = document.getElementById('logBtn');
                // const dbBtn = document.getElementById('dbBtn'); // DB ë²„íŠ¼ ì œê±°ë¨

                // ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (loginForm) {
                    loginForm.addEventListener('submit', handleLoginSubmit);
                     console.log("Login form listener added.");
                } else {
                    console.error("loginForm ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                     console.log("Logout button listener added.");
                } else {
                     console.error("logoutBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                // ë¡œê·¸ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                if (logBtn) {
                    logBtn.addEventListener('click', handleLogView);
                     console.log("Log button listener added.");
                } else {
                     console.error("logBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }

                // DB ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì œê±°ë¨)
                // if (dbBtn) {
                //     dbBtn.addEventListener('click', handleDbButtonClick);
                //      console.log("DB button listener added.");
                // } else {
                //      console.error("dbBtn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                // }

                // ğŸŒŸ backToMapBtn ë¦¬ìŠ¤ë„ˆëŠ” handleLogViewì—ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€/ê´€ë¦¬
            }


            // --- ì´ˆê¸°í™” ë¡œì§ ì‹¤í–‰ ---
            setupEventListeners();

        }; // window.onload ë¦¬ìŠ¤ë„ˆ ë‹«ê¸°

    </script>
</body>
</html>

