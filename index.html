<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capstone Project</title>

    <!-- Google Fonts Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- 통합 CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            padding-top: 70px; /* 헤더 높이만큼 여백 확보 */
            /* overflow: hidden; /* 로그인 시 스크롤 방지 */
            /* 로그인 후 스크롤이 필요하므로 body에서 overflow: hidden 제거 */
        }

        .hidden { display: none !important; }

        /* 로그인 컨테이너 */
        #login-container {
            width: 100%;
            max-width: 400px;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-align: center;
            position: absolute; /* 로그인 화면 중앙 정렬 */
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }

        #login-container h2 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #71b7e6;
        }

        #login-container button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #login-container button:hover {
            opacity: 0.9;
        }

        .extra-links {
            margin-top: 20px;
            font-size: 14px;
        }
        .extra-links a {
            color: #555;
            text-decoration: none;
        }
        .extra-links a:hover {
            text-decoration: underline;
            color: #71b7e6;
        }

        /* 메인 콘텐츠 스타일 */
        #header {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            padding: 10px 20px;
            background-color: #f8f9fa;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            z-index: 500;
        }
        #header h1 { margin: 0; font-size: 24px; }

        /* 헤더 버튼 그룹 */
        #header .button-group {
            display: flex;
            gap: 10px;
        }

        /* 🌟 헤더 버튼 공통 스타일 (DB 버튼 제외) */
        #logoutBtn, #logBtn {
            padding: 8px 15px;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease; /* 부드러운 전환 효과 */
        }

        /* 🌟 각 버튼 색상 */
        #logoutBtn { background-color: #dc3545; } /* 로그아웃: 빨간색 */
        #logBtn { background-color: #007bff; } /* 로그 보기: 파란색 */


        /* 🌟 각 버튼 hover 효과 */
        #logoutBtn:hover { background-color: #c82333; }
        #logBtn:hover { background-color: #0056b3; }


        /* 🌟 로그 버튼 비활성화 스타일 */
        #logBtn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6; /* 비활성화 시 약간 투명하게 */
        }

        #main-content {
            display: flex;
            padding: 10px;
            gap: 20px;
            width: 100%;
            height: calc(100vh - 70px); /* 헤더 높이 제외 */
            background-color: #fff;
            overflow: hidden; /* 자식 요소들이 넘치지 않도록 */
        }


        #sidebar {
            display: flex;
            flex-direction: column;
            width: 12.5%;
            gap: 15px;
            height: 100%;
        }

        #userList, #userInfo, #mapArea {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #fff;
        }

        #userList {
            overflow-y: auto;
            flex-grow: 1;
            min-height: 0;
        }
        #userInfo {
            overflow-y: auto;
            height: 45%;
            flex-shrink: 0;
        }
        #mapArea { flex-grow: 1; }

        .user {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .user:hover { background-color: #f0f0f0; }
        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #map {
            width: 100%;
            height: calc(100% - 40px); /* 제목 높이 등을 고려 */
            margin-top: 10px;
        }
        .log-entry {
            padding: 8px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            border-radius: 4px;
            line-height: 1.5; /* 줄 간격 추가 */
        }
        .log-entry:hover {
            background-color: #e9ecef;
        }

        /* 로그 페이지 스타일 */
        #log-content {
            width: 100%;
            height: calc(100vh - 70px);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background-color: #fff;
            position: fixed; /* 메인 컨텐츠 위에 덮어씌우도록 */
            top: 70px; /* 헤더 아래 */
            left: 0;
            z-index: 600; /* 메인 컨텐츠보다 위에 오도록 */
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-shrink: 0;
        }

        #backToMapBtn {
            padding: 8px 15px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        #backToMapBtn:hover {
            background-color: #e0e0e0;
        }

        .log-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            overflow: hidden;
        }

        .log-section {
            width: 50%;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .log-section h3 {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .log-section .log-entries {
            overflow-y: auto;
            flex-grow: 1;
        }

        .full-log-entry {
            padding: 8px 5px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        /* 커스텀 모달 스타일 */
        #custom-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            max-width: 350px;
            text-align: center;
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 16px;
        }
        .modal-content button {
            padding: 10px 20px;
            background-color: #71b7e6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        /* --- 🌟 커스텀 오버레이(정보창) 스타일 추가 --- */
        .custom-overlay-info {
            padding: 5px 10px;
            font-size: 12px;
            text-align: left;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 1px solid #ccc;
        }
    </style>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=75f5ad508e0e54ef29a0f0dc6e89ef5a&autoload=false"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- 스크립트 실행 지연을 위해 함수로 래핑 ---
        function initializeApp() {
            console.log("initializeApp called."); // 디버그 로그

            // --- 🌟 필수 DOM 요소 확인 ---
            const loginContainer = document.getElementById('login-container');
            const mainContent = document.getElementById('main-content');
            const header = document.getElementById('header');
            const logContent = document.getElementById('log-content');

            // --- 🌟 초기 UI 상태 설정 ---
            if (loginContainer) loginContainer.classList.remove('hidden');
            if (mainContent) mainContent.classList.add('hidden');
            if (header) header.classList.add('hidden');
            if (logContent) logContent.classList.add('hidden');

            // --- 🌟 필수 요소 없으면 중단 ---
            if (!loginContainer || !mainContent || !header || !logContent) {
                console.error("Critical UI elements not found. Aborting initialization.");
                alert("페이지 로딩 오류: 필수 UI 요소를 찾을 수 없습니다.");
                return;
            }


            // 커스텀 alert 함수
            function customAlert(message) {
                const modal = document.getElementById('custom-modal');
                const messageElem = document.getElementById('modal-message');
                if (modal && messageElem) {
                    messageElem.textContent = message;
                    modal.classList.remove('hidden');
                    modal.style.display = 'flex';
                } else {
                    console.error("Custom modal elements not found, using standard alert.");
                    alert(message);
                }
            }

            // ▼▼▼ Firebase 설정 정보 ▼▼▼
            const firebaseConfig = {
                apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
                authDomain: "smartdoorlock-b4636.firebaseapp.com",
                databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
                projectId: "smartdoorlock-b4636",
                storageBucket: "smartdoorlock-b4636.firebasestorage.app",
                messagingSenderId: "104489505270",
                appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
                measurementId: "G-4TH9MB9WPM"
            };

            // 전역 변수 (Firebase 초기화 후 할당)
            let database;
            let map;
            let markers = [];
            let currentPolyline;
            let selectedLogMarker;
            let selectedUserId = null;
            let selectedMarkerImage;
            let pathMarkerImage;

            // --- Firebase 앱 초기화 ---
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log("Firebase initialized successfully.");
            } catch (e) {
                console.error("Firebase 초기화 오류:", e);
                customAlert("Firebase 초기화에 실패했습니다. 콘솔을 확인하세요."); // 🌟 customAlert 사용
                return; // Firebase 초기화 실패 시 더 이상 진행하지 않음
            }

            // 지도 초기화 함수
            function initMap() {
                try {
                    selectedMarkerImage = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png',
                        new kakao.maps.Size(32, 35),
                        { offset: new kakao.maps.Point(16, 35) }
                    );
                    pathMarkerImage = new kakao.maps.MarkerImage(
                        'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/red_dot.png',
                        new kakao.maps.Size(12, 12),
                        { offset: new kakao.maps.Point(6, 6) }
                    );
                    const container = document.getElementById('map');
                    if (!container) {
                        console.error("Map container not found!");
                        return;
                    }
                    map = new kakao.maps.Map(container, {
                        center: new kakao.maps.LatLng(37.566826, 126.9786567),
                        level: 4
                    });
                    map.addControl(new kakao.maps.MapTypeControl(), kakao.maps.ControlPosition.TOPRIGHT);
                    map.addControl(new kakao.maps.ZoomControl(), kakao.maps.ControlPosition.RIGHT);
                    loadUserList();
                } catch (mapError) {
                    console.error("지도 초기화 오류:", mapError);
                    customAlert("지도 초기화 중 오류가 발생했습니다.");
                }
            }

            // 사용자 목록 로드 함수
            function loadUserList() {
                if (!database) {
                    console.error("Firebase Database가 초기화되지 않았습니다. (loadUserList)");
                    return;
                }
                const userListDiv = document.getElementById('userList');
                const h2 = userListDiv?.querySelector('h2');
                if (!h2) {
                    console.error("userListDiv 또는 h2 요소를 찾을 수 없습니다.");
                    return;
                }
                const usersRef = database.ref('users');

                usersRef.once('value').then((snapshot) => {
                    // 기존 목록 초기화 (중복 방지)
                    const existingUsers = userListDiv.querySelectorAll('.user');
                    existingUsers.forEach(el => el.remove());

                    snapshot.forEach((childSnapshot) => {
                        const userId = childSnapshot.key;
                        const userElement = document.createElement('div');
                        userElement.className = 'user';
                        userElement.dataset.name = userId;
                        userElement.textContent = userId;
                        userElement.addEventListener('click', () => selectUser(userId));
                        h2.insertAdjacentElement('afterend', userElement);
                    });
                }).catch(error => {
                    console.error("사용자 목록 로드 오류:", error);
                    customAlert("사용자 목록을 불러오는 데 실패했습니다.");
                });
            }

            // 지도 및 정보 초기화 함수
            function clearMapAndInfo() {
                markers.forEach(marker => {
                    if (marker.customOverlay) {
                        marker.customOverlay.setMap(null);
                    }
                    marker.setMap(null);
                });
                markers = [];
                if (currentPolyline) {
                    currentPolyline.setMap(null);
                    currentPolyline = null;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                    selectedLogMarker = null;
                }
                const infoArea = document.getElementById('infoArea');
                if (infoArea) {
                    infoArea.innerHTML = '';
                }
                 // 사용자 정보 영역 숨기기
                const userInfoDiv = document.getElementById('userInfo');
                if (userInfoDiv) userInfoDiv.classList.add('hidden');
                // 로그 버튼 비활성화
                const logBtn = document.getElementById('logBtn');
                if (logBtn) logBtn.disabled = true;
                // 지도 설명 초기화
                const mapUserElem = document.getElementById('mapUser');
                if (mapUserElem) mapUserElem.textContent = '사용자를 선택하면 이동 경로가 표시됩니다.';

            }

            // 위치 마커 표시 함수
            function showLocationOnMap(lat, lng) {
                console.log("showLocationOnMap 호출됨:", { lat, lng, mapDefined: !!map });
                if (!map) {
                    customAlert("지도가 아직 로드되지 않았습니다. 잠시 후 다시 시도해주세요.");
                    return;
                }
                if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
                    console.error("잘못된 좌표값입니다:", lat, lng);
                    customAlert("잘못된 위치 정보입니다. 콘솔을 확인해주세요.");
                    return;
                }
                if (selectedLogMarker) {
                    selectedLogMarker.setMap(null);
                }
                const position = new kakao.maps.LatLng(lat, lng);
                selectedLogMarker = new kakao.maps.Marker({
                    position: position,
                    map: map,
                    image: selectedMarkerImage
                });
                map.panTo(position);
            }

            // 사용자 선택 함수
            function selectUser(userId) {
                clearMapAndInfo(); // 먼저 지도와 정보창 클리어
                selectedUserId = userId;
                const logBtn = document.getElementById('logBtn');
                if(logBtn) logBtn.disabled = false;

                const infoArea = document.getElementById('infoArea');
                const userInfoDiv = document.getElementById('userInfo'); // userInfo 요소 가져오기

                if (infoArea && userInfoDiv) { // 두 요소 모두 있는지 확인
                    infoArea.innerHTML = `<p><strong>사용자 ID:</strong> ${userId}</p><h3>전체 위치 기록</h3><div class="log-list" style="max-height: 400px; overflow-y: auto;"></div>`;
                    userInfoDiv.classList.remove('hidden'); // userInfo 보이기
                } else {
                    console.error("infoArea 또는 userInfo 요소를 찾을 수 없습니다.");
                    return;
                }

                if (!database) {
                    console.error("Firebase Database가 초기화되지 않았습니다. (selectUser)");
                    return;
                }
                const locationsRef = database.ref('users/' + userId + '/location_logs');

                locationsRef.once('value').then((snapshot) => {
                    const logListDiv = infoArea.querySelector('.log-list');
                    if (!logListDiv) {
                        console.error(".log-list 요소를 찾을 수 없습니다.");
                        return;
                    }
                    if (!snapshot.exists()) {
                        logListDiv.innerHTML = '표시할 위치 기록이 없습니다.';
                        // return; // 기록이 없어도 최근 10개는 로드 시도
                    } else {
                        const logs = [];
                        snapshot.forEach(childSnapshot => logs.push(childSnapshot.val()));
                        logs.reverse().forEach(pos => {
                            if (!pos.latitude || !pos.longitude) return;

                            const parsedLat = parseFloat(pos.latitude);
                            const parsedLng = parseFloat(pos.longitude);

                            const logEntry = document.createElement('div');
                            logEntry.className = 'log-entry';

                            let displayText = `위도: ${parsedLat.toFixed(6)}<br>경도: ${parsedLng.toFixed(6)}`;
                            if (pos.altitude !== undefined && pos.altitude !== null) {
                                displayText += `<br>고도: ${parseFloat(pos.altitude).toFixed(2)}m`;
                            }
                            logEntry.innerHTML = displayText;

                            logEntry.addEventListener('click', () => showLocationOnMap(parsedLat, parsedLng));
                            logListDiv.appendChild(logEntry);
                        });
                    }
                }).catch(error => {
                    console.error("위치 기록 로드 오류:", error);
                    customAlert("위치 기록을 불러오는 데 실패했습니다.");
                 });


                const recentLocationsQuery = database.ref('users/' + userId + '/location_logs').limitToLast(10);

                recentLocationsQuery.once('value').then((snapshot) => {
                    const mapUserElem = document.getElementById('mapUser');
                    if (!mapUserElem) {
                         console.error("mapUser 요소를 찾을 수 없습니다.");
                         return;
                    }
                    if (!snapshot.exists()) {
                        mapUserElem.textContent = `${userId} 사용자의 위치 기록이 없습니다.`;
                        return; // 최근 기록 없으면 여기서 종료
                    }
                    mapUserElem.textContent = `${userId}의 최근 이동 경로 (최대 10개)를 표시합니다.`;
                    let path = [];
                    const bounds = new kakao.maps.LatLngBounds();
                    // let lastPos = null; // lastPos 사용되지 않음

                     // 기존 마커 및 폴리라인 제거 (selectUser 시작 시 clearMapAndInfo에서 처리됨)

                    snapshot.forEach((snap) => {
                        const pos = snap.val();
                        if (!pos.latitude || !pos.longitude) return;

                        const parsedLat = parseFloat(pos.latitude);
                        const parsedLng = parseFloat(pos.longitude);
                        const latlng = new kakao.maps.LatLng(parsedLat, parsedLng);
                        path.push(latlng);

                        const marker = new kakao.maps.Marker({
                            position: latlng,
                            map: map,
                            image: pathMarkerImage
                        });

                        // --- 마커 커스텀 오버레이(정보창) 추가 ---
                        const timestamp = pos.timestamp || Date.now();
                        const formattedTime = new Date(timestamp).toLocaleString('ko-KR', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });

                        const overlayContent = `<div class="custom-overlay-info">
                                                    <strong>${formattedTime}</strong><br>
                                                    위도: ${parsedLat.toFixed(6)}<br>
                                                    경도: ${parsedLng.toFixed(6)}
                                                </div>`;

                        const customOverlay = new kakao.maps.CustomOverlay({
                            content: overlayContent,
                            position: latlng,
                            xAnchor: 0.5,
                            yAnchor: 2.5,
                            zIndex: 3
                        });

                        marker.customOverlay = customOverlay; // 오버레이 참조 저장

                        kakao.maps.event.addListener(marker, 'mouseover', function() {
                            customOverlay.setMap(map);
                        });

                        kakao.maps.event.addListener(marker, 'mouseout', function() {
                            customOverlay.setMap(null);
                        });

                        // --- 마커 커스텀 오버레이 추가 끝 ---

                        markers.push(marker); // 새로 생성된 마커 배열에 추가
                        bounds.extend(latlng);
                        // lastPos = latlng; // lastPos 사용되지 않음
                    });

                    if (path.length > 0 && map) {
                        // 기존 폴리라인 제거 (selectUser 시작 시 clearMapAndInfo에서 처리됨)
                        currentPolyline = new kakao.maps.Polyline({
                            path: path, strokeWeight: 4, strokeColor: '#FF0000', strokeOpacity: 0.8, strokeStyle: 'solid', map: map
                        });
                        map.setBounds(bounds);
                    }
                }).catch(error => {
                     console.error("최근 위치 로드 오류:", error);
                     customAlert("최근 위치를 불러오는 데 실패했습니다.");
                 });
            }

            // 사용자 정보 닫기 함수
            function closeUserInfo() {
                const userInfoDiv = document.getElementById('userInfo');
                if (userInfoDiv) userInfoDiv.classList.add('hidden');
            }

            // 모든 로그 로드 함수
            function loadAllLogs(userId) {
                if (!database) {
                     console.error("Firebase Database가 초기화되지 않았습니다. (loadAllLogs)");
                     return;
                }
                const doorLockLogContainer = document.querySelector('#doorLockLogs .log-entries');
                const appLogContainer = document.querySelector('#appLogs .log-entries');
                const logUserTitle = document.getElementById('logUserTitle');

                if (!doorLockLogContainer || !appLogContainer || !logUserTitle) {
                    console.error("로그 표시 영역 또는 타이틀 요소를 찾을 수 없습니다.");
                    return;
                }

                logUserTitle.textContent = `${userId} 사용자의 전체 로그`;
                doorLockLogContainer.innerHTML = '<em>로딩 중...</em>';
                appLogContainer.innerHTML = '<em>로딩 중...</em>';

                const doorLockRef = database.ref('users/' + userId + '/door_lock_logs');
                doorLockRef.once('value').then((snapshot) => {
                    doorLockLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        doorLockLogContainer.innerHTML = '표시할 로그가 없습니다.';
                        return;
                    }
                    const logs = [];
                    snapshot.forEach(child => logs.push(child.val()));
                    logs.reverse().forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = 'full-log-entry';
                        const formattedTime = new Date(log.timestamp || Date.now()).toLocaleString('ko-KR');
                        entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.action || 'N/A'}`;
                        doorLockLogContainer.appendChild(entry);
                    });
                }).catch(error => {
                    console.error("도어락 로그 로드 오류:", error);
                    doorLockLogContainer.innerHTML = '로그 로드 실패';
                });

                const appLogRef = database.ref('users/' + userId + '/app_logs');
                appLogRef.once('value').then((snapshot) => {
                    appLogContainer.innerHTML = '';
                    if (!snapshot.exists()) {
                        appLogContainer.innerHTML = '표시할 로그가 없습니다.';
                        return;
                    }
                    const logs = [];
                    snapshot.forEach(child => logs.push(child.val()));
                    logs.reverse().forEach(log => {
                        const entry = document.createElement('div');
                        entry.className = 'full-log-entry';
                        const formattedTime = new Date(log.timestamp || Date.now()).toLocaleString('ko-KR');
                        entry.innerHTML = `<strong>[${formattedTime}]</strong>: ${log.event || 'N/A'}`;
                        appLogContainer.appendChild(entry);
                    });
                }).catch(error => {
                     console.error("앱 로그 로드 오류:", error);
                     appLogContainer.innerHTML = '로그 로드 실패';
                 });
            }


            // --- 이벤트 핸들러 함수 정의 ---
            function handleLoginSubmit(e) {
                e.preventDefault();
                console.log("Login submitted.");
                // const loginContainer = document.getElementById('login-container'); // 이미 전역에서 가져옴
                // const mainContent = document.getElementById('main-content');
                // const header = document.getElementById('header');
                const body = document.querySelector('body');
                const usernameInput = document.getElementById('username')?.value.trim();
                const passwordInput = document.getElementById('password')?.value.trim();

                if (!usernameInput || !passwordInput) {
                    customAlert('아이디와 비밀번호를 올바르게 입력해주세요.');
                    return;
                }

                if (!database) {
                    console.error("Firebase Database가 초기화되지 않았습니다. (Login Submit)");
                    customAlert("데이터베이스 연결 오류");
                    return;
                }
                const adminRef = database.ref('admin_pass');

                adminRef.once('value').then((snapshot) => {
                    let loginSuccess = false;
                    if (snapshot.exists()) {
                        snapshot.forEach((childSnapshot) => {
                            const adminData = childSnapshot.val();
                            if (adminData.adminId === usernameInput && adminData.password === passwordInput) {
                                loginSuccess = true;
                                return true;
                            }
                        });
                    }

                    if (loginSuccess) {
                        console.log("Login successful.");
                        if (loginContainer) loginContainer.classList.add('hidden');
                        if (mainContent) mainContent.classList.remove('hidden');
                        if (header) header.classList.remove('hidden');
                        if(body) {
                            body.style.background = '#fff';
                            body.style.overflow = 'auto';
                        }
                        if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.load) {
                            console.log("Loading Kakao Maps...");
                            kakao.maps.load(initMap);
                        } else {
                             console.error("Kakao Maps SDK가 로드되지 않았거나 load 함수가 없습니다.");
                             customAlert("지도 SDK 로딩 오류");
                        }
                    } else {
                        console.log("Login failed.");
                        customAlert('아이디 또는 비밀번호가 일치하지 않습니다.');
                    }
                }).catch(error => {
                     console.error("로그인 처리 오류:", error);
                     customAlert("로그인 중 오류가 발생했습니다.");
                 });
            }

            function handleLogout() {
                console.log("Logout clicked.");
                // 간단하게 페이지 새로고침으로 로그아웃 처리
                window.location.reload();
            }

            function handleLogView() {
                console.log("Log view clicked.");
                // const mainContent = document.getElementById('main-content'); // 이미 전역에서 가져옴
                // const logContent = document.getElementById('log-content');
                if (selectedUserId) {
                    if (mainContent) mainContent.classList.add('hidden');
                    if (logContent) logContent.classList.remove('hidden');
                    // 로그 페이지 표시 후 backToMapBtn 리스너 추가
                    const backToMapBtn = document.getElementById('backToMapBtn');
                    if (backToMapBtn) {
                        // 기존 리스너 제거 후 추가 (중복 방지)
                        backToMapBtn.removeEventListener('click', handleBackToMap);
                        backToMapBtn.addEventListener('click', handleBackToMap);
                         console.log("Back to Map listener added/updated."); // 디버그 로그
                    } else {
                        console.error("backToMapBtn 요소를 찾을 수 없습니다. (handleLogView)");
                    }
                    loadAllLogs(selectedUserId);
                } else {
                    customAlert("사용자를 먼저 선택해주세요.");
                }
            }

            // function handleDbButtonClick() {
            //      console.log("DB button clicked.");
            //      window.location.href = 'smart_doorlock_firestore_log.html';
            // }

            function handleBackToMap() {
                 console.log("Back to map clicked.");
                 // const mainContent = document.getElementById('main-content'); // 이미 전역에서 가져옴
                 // const logContent = document.getElementById('log-content');
                 if (logContent) logContent.classList.add('hidden');
                 if (mainContent) mainContent.classList.remove('hidden');
            }


            // --- 모든 버튼/폼 이벤트 리스너를 설정하는 함수 ---
            function setupEventListeners() {
                 console.log("Setting up event listeners...");
                // 페이지 로드 시 필요한 요소들을 가져옵니다.
                const loginForm = document.getElementById('login-form');
                const logoutBtn = document.getElementById('logoutBtn');
                const logBtn = document.getElementById('logBtn');
                // const dbBtn = document.getElementById('dbBtn'); // DB 버튼 제거됨

                // 로그인 폼 이벤트 리스너 추가
                if (loginForm) {
                    loginForm.addEventListener('submit', handleLoginSubmit);
                     console.log("Login form listener added.");
                } else {
                    console.error("loginForm 요소를 찾을 수 없습니다.");
                }

                // 로그아웃 버튼 이벤트 리스너 추가
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', handleLogout);
                     console.log("Logout button listener added.");
                } else {
                     console.error("logoutBtn 요소를 찾을 수 없습니다.");
                }

                // 로그 보기 버튼 이벤트 리스너 추가
                if (logBtn) {
                    logBtn.addEventListener('click', handleLogView);
                     console.log("Log button listener added.");
                } else {
                     console.error("logBtn 요소를 찾을 수 없습니다.");
                }

                // DB 버튼 이벤트 리스너 추가 (제거됨)
                // if (dbBtn) {
                //     dbBtn.addEventListener('click', handleDbButtonClick);
                //      console.log("DB button listener added.");
                // } else {
                //      console.error("dbBtn 요소를 찾을 수 없습니다.");
                // }

                // 🌟 backToMapBtn 리스너는 handleLogView에서 동적으로 추가/관리
            }


            // --- 초기화 로직 실행 ---
            setupEventListeners();

        }; // window.onload 리스너 닫기

    </script>
</body>
</html>

