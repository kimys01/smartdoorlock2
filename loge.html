<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½ ë¡œê·¸ (Firestore)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì‚¬ìš© -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ê°„ë‹¨í•œ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* JSë¡œ ì¶”ê°€ë  ë•Œ ê°„ë‹¨í•œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-once {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse-once 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto max-w-3xl p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <header class="bg-gradient-to-r from-blue-600 to-blue-800 p-6">
                <h1 class="text-2xl font-bold text-white">ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½ ì‹¤ì‹œê°„ ë¡œê·¸</h1>
                <p class="text-blue-100 text-sm mt-1">Firestoreì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
            </header>
            
            <div id="logs-container" class="p-6 space-y-4 min-h-[200px]">
                <!-- ë¡œë”© ìƒíƒœ -->
                <div id="loading-state" class="flex flex-col items-center justify-center text-gray-500 py-10">
                    <div class="spinner mb-4"></div>
                    <p>Firebaseì— ì—°ê²°í•˜ê³  ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- ë¹„ì–´ìˆëŠ” ìƒíƒœ -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center text-gray-500 py-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="font-medium">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm">Firestore ì½˜ì†”ì—ì„œ ì§ì ‘ ë¡œê·¸ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”.</p>
                </div>
                
                <!-- ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ê°€ ë Œë”ë§ë  ê³³ -->
                <ul id="log-list" class="space-y-3">
                    <!-- ë¡œê·¸ í•­ëª© ì˜ˆì‹œ (JSë¡œ ë™ì  ìƒì„±ë¨) -->
                    <!-- 
                    <li class="p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 flex items-center justify-center rounded-full bg-blue-100">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                </svg>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">í‚¤íŒ¨ë“œ</p>
                                <p class="text-sm text-gray-500">2025ë…„ 10ì›” 24ì¼ ì˜¤í›„ 5:30:15</p>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">
                            ì ê¸ˆ í•´ì œ
                        </span>
                    </li>
                    -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const logsContainer = document.getElementById('logs-container');
        const logList = document.getElementById('log-list');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');

        // --- ğŸŒŸ Firebase ì—°ê²° 1ë‹¨ê³„: ì„¤ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
        // ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ __firebase_config ë³€ìˆ˜ë¥¼ ì£¼ì…í•©ë‹ˆë‹¤.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let db;
        let auth;
        let userId = null;

        try {
            // --- ğŸŒŸ Firebase ì—°ê²° 2ë‹¨ê³„: ì•± ì´ˆê¸°í™” ---
            // ì´ ì½”ë“œê°€ Firebase í”„ë¡œì íŠ¸ì— ì—°ê²°í•©ë‹ˆë‹¤.
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app); // Firestore ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©
            auth = getAuth(app);
            setLogLevel('debug'); // Firestore ë””ë²„ê·¸ ë¡œê·¸ í™œì„±í™”

            // --- ğŸŒŸ Firebase ì—°ê²° 3ë‹¨ê³„: ì¸ì¦ ---
            // onAuthStateChangedëŠ” ì¸ì¦ ìƒíƒœë¥¼ ê°ì‹œí•©ë‹ˆë‹¤.
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated User ID:", userId);
                    // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ë¡œê·¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    setupLogListener();
                } else {
                    console.log("No user signed in, attempting auth...");
                    try {
                        // ìº”ë²„ìŠ¤ í™˜ê²½ì˜ í† í°(__initial_auth_token)ìœ¼ë¡œ ë¡œê·¸ì¸ ì‹œë„
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // í† í°ì´ ì—†ìœ¼ë©´ ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸ (í…ŒìŠ¤íŠ¸ìš©)
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Authentication error:", authError);
                        loadingState.innerHTML = '<p class="text-red-500">ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
                    }
                }
            });

        } catch (e) {
            console.error("Firebase initialization error:", e);
            loadingState.innerHTML = '<p class="text-red-500">Firebase ì´ˆê¸°í™” ì˜¤ë¥˜. F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
        }

        /**
         * ë¡œê·¸ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì‹œí•˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function setupLogListener() {
            // --- ğŸŒŸ Firebase ì—°ê²° 4ë‹¨ê³„: ë°ì´í„° ê²½ë¡œ ì„¤ì • ---
            // ì´ ì½”ë“œê°€ Firestoreì˜ íŠ¹ì • ì»¬ë ‰ì…˜ì„ ê°€ë¦¬í‚µë‹ˆë‹¤.
            // (ì´ì „ ì½”ë“œì˜ Realtime Database ê²½ë¡œì™€ëŠ” ë‹¤ë¦…ë‹ˆë‹¤!)
            const logCollectionPath = `artifacts/${appId}/public/data/door_logs`;
            console.log(`Listening for logs at: ${logCollectionPath}`);
            
            const logsCollectionRef = collection(db, logCollectionPath);
            
            // Firestore ì¿¼ë¦¬ (orderByëŠ” ì¸ë±ì‹±ì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì‚¬ìš©í•˜ì§€ ì•Šê³  JSë¡œ ì •ë ¬í•©ë‹ˆë‹¤)
            const q = query(logsCollectionRef);

            // --- ğŸŒŸ Firebase ì—°ê²° 5ë‹¨ê³„: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ---
            // onSnapshotì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì‹œê°„ ë³€ê²½(ì¶”ê°€, ìˆ˜ì •, ì‚­ì œ)ì„ ê°ì§€í•©ë‹ˆë‹¤.
            onSnapshot(q, (snapshot) => {
                loadingState.classList.add('hidden'); // ë¡œë”© ìˆ¨ê¸°ê¸°
                
                const logs = [];
                snapshot.forEach((doc) => {
                    logs.push({ id: doc.id, ...doc.data() });
                });

                // ìë°”ìŠ¤í¬ë¦½íŠ¸ ë©”ëª¨ë¦¬ì—ì„œ ì‹œê°„ìˆœ(ìµœì‹ ìˆœ)ìœ¼ë¡œ ì •ë ¬
                // (Firestoreì˜ timestamp ê°ì²´ëŠ” toMillis()ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ)
                logs.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis() || 0;
                    const timeB = b.timestamp?.toMillis() || 0;
                    return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹  í•­ëª©ì´ ìœ„ë¡œ)
                });

                renderLogs(logs);

            }, (error) => {
                console.error("Error listening to logs:", error);
                loadingState.innerHTML = `<p class="text-red-500">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            });
        }

        /**
         * ë¡œê·¸ ë°°ì—´ì„ ë°›ì•„ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array} logs - ë¡œê·¸ ë°ì´í„° ë°°ì—´
         */
        function renderLogs(logs) {
            logList.innerHTML = ''; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

            if (logs.length === 0) {
                emptyState.classList.remove('hidden'); // ë¡œê·¸ ì—†ìŒ í‘œì‹œ
            } else {
                emptyState.classList.add('hidden'); // ë¡œê·¸ ì—†ìŒ ìˆ¨ê¸°ê¸°
            }

            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center animate-pulse-once'; // ê°„ë‹¨í•œ ë“±ì¥ íš¨ê³¼
                
                const methodText = getMethodText(log.method);
                const iconSvg = getMethodIcon(log.method);
                
                // timestampê°€ nullì´ê±°ë‚˜ toDateê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
                let timeString = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                if (log.timestamp && typeof log.timestamp.toDate === 'function') {
                    const date = log.timestamp.toDate();
                    timeString = date.toLocaleString('ko-KR', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });
                }
                
                const statusText = log.status === 'Unlocked' ? 'ì ê¸ˆ í•´ì œ' : 'ì ê¹€';
                const statusColorClass = log.status === 'Unlocked' 
                    ? 'text-green-600 bg-green-100' 
                    : 'text-red-600 bg-red-100';

                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 flex items-center justify-center rounded-full ${iconSvg.bgColor}">
                            ${iconSvg.svg}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${methodText}</p>
                            <p class="text-sm text-gray-500">${timeString}</p>
                        </div>
                    </div>
                    <span class="text-sm font-medium ${statusColorClass} px-3 py-1 rounded-full">
                        ${statusText}
                    </span>
                `;
                logList.appendChild(li);
            });
        }

        /**
         * ë¡œê·¸ ë©”ì†Œë“œ(method) ë¬¸ìì—´ì— ë”°ë¼ ì ì ˆí•œ í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} method - 'keypad', 'rfid', 'app', 'gps' ë“±
         */
        function getMethodText(method) {
            switch(method) {
                case 'keypad': return 'í‚¤íŒ¨ë“œ';
                case 'rfid': return 'RFID';
                case 'app': return 'ì• í”Œë¦¬ì¼€ì´ì…˜';
                case 'gps': return 'GPS ìë™ í•´ì œ';
                default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }

        /**
         * ë¡œê·¸ ë©”ì†Œë“œì— ë”°ë¼ ì•„ì´ì½˜ SVGì™€ ë°°ê²½ìƒ‰ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} method - 'keypad', 'rfid', 'app', 'gps' ë“±
         */
        function getMethodIcon(method) {
            const icons = {
                keypad: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>`,
                    bgColor: 'bg-blue-100'
                },
                rfid: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m4 0h1M4 4h16v5H4V4z" />
                            </svg>`,
                    bgColor: 'bg-indigo-100'
                },
                app: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>`,
                    bgColor: 'bg-green-100'
                },
                gps: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>`,
                    bgColor: 'bg-purple-100'
                },
                default: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>`,
                    bgColor: 'bg-gray-100'
                }
            };
            return icons[method] || icons.default;
        }

    </script>
</body>
</html>

