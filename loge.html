<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>데이터베이스 조회</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="logestyle.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        /* 그리드 셀 안의 내용이 한 줄로 나오게 처리 (줄바꿈 방지) */
        .styled-table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; /* 너무 길면 ... 처리 */
        }
        .styled-table th {
            white-space: nowrap;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: white;
        }
    </style>
</head>
<body>

    <div class="container" style="max-width: 1200px;"> <a href="index.html" class="back-link">&larr; 메인으로 돌아가기</a>

        <h2>데이터베이스 조회 (String Grid View)</h2>

        <div class="search-container">
            <input type="text" id="search-input" placeholder="검색할 사용자 ID를 입력하세요 (예: 123456)">
            <button class="btn-search" onclick="searchUser()">검색</button>
            <button class="btn-reset" onclick="loadAllData()" style="background:#6c757d; margin-left:5px;">전체 목록</button>
        </div>

        <h3 id="result-title">사용자 목록:</h3>
        
        <div id="result-area" style="overflow-x: auto;">
            <div class="message-box">데이터를 불러오는 중입니다...</div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.firebaseapp.com",
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', () => {
            loadAllData();
        });

        function loadAllData() {
            const resultArea = document.getElementById('result-area');
            const title = document.getElementById('result-title');
            
            title.textContent = "전체 사용자 목록:";
            resultArea.innerHTML = '<div class="message-box">전체 데이터를 불러오는 중...</div>';
            document.getElementById('search-input').value = '';

            database.ref('users').once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    renderGrid(snapshot.val());
                } else {
                    resultArea.innerHTML = '<div class="message-box">저장된 사용자 데이터가 없습니다.</div>';
                }
            }).catch((error) => {
                resultArea.innerHTML = `<div class="message-box" style="color: red;">데이터 로드 실패: ${error.message}</div>`;
            });
        }

        function searchUser() {
            const input = document.getElementById('search-input');
            const resultArea = document.getElementById('result-area');
            const title = document.getElementById('result-title');
            const userId = input.value.trim();

            if (!userId) {
                alert("사용자 ID를 입력해주세요.");
                return;
            }

            title.textContent = `'${userId}' 검색 결과:`;
            resultArea.innerHTML = '<div class="message-box">검색 중...</div>';

            const userRef = database.ref('users/' + userId);
            
            userRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const wrapper = {};
                    wrapper[userId] = snapshot.val();
                    renderGrid(wrapper);
                } else {
                    resultArea.innerHTML = `<div class="message-box" style="color: #dc3545;">'${userId}' 사용자를 찾을 수 없습니다.</div>`;
                }
            }).catch((error) => {
                resultArea.innerHTML = `<div class="message-box" style="color: red;">에러 발생: ${error.message}</div>`;
            });
        }

        // --- [핵심] 진짜 스트링 그리드 형태로 렌더링하는 함수 ---
        function renderGrid(data) {
            const resultArea = document.getElementById('result-area');
            
            // 1. 테이블 헤더 정의 (보여주고 싶은 컬럼들)
            // 여기서 원하는 컬럼을 추가하거나 뺄 수 있습니다.
            const columns = [
                { header: '사용자 ID', key: 'uid' }, // 키(Key) 자체
                { header: '인증 방식', key: 'authMethod' },
                { header: '자동 잠금', key: 'detailSettings.autoLockEnabled' },
                { header: '잠금 시간(초)', key: 'detailSettings.autoLockTime' },
                { header: '알림 설정', key: 'detailSettings.notifyOnLock' },
                { header: '앱 로그 수', key: 'app_logs_count' }, // 계산된 값
                { header: '위치 로그 수', key: 'location_logs_count' } // 계산된 값
            ];

            let tableHtml = `
                <table class="styled-table">
                    <thead>
                        <tr>
            `;

            // 헤더 생성
            columns.forEach(col => {
                tableHtml += `<th>${col.header}</th>`;
            });

            tableHtml += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // 2. 데이터 행 생성
            for (const [userId, userData] of Object.entries(data)) {
                tableHtml += `<tr>`;

                // 각 컬럼에 맞는 데이터를 추출해서 셀(td) 생성
                columns.forEach(col => {
                    let cellValue = '-'; // 기본값

                    if (col.key === 'uid') {
                        // 사용자 ID
                        cellValue = `<strong>${userId}</strong>`;
                    } else if (col.key === 'app_logs_count') {
                        // 로그 개수 카운트 (데이터가 있으면 개수 표시)
                        cellValue = userData.app_logs ? Object.keys(userData.app_logs).length + ' 개' : '0 개';
                    } else if (col.key === 'location_logs_count') {
                        cellValue = userData.location_logs ? Object.keys(userData.location_logs).length + ' 개' : '0 개';
                    } else {
                        // 일반 데이터 (중첩된 객체 탐색: detailSettings.autoLockEnabled 등)
                        const keys = col.key.split('.'); // 점(.)으로 분리
                        let val = userData;
                        for (let k of keys) {
                            val = val ? val[k] : undefined;
                        }
                        
                        // 값이 존재하면 표시 (true/false 등 처리)
                        if (val !== undefined) {
                            if (val === true) cellValue = '<span style="color:green">ON</span>';
                            else if (val === false) cellValue = '<span style="color:gray">OFF</span>';
                            else cellValue = val;
                        }
                    }

                    tableHtml += `<td>${cellValue}</td>`;
                });

                tableHtml += `</tr>`;
            }

            tableHtml += `
                    </tbody>
                </table>
            `;

            resultArea.innerHTML = tableHtml;
        }

        document.getElementById('search-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchUser();
        });
    </script>
</body>
</html>
