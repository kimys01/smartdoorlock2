<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Editor - Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="loge.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="header">
        <h1>데이터베이스 편집기</h1>
        <button id="backBtn" onclick="window.location.href='index.html'">메인으로 돌아가기</button>
    </div>

    <div id="container">
        <div id="tree-panel">
            <div class="panel-header">
                <span>DB 탐색기</span>
                <button class="btn btn-refresh" onclick="loadDatabase()" style="padding: 5px 10px; font-size:12px;">
                    <i class="fas fa-sync-alt"></i> 새로고침
                </button>
            </div>
            <div id="tree-content">
                <div style="text-align:center; margin-top:20px; color:#999;">데이터 로딩 중...</div>
            </div>
        </div>

        <div id="editor-panel">
            <div class="panel-header">데이터 수정</div>
            <div id="editor-area">
                <div>
                    <label style="font-size:12px; color:#777;">현재 경로:</label>
                    <div id="current-path" class="path-display">/</div>
                </div>
                
                <label style="font-size:12px; color:#777;">JSON 데이터 (직접 수정 가능):</label>
                <textarea id="json-editor" spellcheck="false"></textarea>

                <div class="action-buttons">
                    <button class="btn btn-add" onclick="addChildNode()">
                        <i class="fas fa-plus"></i> 자식 추가
                    </button>
                    <button class="btn btn-delete" onclick="deleteCurrentNode()">
                        <i class="fas fa-trash"></i> 현재 경로 삭제
                    </button>
                    <button class="btn btn-save" onclick="saveCurrentData()">
                        <i class="fas fa-save"></i> 변경사항 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase 설정 ---
        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.firebaseapp.com",
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 전역 변수
        let fullData = null; // DB 전체 데이터
        let currentPath = "/"; // 현재 선택된 경로

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
        });

        // --- 1. DB 전체 데이터 로드 및 트리 생성 ---
        function loadDatabase() {
            const treeContent = document.getElementById('tree-content');
            treeContent.innerHTML = '<div style="text-align:center; margin-top:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 데이터 불러오는 중...</div>';

            // 루트 경로(/)에서 모든 데이터를 가져옴
            database.ref('/').once('value').then(snapshot => {
                fullData = snapshot.val();
                renderTree();
                selectNode('/'); // 초기에는 루트 선택
            }).catch(err => {
                console.error(err);
                treeContent.innerHTML = '<div style="color:red; text-align:center; margin-top:20px;">데이터 로드 실패</div>';
                alert('데이터를 불러오지 못했습니다: ' + err.message);
            });
        }

        // --- 2. 트리 뷰 렌더링 (재귀 함수) ---
        function renderTree() {
            const treeContent = document.getElementById('tree-content');
            treeContent.innerHTML = '';

            const rootUl = document.createElement('div');
            // 루트 노드 생성
            rootUl.appendChild(createTreeNode('Root', fullData, ''));
            treeContent.appendChild(rootUl);
        }

        function createTreeNode(key, data, parentPath) {
            // 현재 경로 계산
            const currentPathStr = parentPath === '' ? key : (parentPath === '/' ? '/' + key : parentPath + '/' + key);
            const actualPath = parentPath === '' ? '/' : currentPathStr; // Root는 '/'로 취급

            const container = document.createElement('div');
            
            // 노드 헤더 (아이콘 + 이름)
            const header = document.createElement('div');
            header.className = 'tree-node';
            header.dataset.path = actualPath;
            header.onclick = (e) => {
                e.stopPropagation(); // 부모 클릭 방지
                selectNode(actualPath);
                
                // 폴더면 열고 닫기 토글
                const childrenDiv = container.querySelector('.tree-children');
                const toggleIcon = header.querySelector('.toggle-icon i');
                if (childrenDiv) {
                    const isOpen = childrenDiv.classList.contains('open');
                    if (isOpen) {
                        childrenDiv.classList.remove('open');
                        toggleIcon.className = 'fas fa-chevron-right';
                    } else {
                        childrenDiv.classList.add('open');
                        toggleIcon.className = 'fas fa-chevron-down';
                    }
                }
            };

            // 아이콘 결정
            const isObject = data !== null && typeof data === 'object';
            const toggleIconHtml = isObject 
                ? `<span class
