<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Editor - Capstone</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            height: 100vh;
            background-color: #f4f6f9;
            padding-top: 70px; /* 헤더 공간 확보 */
            overflow: hidden; /* 스크롤은 내부 패널에서 처리 */
        }

        /* --- 헤더 스타일 (메인 페이지와 통일) --- */
        #header {
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            height: 70px;
            padding: 0 20px;
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
        }

        #header h1 {
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #71b7e6, #9b59b6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
        }

        #backBtn {
            padding: 8px 20px;
            border: none;
            border-radius: 0;
            background-color: #f8f9fa;
            color: #333;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #backBtn:hover {
            background-image: linear-gradient(135deg, #71b7e6, #9b59b6);
            color: white;
        }

        /* --- 메인 레이아웃 (좌우 분할) --- */
        #container {
            display: flex;
            width: 100%;
            height: calc(100vh - 70px);
            padding: 20px;
            gap: 20px;
        }

        /* 좌측 트리 뷰 */
        #tree-panel {
            width: 35%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-weight: 600;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #tree-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 14px;
        }

        /* 우측 에디터 */
        #editor-panel {
            width: 65%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor-area {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 현재 경로 표시 */
        .path-display {
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 4px;
            color: #333;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
        }

        /* JSON 텍스트 영역 */
        #json-editor {
            flex-grow: 1;
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace; /* 코드 폰트 */
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            background-color: #fafafa;
            color: #333;
        }
        #json-editor:focus {
            outline: 2px solid #71b7e6;
            background-color: #fff;
        }

        /* 버튼 그룹 */
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding-top: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: white;
            transition: opacity 0.3s;
        }
        .btn:hover { opacity: 0.9; }

        .btn-save { background: #28a745; } /* 초록색 */
        .btn-add { background: #17a2b8; }  /* 청록색 */
        .btn-delete { background: #dc3545; } /* 빨간색 */
        .btn-refresh { background: #6c757d; } /* 회색 */

        /* 트리 노드 스타일 */
        .tree-node {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .tree-node:hover {
            background-color: #f0f0f0;
        }
        .tree-node.selected {
            background-color: #e3f2fd;
            color: #007bff;
            font-weight: 500;
        }
        .tree-children {
            padding-left: 20px; /* 들여쓰기 */
            border-left: 1px solid #eee;
            display: none; /* 기본적으로 숨김 */
        }
        .tree-children.open {
            display: block;
        }
        .toggle-icon {
            display: inline-block;
            width: 20px;
            text-align: center;
            color: #999;
            margin-right: 5px;
        }
        .node-icon {
            margin-right: 5px;
            color: #f0ad4e; /* 폴더 색상 */
        }
        .node-icon.file {
            color: #5bc0de; /* 파일 색상 */
        }

    </style>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>

    <div id="header">
        <h1>데이터베이스 편집기</h1>
        <button id="backBtn" onclick="window.location.href='index.html'">메인으로 돌아가기</button>
    </div>

    <div id="container">
        <div id="tree-panel">
            <div class="panel-header">
                <span>DB 탐색기</span>
                <button class="btn btn-refresh" onclick="loadDatabase()" style="padding: 5px 10px; font-size:12px;">
                    <i class="fas fa-sync-alt"></i> 새로고침
                </button>
            </div>
            <div id="tree-content">
                <div style="text-align:center; margin-top:20px; color:#999;">데이터 로딩 중...</div>
            </div>
        </div>

        <div id="editor-panel">
            <div class="panel-header">데이터 수정</div>
            <div id="editor-area">
                <div>
                    <label style="font-size:12px; color:#777;">현재 경로:</label>
                    <div id="current-path" class="path-display">/</div>
                </div>
                
                <label style="font-size:12px; color:#777;">JSON 데이터 (직접 수정 가능):</label>
                <textarea id="json-editor" spellcheck="false"></textarea>

                <div class="action-buttons">
                    <button class="btn btn-add" onclick="addChildNode()">
                        <i class="fas fa-plus"></i> 자식 추가
                    </button>
                    <button class="btn btn-delete" onclick="deleteCurrentNode()">
                        <i class="fas fa-trash"></i> 현재 경로 삭제
                    </button>
                    <button class="btn btn-save" onclick="saveCurrentData()">
                        <i class="fas fa-save"></i> 변경사항 저장
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase 설정 (메인 페이지와 동일) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDr3DxG99ZNyW16Ui0SHCFHRNNC0NkpA_U",
            authDomain: "smartdoorlock-b4636.firebaseapp.com",
            databaseURL: "https://smartdoorlock-b4636-default-rtdb.firebaseio.com",
            projectId: "smartdoorlock-b4636",
            storageBucket: "smartdoorlock-b4636.firebasestorage.app",
            messagingSenderId: "104489505270",
            appId: "1:104489505270:web:eb385c8f9c5dfd512077d7",
            measurementId: "G-4TH9MB9WPM"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 전역 변수
        let fullData = null; // DB 전체 데이터
        let currentPath = "/"; // 현재 선택된 경로

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            loadDatabase();
        });

        // --- 1. DB 전체 데이터 로드 및 트리 생성 ---
        function loadDatabase() {
            const treeContent = document.getElementById('tree-content');
            treeContent.innerHTML = '<div style="text-align:center; margin-top:20px; color:#999;"><i class="fas fa-spinner fa-spin"></i> 데이터 불러오는 중...</div>';

            // 루트 경로(/)에서 모든 데이터를 가져옴
            database.ref('/').once('value').then(snapshot => {
                fullData = snapshot.val();
                renderTree();
                selectNode('/'); // 초기에는 루트 선택
            }).catch(err => {
                console.error(err);
                treeContent.innerHTML = '<div style="color:red; text-align:center; margin-top:20px;">데이터 로드 실패</div>';
                alert('데이터를 불러오지 못했습니다: ' + err.message);
            });
        }

        // --- 2. 트리 뷰 렌더링 (재귀 함수) ---
        function renderTree() {
            const treeContent = document.getElementById('tree-content');
            treeContent.innerHTML = '';

            const rootUl = document.createElement('div');
            // 루트 노드 생성
            rootUl.appendChild(createTreeNode('Root', fullData, ''));
            treeContent.appendChild(rootUl);
        }

        function createTreeNode(key, data, parentPath) {
            // 현재 경로 계산
            const currentPathStr = parentPath === '' ? key : (parentPath === '/' ? '/' + key : parentPath + '/' + key);
            const actualPath = parentPath === '' ? '/' : currentPathStr; // Root는 '/'로 취급

            const container = document.createElement('div');
            
            // 노드 헤더 (아이콘 + 이름)
            const header = document.createElement('div');
            header.className = 'tree-node';
            header.dataset.path = actualPath;
            header.onclick = (e) => {
                e.stopPropagation(); // 부모 클릭 방지
                selectNode(actualPath);
                
                // 폴더면 열고 닫기 토글
                const childrenDiv = container.querySelector('.tree-children');
                const toggleIcon = header.querySelector('.toggle-icon i');
                if (childrenDiv) {
                    const isOpen = childrenDiv.classList.contains('open');
                    if (isOpen) {
                        childrenDiv.classList.remove('open');
                        toggleIcon.className = 'fas fa-chevron-right';
                    } else {
                        childrenDiv.classList.add('open');
                        toggleIcon.className = 'fas fa-chevron-down';
                    }
                }
            };

            // 아이콘 결정
            const isObject = data !== null && typeof data === 'object';
            const toggleIconHtml = isObject 
                ? `<span class="toggle-icon"><i class="fas fa-chevron-right"></i></span>` 
                : `<span class="toggle-icon"></span>`; // 빈 공간
            
            const nodeIconClass = isObject ? 'fas fa-folder node-icon' : 'fas fa-file-alt node-icon file';
            
            header.innerHTML = `${toggleIconHtml}<i class="${nodeIconClass}"></i> ${key}`;
            container.appendChild(header);

            // 자식 노드 생성 (객체일 경우만)
            if (isObject) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'tree-children';
                
                // 객체의 키들을 순회하며 자식 생성
                Object.keys(data).forEach(childKey => {
                    const childNode = createTreeNode(childKey, data[childKey], actualPath);
                    childrenContainer.appendChild(childNode);
                });
                container.appendChild(childrenContainer);
            }

            return container;
        }

        // --- 3. 노드 선택 (에디터에 표시) ---
        function selectNode(path) {
            currentPath = path;
            
            // 1. 트리에서 하이라이트 처리
            document.querySelectorAll('.tree-node').forEach(el => el.classList.remove('selected'));
            const selectedEl = document.querySelector(`.tree-node[data-path="${path}"]`);
            if (selectedEl) selectedEl.classList.add('selected');

            // 2. 경로 표시 업데이트
            document.getElementById('current-path').textContent = path;

            // 3. 데이터 가져와서 에디터에 표시
            let targetData = fullData;
            if (path !== '/') {
                // 경로 문자열(/users/123)을 배열(['users', '123'])로 변환하여 탐색
                const keys = path.split('/').filter(k => k);
                for (let k of keys) {
                    if (targetData && targetData[k] !== undefined) {
                        targetData = targetData[k];
                    } else {
                        targetData = null; // 데이터가 없는 경우
                        break;
                    }
                }
            }

            // JSON 포맷팅하여 텍스트 영역에 넣기
            const editor = document.getElementById('json-editor');
            if (targetData !== undefined) {
                editor.value = JSON.stringify(targetData, null, 4); // 4칸 들여쓰기
            } else {
                editor.value = "null";
            }
        }

        // --- 4. 데이터 저장 (Update) ---
        function saveCurrentData() {
            const editor = document.getElementById('json-editor');
            let newData;

            try {
                newData = JSON.parse(editor.value);
            } catch (e) {
                alert("유효하지 않은 JSON 형식입니다.\n" + e.message);
                return;
            }

            if (!confirm(`정말로 '${currentPath}' 경로의 데이터를 수정하시겠습니까?`)) return;

            database.ref(currentPath).set(newData)
                .then(() => {
                    alert("성공적으로 저장되었습니다.");
                    loadDatabase(); // 트리 새로고침
                })
                .catch(err => {
                    alert("저장 실패: " + err.message);
                });
        }

        // --- 5. 현재 노드 삭제 (Delete) ---
        function deleteCurrentNode() {
            if (currentPath === '/') {
                alert("루트(Root)는 삭제할 수 없습니다.");
                return;
            }

            if (!confirm(`경고! 정말로 '${currentPath}' 경로와 그 하위 데이터를 모두 삭제하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`)) return;

            database.ref(currentPath).remove()
                .then(() => {
                    alert("삭제되었습니다.");
                    loadDatabase(); // 트리 새로고침
                })
                .catch(err => {
                    alert("삭제 실패: " + err.message);
                });
        }

        // --- 6. 자식 노드 추가 (Add) ---
        function addChildNode() {
            const keyName = prompt("추가할 키(Key) 이름을 입력하세요:", "new_key");
            if (!keyName) return;

            // 경로 문자열에 '/'가 포함되어 있으면 안됨
            if (keyName.includes('/') || keyName.includes('.') || keyName.includes('#') || keyName.includes('$') || keyName.includes('[')) {
                alert("키 이름에는 '.', '#', '$', '[', ']' 문자를 포함할 수 없습니다.");
                return;
            }

            const newPath = currentPath === '/' ? `/${keyName}` : `${currentPath}/${keyName}`;
            
            // 기본값으로 "value" 문자열 저장 (사용자가 나중에 에디터로 수정 가능)
            database.ref(newPath).set("initial_value")
                .then(() => {
                    // 트리를 새로고침하고, 새로 생성된 노드를 선택
                    // (비동기 처리를 위해 간단히 전체 리로드 후 선택 로직은 생략하거나 개선 가능)
                    loadDatabase(); 
                    alert(`'${keyName}'이(가) 추가되었습니다.`);
                })
                .catch(err => {
                    alert("추가 실패: " + err.message);
                });
        }

    </script>
</body>
</html>
