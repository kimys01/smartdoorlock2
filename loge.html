<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½ ë¡œê·¸ (Realtime DB)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter í°íŠ¸ ì‚¬ìš© -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* ê°„ë‹¨í•œ ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* JSë¡œ ì¶”ê°€ë  ë•Œ ê°„ë‹¨í•œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-once {
            0% { opacity: 0.5; transform: scale(0.98); }
            100% { opacity: 1; transform: scale(1); }
        }
        .animate-pulse-once {
            animation: pulse-once 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="container mx-auto max-w-3xl p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <header class="bg-gradient-to-r from-blue-600 to-blue-800 p-6">
                <h1 class="text-2xl font-bold text-white">ìŠ¤ë§ˆíŠ¸ ë„ì–´ë½ ì‹¤ì‹œê°„ ë¡œê·¸</h1>
                <p class="text-blue-100 text-sm mt-1">Realtime Databaseì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</p>
            </header>
            
            <div id="logs-container" class="p-6 space-y-4 min-h-[200px]">
                <!-- ë¡œë”© ìƒíƒœ -->
                <div id="loading-state" class="flex flex-col items-center justify-center text-gray-500 py-10">
                    <div class="spinner mb-4"></div>
                    <p>Firebaseì— ì—°ê²°í•˜ê³  ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- ë¹„ì–´ìˆëŠ” ìƒíƒœ -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center text-gray-500 py-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="font-medium">í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p class="text-sm">Realtime Database ì½˜ì†”ì—ì„œ 'artifacts/{appId}/public/data/doorlock_logs'ì— ë¡œê·¸ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”.</p>
                </div>
                
                <!-- ë¡œê·¸ ë¦¬ìŠ¤íŠ¸ê°€ ë Œë”ë§ë  ê³³ -->
                <ul id="log-list" class="space-y-3">
                    <!-- ë¡œê·¸ í•­ëª© ì˜ˆì‹œ (JSë¡œ ë™ì  ìƒì„±ë¨) -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase SDK ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase ëª¨ë“ˆ (Realtime Database) ---
        import { 
            getDatabase,
            ref,
            query,
            onValue
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const logsContainer = document.getElementById('logs-container');
        const logList = document.getElementById('log-list');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');

        // --- Firebase ì—°ê²° 1ë‹¨ê³„: ì„¤ì • ì •ë³´ ê°€ì ¸ì˜¤ê¸° ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // ğŸŒŸ [ì˜¤ë¥˜ ìˆ˜ì •]
        // Realtime Database ê²½ë¡œì—ëŠ” '.', '#', '$', '[', ']'ì™€ ê°™ì€ íŠ¹ìˆ˜ ë¬¸ìê°€ í¬í•¨ë  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        // __app_id (íŒŒì¼ ì´ë¦„)ì— í¬í•¨ëœ '.'ë¥¼ '_'ë¡œ ëŒ€ì²´í•˜ì—¬ ìœ íš¨í•œ ê²½ë¡œë¥¼ ë§Œë“­ë‹ˆë‹¤.
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const appId = rawAppId.replace(/[\.#$\[\]]/g, '_'); 

        let db;
        let auth;
        let userId = null;

        try {
            // --- Firebase ì—°ê²° 2ë‹¨ê³„: ì•± ì´ˆê¸°í™” ---
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app); 
            auth = getAuth(app);

            // --- Firebase ì—°ê²° 3ë‹¨ê³„: ì¸ì¦ ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Authenticated User ID:", userId);
                    // ì¸ì¦ì´ ì™„ë£Œë˜ë©´ ë¡œê·¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                    setupLogListener();
                } else {
                    console.log("No user signed in, attempting auth...");
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Authentication error:", authError);
                        loadingState.innerHTML = '<p class="text-red-500">ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
                    }
                }
            });

        } catch (e) {
            console.error("Firebase initialization error:", e);
            loadingState.innerHTML = '<p class="text-red-500">Firebase ì´ˆê¸°í™” ì˜¤ë¥˜. F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
        }

        /**
         * 'YYYY-MM-DD HH:MM:SS' í˜•ì‹ì˜ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
         * @param {string} timestampString - '2025-10-27 11:16:47'
         * @returns {Date}
         */
        function parseTimestamp(timestampString) {
            if (!timestampString || typeof timestampString !== 'string') {
                return new Date(0); // 1970ë…„ 1ì›” 1ì¼
            }
            try {
                // 'YYYY-MM-DD HH:MM:SS' í˜•ì‹ì„ 'YYYY-MM-DDTHH:MM:SS' (ISO 8601 í˜¸í™˜)
                const formattedString = timestampString.replace(' ', 'T');
                const date = new Date(formattedString);
                
                // ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œ(Invalid Date)ì¸ì§€ í™•ì¸
                if (isNaN(date.getTime())) {
                    // YYYY, MM, DD, HH, MM, SSë¥¼ ìˆ˜ë™ìœ¼ë¡œ íŒŒì‹±
                    const parts = timestampString.match(/(\d{4})-(\d{2})-(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
                    if (parts) {
                        // JavaScriptì˜ Date ìƒì„±ìëŠ” ì›”(month)ì„ 0ë¶€í„° 11ê¹Œì§€ë¡œ ì¸ì‹í•˜ë¯€ë¡œ 1ì„ ë¹¼ì¤ë‹ˆë‹¤.
                        return new Date(parts[1], parts[2] - 1, parts[3], parts[4], parts[5], parts[6]);
                    }
                    return new Date(0);
                }
                return date;
            } catch (e) {
                console.warn(`Could not parse timestamp: ${timestampString}`, e);
                return new Date(0);
            }
        }

        /**
         * ë¡œê·¸ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì‹œí•˜ëŠ” ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         */
        function setupLogListener() {
            // --- Firebase ì—°ê²° 4ë‹¨ê³„: ë°ì´í„° ê²½ë¡œ ì„¤ì • ---
            // ğŸŒŸ ìº”ë²„ìŠ¤ Firebase ë³´ì•ˆ ê·œì¹™ì— ë§ëŠ” ê³µìš© ê²½ë¡œë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.
            const logRefPath = `artifacts/${appId}/public/data/doorlock_logs`;
            console.log(`Listening for logs at: ${logRefPath}`);
            
            const logsDbRef = ref(db, logRefPath);
            const q = query(logsDbRef);

            // --- Firebase ì—°ê²° 5ë‹¨ê³„: ì‹¤ì‹œê°„ ë°ì´í„° ìˆ˜ì‹  ---
            onValue(q, (snapshot) => {
                loadingState.classList.add('hidden'); // ë¡œë”© ìˆ¨ê¸°ê¸°
                
                const logsData = snapshot.val(); 
                const logs = [];

                if (logsData) {
                    Object.keys(logsData).forEach(key => {
                        logs.push({ id: key, ...logsData[key] });
                    });
                }
                
                // --- ğŸŒŸ Timestamp ì •ë ¬ ë³€ê²½ (ë¬¸ìì—´ -> Date ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ) ---
                logs.sort((a, b) => {
                    const timeA = parseTimestamp(a.timestamp).getTime();
                    const timeB = parseTimestamp(b.timestamp).getTime();
                    return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ (ìµœì‹  í•­ëª©ì´ ìœ„ë¡œ)
                });

                renderLogs(logs);

            }, (error) => {
                console.error("Error listening to logs:", error);
                loadingState.innerHTML = `<p class="text-red-500">ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>`;
            });
        }

        /**
         * ë¡œê·¸ ë°°ì—´ì„ ë°›ì•„ HTMLë¡œ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array} logs - ë¡œê·¸ ë°ì´í„° ë°°ì—´
         */
        function renderLogs(logs) {
            logList.innerHTML = ''; // ê¸°ì¡´ ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”

            if (logs.length === 0) {
                emptyState.classList.remove('hidden'); // ë¡œê·¸ ì—†ìŒ í‘œì‹œ
            } else {
                emptyState.classList.add('hidden'); // ë¡œê·¸ ì—†ìŒ ìˆ¨ê¸°ê¸°
            }

            logs.forEach(log => {
                const li = document.createElement('li');
                li.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center animate-pulse-once'; 
                
                const methodText = getMethodText(log.method);
                const iconSvg = getMethodIcon(log.method);
                
                // --- ğŸŒŸ Timestamp ì²˜ë¦¬ ë³€ê²½ (ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ í‘œì‹œ) ---
                let timeString = 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
                if (log.timestamp && typeof log.timestamp === 'string') {
                    timeString = log.timestamp; // ë¬¸ìì—´ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                }
                
                const statusText = log.status === 'Unlocked' ? 'ì ê¸ˆ í•´ì œ' : 'ì ê¹€';
                const statusColorClass = log.status === 'Unlocked' 
                    ? 'text-green-600 bg-green-100' 
                    : 'text-red-600 bg-red-100';

                li.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 flex items-center justify-center rounded-full ${iconSvg.bgColor}">
                            ${iconSvg.svg}
                        </div>
                        <div>
                            <p class="font-semibold text-gray-800">${methodText}</p>
                            <p class="text-sm text-gray-500">${timeString}</p>
                        </div>
                    </div>
                    <span class="text-sm font-medium ${statusColorClass} px-3 py-1 rounded-full">
                        ${statusText}
                    </span>
                `;
                logList.appendChild(li);
            });
        }

        /**
         * ë¡œê·¸ ë©”ì†Œë“œ(method) ë¬¸ìì—´ì— ë”°ë¼ ì ì ˆí•œ í•œê¸€ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} method - 'keypad', 'rfid', 'app', 'gps' ë“±
         */
        function getMethodText(method) {
            switch(method) {
                case 'keypad': return 'í‚¤íŒ¨ë“œ';
                case 'rfid': return 'RFID';
                case 'app': return 'ì• í”Œë¦¬ì¼€ì´ì…˜';
                case 'gps': return 'GPS ìë™ í•´ì œ';
                default: return 'ì•Œ ìˆ˜ ì—†ìŒ';
            }
        }

        /**
         * ë¡œê·¸ ë©”ì†Œë“œì— ë”°ë¼ ì•„ì´ì½˜ SVGì™€ ë°°ê²½ìƒ‰ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
         * @param {string} method - 'keypad', 'rfid', 'app', 'gps' ë“±
         */
        function getMethodIcon(method) {
            const icons = {
                keypad: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                            </svg>`,
                    bgColor: 'bg-blue-100'
                },
                rfid: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m4 0h1M4 4h16v5H4V4z" />
                            </svg>`,
                    bgColor: 'bg-indigo-100'
                },
                app: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                            </svg>`,
                    bgColor: 'bg-green-100'
                },
                gps: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>`,
                    bgColor: 'bg-purple-100'
                },
                default: {
                    svg: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>`,
                    bgColor: 'bg-gray-100'
                }
            };
            return icons[method] || icons.default;
        }

    </script>
</body>
</html>

